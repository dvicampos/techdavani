{% extends "layout.html" %}

{% block content %}

<h1>Crear Empresa / Página</h1>
<form method="POST" enctype="multipart/form-data">
    <!-- Campos básicos -->
    <div class="mb-3">
        <label class="form-label">Nombre de la empresa</label>
        <input type="text" name="business_name" class="form-control" required />
    </div>

    <div class="mb-3">
        <label class="form-label">Descripción</label>
        <textarea name="description" rows="3" class="form-control" required></textarea>
    </div>

    <div class="mb-3">
        <label for="category" class="form-label">Categoría</label>
        <select name="category" id="category" class="form-select" required>
            <option value="" selected disabled>Selecciona una categoría</option>

            <!-- Alimentos y Bebidas -->
            <option value="Restaurante">Restaurante</option>
            <option value="Cafetería">Cafetería</option>
            <option value="Bar">Bar</option>
            <option value="Panadería">Panadería</option>
            <option value="Comida rápida">Comida rápida</option>
            <option value="Pastelería">Pastelería</option>

            <!-- Comercio y Tiendas -->
            <option value="Supermercado">Supermercado</option>
            <option value="Tienda de ropa">Tienda de ropa</option>
            <option value="Zapatería">Zapatería</option>
            <option value="Ferretería">Ferretería</option>
            <option value="Papelería">Papelería</option>
            <option value="Tienda de regalos">Tienda de regalos</option>
            <option value="Floristería">Floristería</option>
            <option value="Joyería">Joyería</option>
            <option value="Tienda de mascotas">Tienda de mascotas</option>
            <option value="Librería">Librería</option>
            <option value="Tienda de electrónica">Tienda de electrónica</option>

            <!-- Salud y Belleza -->
            <option value="Farmacia">Farmacia</option>
            <option value="Consultorio médico">Consultorio médico</option>
            <option value="Dentista">Dentista</option>
            <option value="Salón de belleza">Salón de belleza</option>
            <option value="Peluquería">Peluquería</option>
            <option value="Spa">Spa</option>
            <option value="Veterinaria">Veterinaria</option>

            <!-- Servicios -->
            <option value="Taller mecánico">Taller mecánico</option>
            <option value="Lavandería">Lavandería</option>
            <option value="Inmobiliaria">Inmobiliaria</option>
            <option value="Agencia de viajes">Agencia de viajes</option>
            <option value="Servicio de transporte">Servicio de transporte</option>
            <option value="Mensajería">Mensajería</option>
            <option value="Asesoría legal">Asesoría legal</option>
            <option value="Contabilidad">Contabilidad</option>
            <option value="Diseño gráfico">Diseño gráfico</option>
            <option value="Estudio fotográfico">Estudio fotográfico</option>

            <!-- Educación y Tecnología -->
            <option value="Centro educativo">Centro educativo</option>
            <option value="Escuela de idiomas">Escuela de idiomas</option>
            <option value="Clases particulares">Clases particulares</option>
            <option value="Servicios de TI">Servicios de TI</option>
            <option value="Desarrollo web">Desarrollo web</option>
            <option value="Marketing digital">Marketing digital</option>
            <option value="Soporte técnico">Soporte técnico</option>

            <!-- Ocio y Entretenimiento -->
            <option value="Cine">Cine</option>
            <option value="Gimnasio">Gimnasio</option>
            <option value="Centro deportivo">Centro deportivo</option>
            <option value="Sala de eventos">Sala de eventos</option>
            <option value="Parque de diversiones">Parque de diversiones</option>
            <option value="Streaming o medios">Streaming o medios</option>
            <option value="Gaming o eSports">Gaming o eSports</option>

            <!-- Otros -->
            <option value="ONG / Asociación">ONG / Asociación</option>
            <option value="Freelancer / Independiente">Freelancer / Independiente</option>
            <option value="Otro">Otro</option>
        </select>
    </div>


    <div class="mb-3">
        <label class="form-label">Eslogan</label>
        <input type="text" name="slogan" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Fecha de fundación</label>
        <input type="date" name="founding_date" class="form-control" />
    </div>

    <!-- Contacto y ubicación -->
    <div class="mb-3">
        <label class="form-label">Teléfono</label>
        <input type="text" name="phone" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">WhatsApp</label>
        <input type="text" name="whatsapp" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Correo electrónico</label>
        <input type="email" name="email" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Sitio web</label>
        <input type="url" name="website" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Dirección</label>
        <input type="text" name="address" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Código postal</label>
        <input type="text" name="postal_code" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Ciudad</label>
        <input type="text" name="city" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Estado</label>
        <select name="state" class="form-control" required>
            <option value="">Selecciona un estado</option>
            {% set estados = [
            'Aguascalientes', 'Baja California', 'Baja California Sur', 'Campeche',
            'Chiapas', 'Chihuahua', 'Ciudad de México', 'Coahuila', 'Colima', 'Durango',
            'Estado de México', 'Guanajuato', 'Guerrero', 'Hidalgo', 'Jalisco', 'Michoacán',
            'Morelos', 'Nayarit', 'Nuevo León', 'Oaxaca', 'Puebla', 'Querétaro', 'Quintana Roo',
            'San Luis Potosí', 'Sinaloa', 'Sonora', 'Tabasco', 'Tamaulipas', 'Tlaxcala',
            'Veracruz', 'Yucatán', 'Zacatecas'
            ] %}
            {% for estado in estados %}
            <option>{{ estado }}</option>
            {% endfor %}
        </select>
    </div>

        <!-- Google Maps (URL o coordenadas) -->
        <div class="mb-3">
            <label class="form-label">Dirección (opcional)</label>
            <input type="text" id="address" name="address" class="form-control"
                    value="{{ (data.address if data else '') or '' }}" placeholder="Calle, colonia, ciudad…">
            <small class="text-muted">También puedes escribir y luego afinar con el mapa.</small>
        </div>

        <div class="mb-3">
        <label class="form-label d-flex justify-content-between align-items-center">
            Ubicación en el mapa
            <small class="text-muted">Haz clic para colocar/ajustar el pin</small>
        </label>
        <div id="map" style="height: 360px; border-radius: 12px; overflow: hidden;"></div>
        </div>

        <input type="hidden" id="lat" name="lat" value="{{ (data.lat if data else '') or '' }}">
        <input type="hidden" id="lng" name="lng" value="{{ (data.lng if data else '') or '' }}">

    <!-- Redes sociales -->
    <div class="mb-3">
        <label class="form-label">Facebook</label>
        <input type="url" name="facebook" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Instagram</label>
        <input type="url" name="instagram" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">TikTok</label>
        <input type="url" name="tiktok" class="form-control" />
    </div>

    <!-- Operación y servicios -->
    <div class="mb-3">
        <label class="form-label">Horario de operación</label>
        <input type="text" name="operating_hours" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Servicios (separados por coma o descripción)</label>
        <textarea name="services" rows="3" class="form-control"></textarea>
    </div>

    <div class="mb-3">
        <label class="form-label">Métodos de pago</label>
        <input type="text" name="payment_methods" class="form-control" />
    </div>

    <div class="mb-3 form-check">
        <input type="checkbox" name="delivery_available" class="form-check-input" id="delivery_available" />
        <label for="delivery_available" class="form-check-label">¿Cuenta con servicio a domicilio?</label>
    </div>

    <div class="mb-3">
        <label class="form-label">Imagen principal</label>
        <input type="file" name="image" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">Color principal</label><br>
        <input type="color" name="color" class="form-control-color">
    </div>

    <button class="btn btn-primary">Crear empresa</button>
</form>
<div class="mt-4 text-center">
    <a href="{{ url_for('dashboard')}}" class="btn btn-outline-dark">
        <i class="bi bi-arrow-left-circle"></i> Regresar
    </a>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Valores iniciales
  const latInput = document.getElementById('lat');
  const lngInput = document.getElementById('lng');
  const addrInput = document.getElementById('address');

  // Centro por defecto (México)
  const defaultLat = latInput.value ? parseFloat(latInput.value) : 23.6345;
  const defaultLng = lngInput.value ? parseFloat(lngInput.value) : -102.5528;
  const defaultZoom = latInput.value && lngInput.value ? 14 : 5;

  // Crear mapa
  const map = L.map('map').setView([defaultLat, defaultLng], defaultZoom);

  // Capa de tiles (usa OSM pública; para producción pesada, usa un proveedor dedicado)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Marcador (si hay coordenadas guardadas)
  let marker = null;
  function placeMarker(lat, lng) {
    if (!marker) {
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', function(e) {
        const { lat, lng } = e.target.getLatLng();
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
      });
    } else {
      marker.setLatLng([lat, lng]);
    }
    latInput.value = lat.toFixed(6);
    lngInput.value = lng.toFixed(6);
  }

  if (latInput.value && lngInput.value) {
    placeMarker(parseFloat(latInput.value), parseFloat(lngInput.value));
  }

  // Click en mapa → colocar/ajustar pin
  map.on('click', function(e) {
    placeMarker(e.latlng.lat, e.latlng.lng);
  });

  // Geocoder (Nominatim)
  const geocoder = L.Control.geocoder({
    defaultMarkGeocode: false
  })
  .on('markgeocode', function(result) {
    const center = result.geocode.center;
    map.setView(center, 16);
    placeMarker(center.lat, center.lng);
    // llena address si viene algo útil
    if (result.geocode && result.geocode.name) {
      addrInput.value = result.geocode.name;
    }
  })
  .addTo(map);

  // Si el usuario escribe dirección y presiona Enter, buscarla
  addrInput && addrInput.addEventListener('keydown', function(e){
    if (e.key === 'Enter') {
      e.preventDefault();
      if (addrInput.value.trim().length > 0 && geocoder && geocoder.options.geocoder) {
        geocoder.options.geocoder.geocode(addrInput.value, function(results) {
          if (results && results.length) {
            const r = results[0];
            map.setView(r.center, 16);
            placeMarker(r.center.lat, r.center.lng);
          }
        });
      }
    }
  });
});
</script>
{% endblock %}