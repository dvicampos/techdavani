{% extends "layout.html" %}
{% block title %}Dashboard · Global PYMES{% endblock %}

{% block content %}
{# ==== Defaults seguros ==== #}
{% set PAGE = page|default(None) %}
{% set S = stats|default({}) %}
{% set R = recientes|default({'posts':[], 'avisos':[], 'productos':[]}) %}

{# ====== NUEVOS (si existen) ====== #}
{% set ANA = analytics|default({}) %}
{% set DV  = daily_views|default([]) %}
{% set LEADS_TOTAL = leads_total|default(0) %}
{% set LEADS_7D    = leads_7d|default(0) %}
{% set APPT_TOTAL  = appt_total|default(0) %}
{% set APPT_PEND   = appt_pending|default(0) %}
{% set PROMOS_ACT  = promos_active|default(0) %}

<style>
  /* ===== Theme Blue + Green (Create) ===== */
  :root{
    --page-bg: #070b18;
    --shell-bg: rgba(10,16,34,.52);
    --panel: rgba(10,16,34,.45);
    --panel-solid: #0b1226;
    --ink: #e8eefc;
    --muted: rgba(232,238,252,.58);

    --blue: #2563eb;
    --blue-2: #60a5fa;
    --blue-soft: rgba(37,99,235,.16);

    --green: #22c55e;
    --green-2: #86efac;
    --green-soft: rgba(34,197,94,.16);

    --stroke: rgba(148,163,184,.16);
    --radius-sm: 14px;
    --radius-md: 18px;
    --shadow: 0 18px 44px rgba(0,0,0,.45);

    --gradient-header:
      radial-gradient(circle at 12% 18%, rgba(96,165,250,.25), rgba(7,11,24,0) 42%),
      radial-gradient(circle at 85% -10%, rgba(34,197,94,.15), rgba(7,11,24,0) 42%),
      linear-gradient(135deg, #0b1226 0%, #0e1a3b 52%, #0b1226 100%);
  }

  .dash-shell{
    max-width: 1220px;
    margin: 1.4rem auto 3rem;
    background:
      radial-gradient(circle at 18% -12%, rgba(37,99,235,.15), rgba(7,11,24,0) 40%),
      rgba(9,12,22,.7);
    border: 1px solid rgba(148,163,184,.15);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow);
    overflow: hidden;
    backdrop-filter: blur(24px);
  }

  /* ===== Nav/Topbar ===== */
  .dash-nav{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    align-items:center;
    padding: 1rem 1.2rem;
    border-bottom: 1px solid rgba(148,163,184,.12);
    background: rgba(7,11,24,.65);
  }
  .nav-left{display:flex;align-items:center;gap:.75rem;min-width: 250px;}
  .nav-pill{
    background: rgba(37,99,235,.15);
    border: 1px solid rgba(96,165,250,.25);
    color: #dbeafe;
    padding: .35rem .7rem;
    border-radius: 8px;
    font-size: .7rem;
    font-weight: 700;
    letter-spacing: .05em;
    text-transform: uppercase;
  }
  .nav-title{display:flex;flex-direction:column;line-height:1.2;}
  .nav-title strong{color:#fff;font-size:.95rem;}
  .nav-title small{color:rgba(232,238,252,.6);font-size:.7rem;}

  .nav-actions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;}
  .btnx{
    display:inline-flex;
    align-items:center;
    gap:.45rem;
    padding: .45rem .85rem;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,.18);
    background: rgba(15,23,42,.4);
    color: #fff;
    text-decoration:none;
    font-size: .75rem;
    font-weight: 600;
    transition: all .15s ease;
  }
  .btnx:hover{transform: translateY(-2px); filter:brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2);}
  .btnx-blue{background: rgba(37,99,235,.2); border-color: rgba(96,165,250,.3); color: #bfdbfe;}
  .btnx-ghost{background: rgba(15,23,42,.3);}

  .nav-search{
    display:flex; align-items:center; gap:.5rem;
    background: rgba(15,23,42,.6);
    border:1px solid rgba(148,163,184,.2);
    border-radius: 8px;
    padding:.45rem .85rem;
    flex-grow: 1;
    max-width: 400px;
    transition: border-color 0.2s;
  }
  .nav-search:focus-within { border-color: var(--blue-2); }
  .nav-search input{
    background:transparent;border:0;outline:0;color:#fff;width:100%;font-size:.8rem;
  }
  .nav-search input::placeholder{color:rgba(232,238,252,.4);}

  /* ===== Header (welcome) ===== */
  .dash-header{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    align-items:center;
    background: var(--gradient-header);
    padding: 1.2rem;
    border-bottom: 1px solid rgba(148,163,184,.08);
  }
  .dash-title{display:flex;flex-direction:column;gap:.25rem;}
  .dash-title h1{font-size:1.3rem;margin:0;color:#fff;font-weight:800; font-family: 'Space Grotesk', sans-serif;}
  .dash-title small{color:rgba(232,238,252,.7);font-size:.75rem;}

  /* ===== Body ===== */
  .dash-body{padding: 1.2rem;}

  /* ===== KPIs ===== */
  .kpi-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px,1fr));
    gap:1rem;
  }
  .kpi{
    background: radial-gradient(circle at 12% 18%, rgba(96,165,250,.08), rgba(15,23,42,0) 52%), rgba(17,24,39,.4);
    border:1px solid rgba(148,163,184,.15);
    border-radius: var(--radius-sm);
    padding: 1rem;
    text-decoration:none;
    display:block;
    position:relative;
    overflow:hidden;
    transition: all 0.2s ease;
  }
  .kpi::after{
    content:"";
    position:absolute; inset:-20px -20px auto auto;
    width: 100px; height: 100px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.05), rgba(15, 23, 42, 0) 70%);
    transform: rotate(18deg);
  }
  .kpi-badge{
    background: rgba(37,99,235,.2);
    border: 1px solid rgba(37,99,235,.4);
    color:#93c5fd;
    font-size:.65rem;
    padding:.15rem .5rem;
    border-radius: 6px;
    font-weight:700;
    display:inline-block;
    margin-bottom:.5rem;
  }
  .kpi-value{font-size:1.6rem;font-weight:800;color:#fff;line-height:1.1; font-family: 'Space Grotesk', sans-serif;}
  .kpi-label{font-size:.75rem;color:rgba(232,238,252,.6); margin-top: 2px;}
  .kpi:hover{transform: translateY(-3px); border-color: rgba(96,165,250,.4); box-shadow: 0 8px 20px rgba(0,0,0,0.2);}

  /* ===== Section title ===== */
  .section-title{
    font-size:.8rem;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:rgba(232,238,252,.5);
    margin:1.8rem 0 1rem;
    font-weight:700;
    display:flex;
    align-items:center;
    gap:.6rem;
  }
  .section-title:before{
    content:"";
    width:8px;height:8px;border-radius:50%;
    background: var(--blue-2);
    box-shadow: 0 0 8px var(--blue-2);
  }

  /* ===== Actions ===== */
  .actions-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    gap:1rem;
  }
  .action-card{
    background: rgba(17,24,39,.4);
    border:1px solid rgba(148,163,184,.15);
    border-radius: var(--radius-sm);
    padding: 1rem;
    display:flex;
    gap:1rem;
    align-items:flex-start;
    transition: all 0.2s ease;
  }
  .action-card:hover { background: rgba(30,41,59,.4); border-color: rgba(148,163,184,.3); }
  .action-icon{
    width:45px;height:45px;border-radius: 12px;
    display:grid;place-items:center;
    background: linear-gradient(135deg, rgba(37,99,235,.2), rgba(30,58,138,.4));
    border: 1px solid rgba(96,165,250,.2);
    color: var(--blue-2);
    font-size:1.2rem;
    flex-shrink: 0;
  }
  .action-icon.create-icon {
    background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(20,83,45,.4));
    border-color: rgba(74,222,128,.2);
    color: var(--green-2);
  }
  .action-body { flex-grow: 1; }
  .action-body h5{font-size:.9rem;margin:0 0 .25rem;color:#fff;font-weight:700;}
  .action-body p{font-size:.75rem;color:rgba(232,238,252,.6);margin:0 0 .7rem; line-height: 1.3;}
  .action-body .btn{
    padding:.35rem .8rem;
    font-size:.7rem;
    border-radius: 6px;
    font-weight: 600;
    transition: all 0.2s ease;
  }
  .btn-primary{background: var(--blue); border:0; color: #fff;}
  .btn-primary:hover{background: #1d4ed8; color: #fff;}
  
  .btn-secondary{background: rgba(148,163,184,.15); border: 1px solid rgba(148,163,184,.2); color:#e2e8f0;}
  .btn-secondary:hover{background: rgba(148,163,184,.25); color: #fff;}

  /* Create buttons -> green emphasis */
  .btn-create{background: rgba(34,197,94,.15) !important; color:#86efac !important; border:1px solid rgba(34,197,94,.3) !important;}
  .btn-create:hover{background: rgba(34,197,94,.3) !important; color:#fff !important;}

  /* ===== Modules strip (SaaS) ===== */
  .modules-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
    gap:1rem;
  }
  .module{
    background: rgba(17,24,39,.3);
    border:1px solid rgba(148,163,184,.15);
    border-radius: var(--radius-sm);
    padding: 1rem;
    transition: all 0.2s ease;
  }
  .module:hover { border-color: rgba(96,165,250,.3); background: rgba(30,41,59,.4); }
  .module h6{margin:0;color:#fff;font-size:.85rem;font-weight:700; display: flex; align-items: center; gap: 0.5rem;}
  .module .sub{margin:.4rem 0 .8rem;color:rgba(232,238,252,.6);font-size:.75rem; line-height: 1.3;}
  .module .meta{display:flex;gap:.5rem;flex-wrap:wrap;margin:.5rem 0 1rem;}
  
  .pill{
    display:inline-flex;align-items:center;gap:.35rem;
    padding:.25rem .6rem;
    border-radius: 6px;
    border:1px solid rgba(148,163,184,.2);
    background: rgba(15,23,42,.4);
    color:rgba(232,238,252,.8);
    font-size:.7rem;
    font-weight:600;
  }
  .pill b{color:#fff;}
  .module a{color:var(--blue-2);text-decoration:none; font-size: 0.8rem; font-weight: 600;}
  .module a:hover{text-decoration:underline; color: #fff;}

  /* ===== Recientes ===== */
  .recent-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
    gap:1rem;
  }
  .panel{
    background: rgba(17,24,39,.3);
    border:1px solid rgba(148,163,184,.15);
    border-radius: var(--radius-sm);
    padding: 1rem;
  }
  .panel h5{font-size:.85rem;margin:0 0 .8rem;color:#fff;font-weight:700; display: flex; align-items: center; gap: 0.5rem;}
  .list-compact{list-style:none;margin:0;padding:0;}
  .list-compact li{
    padding:.6rem 0;
    border-bottom:1px solid rgba(148,163,184,.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }
  .list-compact li:last-child{border-bottom:0; padding-bottom: 0;}
  .list-compact li:first-child{padding-top: 0;}
  .item-title{font-size:.8rem;font-weight:600;color:#e2e8f0;text-decoration:none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
  .item-title:hover{color: var(--blue-2);}
  .item-meta{font-size:.7rem;color:rgba(232,238,252,.5); flex-shrink: 0;}
  
  .empty{
    background: rgba(15,23,42,.4);
    border:1px dashed rgba(148,163,184,.2);
    border-radius: 8px;
    padding: 1.5rem 1rem;
    text-align:center;
    font-size:.75rem;
    color:rgba(232,238,252,.5);
  }

  @media (max-width: 900px){
    .dash-nav { flex-wrap: wrap; }
    .nav-search { order: 3; max-width: 100%; margin-top: 0.5rem; }
  }
  @media (max-width: 768px){
    .dash-shell{margin:.5rem .5rem 2.5rem; border-radius: 12px;}
    .dash-header{flex-direction:column;align-items:flex-start;}
    .nav-actions{width:100%;justify-content:flex-start}
  }
</style>

<div class="dash-shell">

  <div class="dash-nav">
    <div class="nav-left">
      <div class="nav-pill"><i class="bi bi-speedometer2 me-1"></i> Dashboard</div>
      <div class="nav-title">
        <strong>{{ PAGE.get('business_name','Tu sitio') if PAGE else 'Tu sitio' }}</strong>
        <small>Slug: {{ PAGE.get('slug','—') if PAGE else '—' }} · Plan: {{ (PAGE.get('plan') if PAGE else '—') }}</small>
      </div>
    </div>

    <form class="nav-search" method="get" action="{{ url_for('dashboard_slug', slug=PAGE.slug) if PAGE else url_for('dashboard') }}">
      <i class="bi bi-search text-muted"></i>
      <input name="q" type="search" placeholder="Buscar publicaciones, avisos, productos…">
    </form>

    <div class="nav-actions">
      {% if PAGE and PAGE.get('slug') %}
        <a class="btnx btnx-blue" target="_blank" href="{{ url_for('negocio_por_slug', slug=PAGE.slug) }}">
          <i class="bi bi-box-arrow-up-right me-1"></i> Ver público
        </a>
      {% endif %}
      <a class="btnx btnx-ghost" href="{{ url_for('billing_portal') }}">
        <i class="bi bi-credit-card me-1"></i> Pagos / Plan
      </a>
      {% if current_user.role == 'admin' and PAGE and PAGE.get('slug') %}
        <a class="btnx btnx-ghost" href="{{ url_for('manage_page_slug', slug=PAGE.slug) }}">
          <i class="bi bi-sliders me-1"></i> Editar sitio
        </a>
      {% endif %}
      <a class="btnx btnx-ghost" href="{{ url_for('sites') }}">
        <i class="bi bi-arrow-left-right me-1"></i> Cambiar sitio
      </a>
    </div>
  </div>

  <div class="dash-header">
    <div class="dash-title">
      <h1>Hola, {{ current_user.nombre }}</h1>
      {% if now is defined %}
        <small><i class="bi bi-calendar-event"></i> Hoy es {{ now().strftime('%d/%m/%Y') }} · Gestionando: {{ PAGE.get('business_name','Tu sitio') if PAGE else 'Tu sitio' }}</small>
      {% endif %}
    </div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;">
      <span class="pill"><i class="bi bi-lightning-charge text-warning"></i> Leads 7d: <b>{{ LEADS_7D }}</b></span>
      <span class="pill"><i class="bi bi-calendar-check text-info"></i> Pendientes: <b>{{ APPT_PEND }}</b></span>
      <span class="pill"><i class="bi bi-tags text-success"></i> Promos: <b>{{ PROMOS_ACT }}</b></span>
    </div>
  </div>

  <div class="dash-body">

    <div class="kpi-row">
      {% set kpis = [
        {'label':'Publicaciones','value': S.get('posts', 0),'href':url_for('list_post')},
        {'label':'Avisos','value': S.get('avisos', 0),'href':url_for('list_avisos')},
        {'label':'Productos','value': S.get('productos', 0),'href':url_for('list_productos')},
        {'label':'Reseñas','value': S.get('resenas', 0),'href':url_for('admin_reseñas')},
        {'label':'Leads','value': LEADS_TOTAL,'href':url_for('admin_leads')},
        {'label':'Reservas','value': APPT_TOTAL,'href':url_for('admin_appointments')},
        {'label':'Promos','value': PROMOS_ACT,'href':url_for('admin_promos')}
      ] %}
      {% if current_user.role == 'admin' %}
        {% set kpis = kpis + [{'label':'Usuarios','value': S.get('usuarios', 0),'href':url_for('manage_users')}] %}
      {% endif %}

      {% for k in kpis %}
        <a href="{{ k.href }}" class="kpi">
          <div class="kpi-badge"><i class="bi bi-bar-chart-fill me-1"></i>KPI</div>
          <div class="kpi-value">{{ k.value }}</div>
          <div class="kpi-label">{{ k.label }}</div>
        </a>
      {% endfor %}
    </div>

    <div class="section-title">Módulos Inteligentes</div>
    <div class="modules-row">
      <div class="module">
        <h6><i class="bi bi-lightning-charge-fill text-warning"></i> Leads / Cotizaciones</h6>
        <div class="sub">Cotizaciones guardadas desde tu botón “Cotizar”.</div>
        <div class="meta">
          <span class="pill">Total <b>{{ LEADS_TOTAL }}</b></span>
          <span class="pill">Últimos 7d <b class="text-warning">{{ LEADS_7D }}</b></span>
        </div>
        <a href="{{ url_for('admin_leads') }}">Ver bandeja de leads <i class="bi bi-arrow-right ms-1"></i></a>
      </div>

      <div class="module">
        <h6><i class="bi bi-calendar2-check-fill text-info"></i> Reservas y Agenda</h6>
        <div class="sub">Solicitudes de citas y aprobaciones.</div>
        <div class="meta">
          <span class="pill border-info">Pendientes <b class="text-info">{{ APPT_PEND }}</b></span>
          <span class="pill">Total <b>{{ APPT_TOTAL }}</b></span>
        </div>
        <a href="{{ url_for('admin_appointments') }}">Ir al calendario <i class="bi bi-arrow-right ms-1"></i></a>
      </div>

      <div class="module">
        <h6><i class="bi bi-tags-fill text-success"></i> Ofertas y Promos</h6>
        <div class="sub">Promociones visibles en tu página pública.</div>
        <div class="meta">
          <span class="pill border-success">Activas <b class="text-success">{{ PROMOS_ACT }}</b></span>
        </div>
        <a href="{{ url_for('admin_promos') }}">Gestionar promos <i class="bi bi-arrow-right ms-1"></i></a>
      </div>

      <div class="module">
        <h6><i class="bi bi-graph-up-arrow text-primary"></i> Analytics (7 días)</h6>
        <div class="sub">Rendimiento e interacción en tu sitio web.</div>
        <div class="meta">
          <span class="pill"><i class="bi bi-eye"></i> <b>{{ ANA.get('view', 0) }}</b></span>
          <span class="pill"><i class="bi bi-whatsapp text-success"></i> <b>{{ ANA.get('click_whatsapp_fab', 0) + ANA.get('click_whatsapp', 0) }}</b></span>
          <span class="pill"><i class="bi bi-geo-alt text-danger"></i> <b>{{ ANA.get('click_maps', 0) }}</b></span>
        </div>
        <span class="sub" style="margin:0;"><i class="bi bi-info-circle"></i> Activa el tracking en tu web.</span>
      </div>
    </div>

    <div class="section-title">Gestión y Creación</div>

    {# Armamos la lista de acciones usando íconos de Bootstrap #}
    {% set acciones = [] %}
    
    {% if current_user.role == 'admin' %}
      {% set acciones = acciones + [
        {'icon':'<i class="bi bi-people-fill"></i>','title':'Gestionar usuarios','text':'Agrega, edita o elimina usuarios.','href':url_for('manage_users'),'btn':'primary','label':'Gestionar'},
        {'icon':'<i class="bi bi-sliders"></i>','title':'Configurar página','text':'Edita la información de tu sitio.','href':(url_for('manage_page_slug', slug=PAGE.slug) if PAGE else '#'),'btn':'primary','label':'Ajustes'}
      ] %}
    {% endif %}

    {% if current_user.role in ['admin','moderador'] %}
      {% set acciones = acciones + [
        {'icon':'<i class="bi bi-pencil-square"></i>','title':'Escribir post','text':'Publica un artículo en tu blog.','href':url_for('crear_post_negocio'),'btn':'success','label':'Crear Post', 'create':true},
        {'icon':'<i class="bi bi-megaphone-fill"></i>','title':'Lanzar aviso','text':'Notifica a tu comunidad.','href':url_for('create_aviso'),'btn':'success','label':'Crear Aviso', 'create':true},
        {'icon':'<i class="bi bi-bag-plus-fill"></i>','title':'Nuevo producto','text':'Añade artículos a tu catálogo.','href':url_for('create_producto'),'btn':'success','label':'Añadir', 'create':true},
        {'icon':'<i class="bi bi-ticket-detailed-fill"></i>','title':'Nueva promo','text':'Crea cupones y descuentos.','href':url_for('admin_promos'),'btn':'success','label':'Lanzar', 'create':true}
      ] %}
    {% endif %}

    {% set acciones = acciones + [
      {'icon':'<i class="bi bi-journal-text"></i>','title':'Ver publicaciones','text':'Consulta y gestiona tus posts.','href':url_for('list_post'),'btn':'secondary','label':'Ver Todo'},
      {'icon':'<i class="bi bi-card-checklist"></i>','title':'Ver avisos','text':'Revisa los avisos publicados.','href':url_for('list_avisos'),'btn':'secondary','label':'Ver Todo'},
      {'icon':'<i class="bi bi-box-seam"></i>','title':'Ver catálogo','text':'Administra productos/servicios.','href':url_for('list_productos'),'btn':'secondary','label':'Ver Todo'},
      {'icon':'<i class="bi bi-star-fill"></i>','title':'Ver reseñas','text':'Consulta y modera valoraciones.','href':url_for('admin_reseñas'),'btn':'secondary','label':'Moderar'},
      {'icon':'<i class="bi bi-lightning-fill"></i>','title':'Ver leads','text':'Revisa potenciales clientes.','href':url_for('admin_leads'),'btn':'secondary','label':'Revisar'},
      {'icon':'<i class="bi bi-calendar-range"></i>','title':'Ver agenda','text':'Aprueba o rechaza citas.','href':url_for('admin_appointments'),'btn':'secondary','label':'Revisar'}
    ] %}

    <div class="actions-grid">
      {% for a in acciones %}
        <div class="action-card">
          <div class="action-icon {% if a.create %}create-icon{% endif %}">{{ a.icon|safe }}</div>
          <div class="action-body">
            <h5>{{ a.title }}</h5>
            <p>{{ a.text }}</p>
            <a href="{{ a.href }}" class="btn {% if a.create %}btn-create{% else %}btn-{{ a.btn }}{% endif %}">
              {{ a.label }}
            </a>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="section-title">Actividad Reciente</div>
    <div class="recent-row">

      <div class="panel">
        <h5><i class="bi bi-file-earmark-richtext text-primary"></i> Últimos Posts</h5>
        {% if R.posts and R.posts|length %}
          <ul class="list-compact">
            {% for p in R.posts[:6] %}
              {% set POST_ID = (p.post_id if p.post_id is defined else (p.id if p.id is defined else ('' ~ p._id) if p._id is defined else None)) %}
              {% if POST_ID %}
                {% set POST_URL = url_for('ver_post', post_id=POST_ID) %}
              {% elif p.slug is defined %}
                {% set POST_URL = url_for('ver_post', slug=p.slug) %}
              {% else %}
                {% set POST_URL = '#' %}
              {% endif %}
              <li>
                <a href="{{ POST_URL }}" class="item-title">{{ p.titulo or p.title }}</a>
                <div class="item-meta">
                  {% set f = (p.fecha if p.fecha is defined else (p.created_at if p.created_at is defined else None)) %}
                  {% if f %}<i class="bi bi-clock"></i> {{ f.strftime('%d/%m/%Y') if f.strftime is defined else f }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty"><i class="bi bi-journal-x fs-4 d-block mb-2"></i>Aún no hay publicaciones.</div>
        {% endif %}
      </div>

      <div class="panel">
        <h5><i class="bi bi-megaphone text-warning"></i> Avisos Activos</h5>
        {% if R.avisos and R.avisos|length %}
          <ul class="list-compact">
            {% for a in R.avisos[:6] %}
              <li>
                <span class="item-title">{{ a.titulo or a.title }}</span>
                <div class="item-meta">
                  {% set f = (a.fecha if a.fecha is defined else (a.created_at if a.created_at is defined else None)) %}
                  {% if f %}<i class="bi bi-clock"></i> {{ f.strftime('%d/%m/%Y') if f.strftime is defined else f }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty"><i class="bi bi-bell-slash fs-4 d-block mb-2"></i>Sin avisos por ahora.</div>
        {% endif %}
      </div>

      <div class="panel">
        <h5><i class="bi bi-bag-check text-success"></i> Catálogo</h5>
        {% if R.productos and R.productos|length %}
          <ul class="list-compact">
            {% for pr in R.productos[:6] %}
              <li>
                <span class="item-title">{{ pr.title or pr.nombre or pr.name }}</span>
                <div class="item-meta fw-bold text-success">
                  {% if pr.price is defined and pr.price is not none %}${{ (pr.price|float)|round(2) }}{% endif %}
                  <span class="small">{{ pr.moneda or 'MXN' }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty"><i class="bi bi-basket-x fs-4 d-block mb-2"></i>Todavía no hay productos.</div>
        {% endif %}
      </div>

    </div>
  </div>
</div>
{% endblock %}