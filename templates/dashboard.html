{% extends "layout.html" %}
{% block title %}Dashboard ¬∑ Global PYMES{% endblock %}

{% block content %}
{# ==== Defaults seguros ==== #}
{% set PAGE = page|default(None) %}
{% set S = stats|default({}) %}
{% set R = recientes|default({'posts':[], 'avisos':[], 'productos':[]}) %}

{# ====== NUEVOS (si existen) ====== #}
{% set ANA = analytics|default({}) %}
{% set DV  = daily_views|default([]) %}
{% set LEADS_TOTAL = leads_total|default(0) %}
{% set LEADS_7D    = leads_7d|default(0) %}
{% set APPT_TOTAL  = appt_total|default(0) %}
{% set APPT_PEND   = appt_pending|default(0) %}
{% set PROMOS_ACT  = promos_active|default(0) %}

<style>
  /* ===== Theme Blue + Green (Create) ===== */
  :root{
    --page-bg: #070b18;
    --shell-bg: rgba(10,16,34,.52);
    --panel: rgba(10,16,34,.45);
    --panel-solid: #0b1226;
    --ink: #e8eefc;
    --muted: rgba(232,238,252,.58);

    --blue: #2563eb;
    --blue-2: #60a5fa;
    --blue-soft: rgba(37,99,235,.16);

    --green: #22c55e;
    --green-2: #86efac;
    --green-soft: rgba(34,197,94,.16);

    --stroke: rgba(148,163,184,.16);
    --radius-sm: 14px;
    --radius-md: 18px;
    --shadow: 0 18px 44px rgba(0,0,0,.45);

    --gradient-header:
      radial-gradient(circle at 12% 18%, rgba(96,165,250,.35), rgba(7,11,24,0) 42%),
      radial-gradient(circle at 85% -10%, rgba(34,197,94,.22), rgba(7,11,24,0) 42%),
      linear-gradient(135deg, #0b1226 0%, #0e1a3b 52%, #0b1226 100%);
  }

  .dash-shell{
    max-width: 1220px;
    margin: 1.4rem auto 3rem;
    background:
      radial-gradient(circle at 18% -12%, rgba(37,99,235,.22), rgba(7,11,24,0) 40%),
      rgba(9,12,22,.62);
    border: 1px solid rgba(148,163,184,.12);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow);
    overflow: hidden;
    backdrop-filter: blur(24px);
  }

  /* ===== Nav/Topbar ===== */
  .dash-nav{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    align-items:center;
    padding: .95rem 1.2rem;
    border-bottom: 1px solid rgba(148,163,184,.12);
    background: rgba(7,11,24,.55);
    backdrop-filter: blur(18px);
  }
  .nav-left{display:flex;align-items:center;gap:.75rem;min-width: 280px;}
  .nav-pill{
    background: rgba(37,99,235,.16);
    border: 1px solid rgba(96,165,250,.28);
    color: #dbeafe;
    padding: .32rem .65rem;
    border-radius: 999px;
    font-size: .68rem;
    font-weight: 700;
    letter-spacing: .06em;
    text-transform: uppercase;
  }
  .nav-title{display:flex;flex-direction:column;line-height:1.15;}
  .nav-title strong{color:#fff;font-size:.92rem;}
  .nav-title small{color:rgba(232,238,252,.55);font-size:.7rem;}

  .nav-actions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;}
  .btnx{
    display:inline-flex;
    align-items:center;
    gap:.45rem;
    padding: .45rem .75rem;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,.18);
    background: rgba(15,23,42,.25);
    color: #fff;
    text-decoration:none;
    font-size: .72rem;
    font-weight: 650;
    transition: transform .08s linear, filter .08s linear, background .12s ease;
  }
  .btnx:hover{transform: translateY(-1px); filter:brightness(1.05);}
  .btnx-blue{background: rgba(37,99,235,.22); border-color: rgba(96,165,250,.28);}
  .btnx-green{background: rgba(34,197,94,.2); border-color: rgba(134,239,172,.28);}
  .btnx-ghost{background: rgba(15,23,42,.18);}

  .nav-search{
    display:flex; align-items:center; gap:.45rem;
    background: rgba(15,23,42,.42);
    border:1px solid rgba(226,232,240,.12);
    border-radius:999px;
    padding:.35rem .75rem;
  }
  .nav-search input{
    background:transparent;border:0;outline:0;color:#fff;width:240px;font-size:.74rem;
  }
  .nav-search input::placeholder{color:rgba(232,238,252,.55);}

  /* ===== Header (welcome) ===== */
  .dash-header{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    align-items:center;
    background: var(--gradient-header);
    padding: 1.05rem 1.2rem;
  }
  .dash-title{display:flex;flex-direction:column;gap:.25rem;}
  .dash-title h1{font-size:1.18rem;margin:0;color:#fff;font-weight:750;}
  .dash-title small{color:rgba(232,238,252,.6);font-size:.7rem;}

  /* ===== Body ===== */
  .dash-body{padding: 1.1rem 1.2rem 1.5rem;}

  /* ===== KPIs ===== */
  .kpi-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
    gap:.9rem;
  }
  .kpi{
    background:
      radial-gradient(circle at 12% 18%, rgba(96,165,250,.16), rgba(15,23,42,0) 52%),
      rgba(15,23,42,.22);
    border:1px solid rgba(148,163,184,.14);
    border-radius: var(--radius-sm);
    padding:.8rem .9rem .85rem;
    text-decoration:none;
    display:block;
    position:relative;
    overflow:hidden;
  }
  .kpi::after{
    content:"";
    position:absolute; inset:-20px -20px auto auto;
    width: 120px; height: 120px;
    background: radial-gradient(circle at 30% 30%, rgb(176 185 203 / 35%), rgba(15, 23, 42, 0) 70%);
    transform: rotate(18deg);
  }
  .kpi-badge{
    background: rgba(37,99,235,.95);
    color:#fff;
    font-size:.6rem;
    padding:.12rem .55rem .14rem;
    border-radius:999px;
    font-weight:750;
    display:inline-block;
    margin-bottom:.38rem;
  }
  .kpi-value{font-size:1.45rem;font-weight:800;color:#fff;line-height:1.05;}
  .kpi-label{font-size:.72rem;color:rgba(232,238,252,.6);}
  .kpi:hover{filter:brightness(1.06);}

  /* ===== Section title ===== */
  .section-title{
    font-size:.72rem;
    text-transform:uppercase;
    letter-spacing:.10em;
    color:rgba(232,238,252,.38);
    margin:1.25rem 0 .6rem;
    font-weight:650;
    display:flex;
    align-items:center;
    gap:.5rem;
  }
  .section-title:before{
    content:"";
    width:10px;height:10px;border-radius:999px;
    background: rgba(37,99,235,.9);
    box-shadow: 0 0 0 4px rgba(37,99,235,.14);
  }

  /* ===== Actions ===== */
  .actions-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(250px,1fr));
    gap:.8rem;
  }
  .action-card{
    background:
      radial-gradient(circle at 22% 18%, rgba(255,255,255,.05), rgba(17,24,39,0) 48%),
      rgba(17,24,39,.26);
    border:1px solid rgba(148,163,184,.12);
    border-radius: var(--radius-sm);
    padding:.85rem .85rem .9rem;
    display:flex;
    gap:.75rem;
    align-items:flex-start;
    min-height:92px;
    backdrop-filter: blur(14px);
  }
  .action-icon{
    width:42px;height:42px;border-radius: 14px;
    display:grid;place-items:center;
    background: radial-gradient(circle at 30% 30%, rgba(96,165,250,.9), rgba(37,99,235,.95) 52%, rgba(30,58,138,1) 100%);
    color:#fff;font-size:1.05rem;
    box-shadow: 0 12px 22px rgba(0,0,0,.28);
    flex:0 0 auto;
  }
  .action-body h5{font-size:.86rem;margin:0 0 .22rem;color:#fff;font-weight:750;}
  .action-body p{font-size:.71rem;color:rgba(232,238,252,.55);margin:0 0 .5rem;}
  .action-body .btn{
    padding:.28rem .68rem;
    font-size:.68rem;
    border-radius: 999px;
    border: 0;
    font-weight: 750;
  }
  .btn-primary{background: var(--blue); border:0;}
  .btn-secondary{background: rgba(148,163,184,.14); border: 1px solid rgba(148,163,184,.28); color:#fff;}
  .btn-success{background: var(--green); border:0;}
  .btn-warning{background: #f59e0b; border:0;}
  .btn-info{background: #38bdf8; border:0; color:#0b1226;}

  /* Create buttons -> green emphasis */
  .btn-create{background: var(--green) !important; color:#05250f !important; border:0 !important;}
  .btn-create:hover{filter:brightness(1.04);}

  /* ===== Modules strip (SaaS) ===== */
  .modules-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
    gap:.8rem;
    margin-top:.9rem;
  }
  .module{
    background:
      radial-gradient(circle at 15% 18%, rgba(37,99,235,.15), rgba(15,23,42,0) 55%),
      rgba(17,24,39,.33);
    border:1px solid rgba(148,163,184,.12);
    border-radius: var(--radius-sm);
    padding:.85rem .9rem;
    backdrop-filter: blur(10px);
  }
  .module h6{margin:0;color:#fff;font-size:.78rem;font-weight:800;}
  .module .sub{margin:.2rem 0 .6rem;color:rgba(232,238,252,.55);font-size:.68rem;}
  .module .meta{display:flex;gap:.5rem;flex-wrap:wrap;margin:.35rem 0 .7rem;}
  .pill{
    display:inline-flex;align-items:center;gap:.35rem;
    padding:.22rem .55rem;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.16);
    background: rgba(15,23,42,.22);
    color:rgba(232,238,252,.85);
    font-size:.66rem;
    font-weight:700;
  }
  .pill b{color:#fff;}
  .module a{color:#fff;text-decoration:none;}
  .module a:hover{text-decoration:underline;}

  /* ===== Recientes ===== */
  .recent-row{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px,1fr));
    gap:.9rem;
    margin-top:.9rem;
  }
  .panel{
    background:
      radial-gradient(circle at 10% 12%, rgba(96,165,250,.10), rgba(15,23,42,0) 42%),
      rgba(17,24,39,.35);
    border:1px solid rgba(148,163,184,.12);
    border-radius: var(--radius-sm);
    padding:.85rem .9rem .2rem;
    backdrop-filter: blur(10px);
  }
  .panel h5{font-size:.8rem;margin:0 0 .55rem;color:#fff;font-weight:800;}
  .list-compact{list-style:none;margin:0;padding:0;}
  .list-compact li{padding:.48rem 0 .55rem;border-bottom:1px dashed rgba(148,163,184,.14);}
  .list-compact li:last-child{border-bottom:0;}
  .item-title{font-size:.76rem;font-weight:600;color:#fff;text-decoration:none;}
  .item-title:hover{text-decoration:underline;}
  .item-meta{font-size:.64rem;color:rgba(232,238,252,.40);}
  .empty{
    background: rgba(15,23,42,.22);
    border:1px dashed rgba(148,163,184,.24);
    border-radius:12px;
    padding:.75rem .6rem;
    text-align:center;
    font-size:.70rem;
    color:rgba(232,238,252,.45);
  }

  @media (max-width: 900px){
    .nav-left{min-width:unset}
    .nav-search input{width: 180px;}
  }
  @media (max-width: 768px){
    .dash-shell{margin:.55rem .35rem 2.5rem;}
    .dash-nav{flex-direction:column;align-items:flex-start;}
    .dash-header{flex-direction:column;align-items:flex-start;}
    .nav-actions{width:100%;justify-content:flex-start}
  }
</style>

<div class="dash-shell">

  <!-- TOP NAV (super pro) -->
  <div class="dash-nav">
    <div class="nav-left">
      <div class="nav-pill">Dashboard</div>
      <div class="nav-title">
        <strong>{{ PAGE.get('business_name','Tu sitio') if PAGE else 'Tu sitio' }}</strong>
        <small>Slug: {{ PAGE.get('slug','‚Äî') if PAGE else '‚Äî' }} ¬∑ Plan: {{ (PAGE.get('plan') if PAGE else '‚Äî') }}</small>
      </div>
    </div>

    <form class="nav-search" method="get" action="{{ url_for('dashboard_slug', slug=PAGE.slug) if PAGE else url_for('dashboard') }}">
      <span style="opacity:.9;">üîé</span>
      <input name="q" type="search" placeholder="Buscar publicaciones, avisos, productos‚Ä¶">
    </form>

    <div class="nav-actions">
      {% if PAGE and PAGE.get('slug') %}
        <a class="btnx btnx-blue" target="_blank" href="{{ url_for('negocio_por_slug', slug=PAGE.slug) }}">
          üëÄ Ver p√∫blico
        </a>
      {% endif %}
      <a class="btnx btnx-ghost" href="{{ url_for('billing_portal') }}">
        üí≥ Pagos / Plan
      </a>
      {% if current_user.role == 'admin' and PAGE and PAGE.get('slug') %}
        <a class="btnx btnx-ghost" href="{{ url_for('manage_page_slug', slug=PAGE.slug) }}">
          üõ† Editar sitio
        </a>
      {% endif %}
      <a class="btnx btnx-ghost" href="{{ url_for('sites') }}">
        üß© Cambiar sitio
      </a>
    </div>
  </div>

  <!-- HEADER -->
  <div class="dash-header">
    <div class="dash-title">
      <h1>Hola, {{ current_user.nombre }}</h1>
      {% if now is defined %}
        <small>Hoy es {{ now().strftime('%d/%m/%Y') }} ¬∑ Gestionando: {{ PAGE.get('business_name','Tu sitio') if PAGE else 'Tu sitio' }}</small>
      {% endif %}
    </div>
    <div style="display:flex;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;">
      <span class="pill">‚ö° Leads 7d: <b>{{ LEADS_7D }}</b></span>
      <span class="pill">üìÜ Pendientes: <b>{{ APPT_PEND }}</b></span>
      <span class="pill">üè∑ Promos: <b>{{ PROMOS_ACT }}</b></span>
    </div>
  </div>

  <!-- BODY -->
  <div class="dash-body">

    <!-- KPIs -->
    <div class="kpi-row">
      {% set kpis = [
        {'label':'Publicaciones','value': S.get('posts', 0),'href':url_for('list_post')},
        {'label':'Avisos','value': S.get('avisos', 0),'href':url_for('list_avisos')},
        {'label':'Productos','value': S.get('productos', 0),'href':url_for('list_productos')},
        {'label':'Rese√±as','value': S.get('resenas', 0),'href':url_for('admin_rese√±as')},
        {'label':'Leads','value': LEADS_TOTAL,'href':url_for('admin_leads')},
        {'label':'Reservas','value': APPT_TOTAL,'href':url_for('admin_appointments')},
        {'label':'Promos','value': PROMOS_ACT,'href':url_for('admin_promos')}
      ] %}
      {% if current_user.role == 'admin' %}
        {% set kpis = kpis + [{'label':'Usuarios','value': S.get('usuarios', 0),'href':url_for('manage_users')}] %}
      {% endif %}

      {% for k in kpis %}
        <a href="{{ k.href }}" class="kpi">
          <div class="kpi-badge">KPI</div>
          <div class="kpi-value">{{ k.value }}</div>
          <div class="kpi-label">{{ k.label }}</div>
        </a>
      {% endfor %}
    </div>

    <!-- M√≥dulos SaaS -->
    <div class="section-title">M√≥dulos (SaaS)</div>
    <div class="modules-row">
      <div class="module">
        <h6>‚ö° Leads / Cotizaciones</h6>
        <div class="sub">Cotizaciones guardadas desde tu bot√≥n ‚ÄúCotizar‚Äù.</div>
        <div class="meta">
          <span class="pill">Total <b>{{ LEADS_TOTAL }}</b></span>
          <span class="pill">√öltimos 7d <b>{{ LEADS_7D }}</b></span>
        </div>
        <a href="{{ url_for('admin_leads') }}">Ver leads ‚Üí</a>
      </div>

      <div class="module">
        <h6>üìÜ Reservas</h6>
        <div class="sub">Solicitudes de citas y aprobaciones.</div>
        <div class="meta">
          <span class="pill">Pendientes <b>{{ APPT_PEND }}</b></span>
          <span class="pill">Total <b>{{ APPT_TOTAL }}</b></span>
        </div>
        <a href="{{ url_for('admin_appointments') }}">Ver reservas ‚Üí</a>
      </div>

      <div class="module">
        <h6>üè∑ Promos</h6>
        <div class="sub">Promociones visibles en tu p√°gina p√∫blica.</div>
        <div class="meta">
          <span class="pill">Activas <b>{{ PROMOS_ACT }}</b></span>
        </div>
        <a href="{{ url_for('admin_promos') }}">Gestionar promos ‚Üí</a>
      </div>

      <div class="module">
        <h6>üìà Analytics</h6>
        <div class="sub">Clicks y vistas (√∫ltimos 7 d√≠as).</div>
        <div class="meta">
          <span class="pill">Vistas <b>{{ ANA.get('view', 0) }}</b></span>
          <span class="pill">WA <b>{{ ANA.get('click_whatsapp_fab', 0) + ANA.get('click_whatsapp', 0) }}</b></span>
          <span class="pill">Maps <b>{{ ANA.get('click_maps', 0) }}</b></span>
        </div>
        <span class="sub" style="margin:0;">Tip: activa tracking en la plantilla p√∫blica.</span>
      </div>
    </div>

    <!-- Acciones r√°pidas -->
    <div class="section-title">Acciones r√°pidas</div>

    {% set acciones = [] %}
    {% if current_user.role == 'admin' %}
      {% set acciones = acciones + [
        {'icon':'üë•','title':'Gestionar usuarios','text':'Agrega, edita o elimina usuarios.','href':url_for('manage_users'),'btn':'primary','label':'Ir'},
        {'icon':'üõ†','title':'Gestionar p√°gina','text':'Edita la p√°gina asignada.','href':(url_for('manage_page_slug', slug=PAGE.slug) if PAGE else '#'),'btn':'primary','label':'Ir'}
      ] %}
    {% endif %}

    {# CREATE en verde #}
    {% if current_user.role in ['admin','moderador'] %}
      {% set acciones = acciones + [
        {'icon':'üìù','title':'Crear blog','text':'Publica una nueva entrada.','href':url_for('crear_post_negocio'),'btn':'success','label':'Crear', 'create':true},
        {'icon':'üì¢','title':'Crear aviso','text':'Publica un aviso para tu comunidad.','href':url_for('create_aviso'),'btn':'success','label':'Crear', 'create':true},
        {'icon':'üõí','title':'Crear producto','text':'Nuevo producto con imagen y precio.','href':url_for('create_producto'),'btn':'success','label':'Crear', 'create':true},
        {'icon':'üè∑','title':'Crear promo','text':'Lanza una promo visible en tu p√°gina p√∫blica.','href':url_for('admin_promos'),'btn':'success','label':'Crear', 'create':true}
      ] %}
    {% endif %}

    {% set acciones = acciones + [
      {'icon':'üìö','title':'Ver publicaciones','text':'Consulta y gestiona tus posts.','href':url_for('list_post'),'btn':'secondary','label':'Ver'},
      {'icon':'üìã','title':'Ver avisos','text':'Revisa los avisos publicados.','href':url_for('list_avisos'),'btn':'secondary','label':'Ver'},
      {'icon':'üì¶','title':'Ver productos','text':'Administra productos/servicios.','href':url_for('list_productos'),'btn':'secondary','label':'Ver'},
      {'icon':'‚≠ê','title':'Ver rese√±as','text':'Consulta y modera rese√±as.','href':url_for('admin_rese√±as'),'btn':'secondary','label':'Ver'},
      {'icon':'‚ö°','title':'Ver leads','text':'Cotizaciones registradas (SaaS).','href':url_for('admin_leads'),'btn':'secondary','label':'Ver'},
      {'icon':'üìÜ','title':'Ver reservas','text':'Aprueba o rechaza citas.','href':url_for('admin_appointments'),'btn':'secondary','label':'Ver'}
    ] %}

    <div class="actions-grid">
      {% for a in acciones %}
        <div class="action-card">
          <div class="action-icon">{{ a.icon }}</div>
          <div class="action-body">
            <h5>{{ a.title }}</h5>
            <p>{{ a.text }}</p>
            <a href="{{ a.href }}"
               class="btn {% if a.create %}btn-create{% else %}btn-{{ a.btn }}{% endif %}">
              {{ a.label }}
            </a>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Recientes -->
    <div class="section-title">Recientes</div>
    <div class="recent-row">

      <!-- posts -->
      <div class="panel">
        <h5>üÜï Publicaciones</h5>
        {% if R.posts and R.posts|length %}
          <ul class="list-compact">
            {% for p in R.posts[:6] %}
              {% set POST_ID =
                (p.post_id if p.post_id is defined else
                 (p.id if p.id is defined else
                  ('' ~ p._id) if p._id is defined else None))
              %}
              {% if POST_ID %}
                {% set POST_URL = url_for('ver_post', post_id=POST_ID) %}
              {% elif p.slug is defined %}
                {% set POST_URL = url_for('ver_post', slug=p.slug) %}
              {% else %}
                {% set POST_URL = '#' %}
              {% endif %}
              <li>
                <a href="{{ POST_URL }}" class="item-title">{{ p.titulo or p.title }}</a>
                <div class="item-meta">
                  {% set f = (p.fecha if p.fecha is defined else (p.created_at if p.created_at is defined else None)) %}
                  {% if f %}{{ f.strftime('%d/%m/%Y') if f.strftime is defined else f }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">A√∫n no hay publicaciones.</div>
        {% endif %}
      </div>

      <!-- avisos -->
      <div class="panel">
        <h5>üì£ Avisos</h5>
        {% if R.avisos and R.avisos|length %}
          <ul class="list-compact">
            {% for a in R.avisos[:6] %}
              <li>
                <span class="item-title">{{ a.titulo or a.title }}</span>
                <div class="item-meta">
                  {% set f = (a.fecha if a.fecha is defined else (a.created_at if a.created_at is defined else None)) %}
                  {% if f %}{{ f.strftime('%d/%m/%Y') if f.strftime is defined else f }}{% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">Sin avisos por ahora.</div>
        {% endif %}
      </div>

      <!-- productos -->
      <div class="panel">
        <h5>üõçÔ∏è Productos</h5>
        {% if R.productos and R.productos|length %}
          <ul class="list-compact">
            {% for pr in R.productos[:6] %}
              <li>
                <span class="item-title">{{ pr.title or pr.nombre or pr.name }}</span>
                <div class="item-meta">
                  {% if pr.price is defined and pr.price is not none %}{{ (pr.price|float)|round(2) }}{% endif %}
                  {{ pr.moneda or 'MXN' }}
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">Todav√≠a no hay productos recientes.</div>
        {% endif %}
      </div>

    </div>
  </div>
</div>
{% endblock %}
