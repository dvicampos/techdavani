{% extends "layout.html" %}
{% block title %}Calendario de Reservas{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-4 gap-3">
  <h2 class="mb-0 fw-bold text-dark">
    <i class="bi bi-calendar3 me-2"></i>Calendario — {{ ym }}
  </h2>
  <div class="d-flex gap-2">
    <div class="btn-group shadow-sm">
      <a class="btn btn-outline-secondary" href="{{ url_for('admin_calendar', ym=prev_month) }}" title="Mes Anterior">&larr;</a>
      <a class="btn btn-outline-secondary fw-semibold" href="{{ url_for('admin_calendar') }}">Hoy</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('admin_calendar', ym=next_month) }}" title="Mes Siguiente">&rarr;</a>
    </div>
    <a class="btn btn-primary shadow-sm" href="{{ url_for('admin_appointments') }}">Ver Lista</a>
  </div>
</div>

<style>
  /* Contenedor responsivo */
  .cal-wrapper { overflow-x: auto; padding-bottom: 1rem; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, minmax(140px, 1fr)); gap: 12px; min-width: 1000px; }
  .cal-head { text-align: center; font-weight: 700; color: #64748b; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; }
  
  /* Celdas del calendario */
  .cal-cell { border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; min-height: 110px; background: #ffffff; display: flex; flex-direction: column; align-items: center; transition: border-color 0.2s; }
  .cal-cell:hover { border-color: #cbd5e1; }
  .cal-cell-empty { background: #f8fafc; border: 1px dashed #e2e8f0; border-radius: 12px; }
  
  /* Número del día centrado */
  .cal-day { font-weight: 700; font-size: 1.1rem; color: #334155; background: #f1f5f9; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin-bottom: 10px; }
  
  /* Tarjetas dentro del modal */
  .appt { font-size: 0.9rem; padding: 12px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid transparent; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .appt-title { font-weight: 600; color: #1e293b; margin-bottom: 4px; font-size: 1rem;}
  .appt-meta { font-size: 0.85rem; color: #64748b; }
  
  /* Colores por estado */
  .st-pending { background: #fff7ed; border-color: #f97316; }
  .st-approved { background: #ecfdf5; border-color: #10b981; }
  .st-rejected { background: #fef2f2; border-color: #ef4444; opacity: 0.75; }
</style>

<div class="cal-wrapper">
  <div class="cal-grid mb-3">
    {% for h in ["Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom"] %}
      <div class="cal-head">{{ h }}</div>
    {% endfor %}
  </div>

  <div class="cal-grid">
    {% for week in weeks %}
      {% for day in week %}
        {% if day == 0 %}
          <div class="cal-cell-empty"></div>
        {% else %}
          {% set dkey = "%04d-%02d-%02d"|format(year, month, day) %}
          {% set day_appts = by_day.get(dkey) or [] %}
          
          <div class="cal-cell">
            <div class="cal-day">{{ day }}</div>
            
            {% if day_appts|length > 0 %}
              <button class="btn btn-sm btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#modal-{{ dkey }}">
                Ver {{ day_appts|length }} cita{% if day_appts|length > 1 %}s{% endif %}
              </button>
            {% else %}
              <span class="text-muted" style="font-size: 0.75rem;">Sin citas</span>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
</div>

{% for week in weeks %}
  {% for day in week %}
    {% if day != 0 %}
      {% set dkey = "%04d-%02d-%02d"|format(year, month, day) %}
      {% set day_appts = by_day.get(dkey) or [] %}
      
      {% if day_appts|length > 0 %}
      <div class="modal fade" id="modal-{{ dkey }}" tabindex="-1" aria-labelledby="modalLabel-{{ dkey }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title fw-bold" id="modalLabel-{{ dkey }}">Citas del {{ day }}/{{ month }}/{{ year }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              
              {% for a in day_appts %}
                {% set st = a.get("status", "pending") %}
                <div class="appt st-{{ st }}">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="appt-title">{{ a.get("customer_name", "Sin Nombre") }}</div>
                    <span class="badge text-bg-{{ 'warning' if st == 'pending' else 'success' if st == 'approved' else 'danger' }}">
                      {{ 'Pendiente' if st == 'pending' else 'Aprobada' if st == 'approved' else 'Rechazada' }}
                    </span>
                  </div>
                  
                  <div class="appt-meta d-flex flex-column gap-1 mt-1">
                    <span>
                      <strong class="text-dark"><i class="bi bi-clock"></i> {{ a.get("start_at").strftime("%H:%M") }}</strong> 
                      · {{ a.get("service_title", "Servicio") }}
                    </span>
                    {% if a.get("phone") %}
                      <span><i class="bi bi-telephone"></i> {{ a.get("phone") }}</span>
                    {% endif %}
                  </div>

                  {% if st == "pending" %}
                  <div class="d-flex gap-2 mt-3 pt-3 border-top border-secondary-subtle">
                    <form method="POST" action="{{ url_for('admin_appointments_action', appt_id=a['_id'], action='approve') }}" class="m-0 flex-grow-1">
                      <button class="btn btn-success btn-sm w-100" type="submit">Aprobar</button>
                    </form>
                    <form method="POST" action="{{ url_for('admin_appointments_action', appt_id=a['_id'], action='reject') }}" class="m-0 flex-grow-1">
                      <button class="btn btn-danger btn-sm w-100" type="submit">Rechazar</button>
                    </form>
                  </div>
                  {% endif %}
                </div>
              {% endfor %}
              
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
    {% endif %}
  {% endfor %}
{% endfor %}

{% endblock %}