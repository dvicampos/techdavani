{% extends "layout.html" %}
{% block title %}Dashboard ¬∑ Global PYMES{% endblock %}

{% block content %}

  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400..700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* ===== Same design as Dashboard (Blue + Green create) ===== */
    :root{
      --page-bg: #070b18;
      --shell-bg: rgba(10,16,34,.52);
      --panel: rgba(10,16,34,.45);
      --panel-solid: #0b1226;

      --ink: #e8eefc;
      --muted: rgba(232,238,252,.58);

      --blue: #2563eb;
      --blue-2: #60a5fa;
      --blue-soft: rgba(37,99,235,.16);

      --green: #22c55e;
      --green-2: #86efac;
      --green-soft: rgba(34,197,94,.16);

      --stroke: rgba(148,163,184,.16);
      --radius-sm: 14px;
      --radius-md: 18px;
      --shadow: 0 18px 44px rgba(0,0,0,.45);

      --gradient-header:
        radial-gradient(circle at 12% 18%, rgba(96,165,250,.35), rgba(7,11,24,0) 42%),
        radial-gradient(circle at 85% -10%, rgba(34,197,94,.22), rgba(7,11,24,0) 42%),
        linear-gradient(135deg, #0b1226 0%, #0e1a3b 52%, #0b1226 100%);
    }

    html,body{background:var(--page-bg); color:var(--ink);}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,sans-serif;}

    .brand-font{font-family:"Space Grotesk",Inter,system-ui,sans-serif;}
    .muted{color:var(--muted);}

    .dash-shell{
      max-width: 1220px;
      margin: 1.4rem auto 3rem;
      background:
        radial-gradient(circle at 18% -12%, rgba(37,99,235,.22), rgba(7,11,24,0) 40%),
        rgba(9,12,22,.62);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(24px);
    }

    /* ===== Top Nav (same vibe) ===== */
    .dash-nav{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:center;
      padding: .95rem 1.2rem;
      border-bottom: 1px solid rgba(148,163,184,.12);
      background: rgba(7,11,24,.55);
      backdrop-filter: blur(18px);
    }
    .nav-left{display:flex;align-items:center;gap:.75rem;min-width: 280px;}
    .nav-pill{
      background: rgba(37,99,235,.16);
      border: 1px solid rgba(96,165,250,.28);
      color: #dbeafe;
      padding: .32rem .65rem;
      border-radius: 999px;
      font-size: .68rem;
      font-weight: 800;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .nav-title{display:flex;flex-direction:column;line-height:1.15;}
    .nav-title strong{color:#fff;font-size:.92rem;}
    .nav-title small{color:rgba(232,238,252,.55);font-size:.7rem;}

    .nav-actions{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap;justify-content:flex-end;}
    .btnx{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding: .45rem .75rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.25);
      color: #fff;
      text-decoration:none;
      font-size: .72rem;
      font-weight: 700;
      transition: transform .08s linear, filter .08s linear, background .12s ease;
      user-select:none;
      cursor:pointer;
    }
    .btnx:hover{transform: translateY(-1px); filter:brightness(1.05);}
    .btnx-blue{background: rgba(37,99,235,.22); border-color: rgba(96,165,250,.28);}
    .btnx-green{background: rgba(34,197,94,.20); border-color: rgba(134,239,172,.28); color:#05250f;}
    .btnx-ghost{background: rgba(15,23,42,.18);}

    /* ===== Header ===== */
    .dash-header{
      display:flex;
      justify-content:space-between;
      gap:1rem;
      align-items:center;
      background: var(--gradient-header);
      padding: 1.05rem 1.2rem;
    }
    .dash-title{display:flex;flex-direction:column;gap:.25rem;}
    .dash-title h1{font-size:1.18rem;margin:0;color:#fff;font-weight:800;}
    .dash-title small{color:rgba(232,238,252,.6);font-size:.7rem;}

    /* ===== Body ===== */
    .dash-body{padding: 1.1rem 1.2rem 1.5rem;}

    /* ===== Chips / Pills ===== */
    .pill{
      display:inline-flex;align-items:center;gap:.35rem;
      padding:.22rem .55rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.22);
      color:rgba(232,238,252,.85);
      font-size:.66rem;
      font-weight:750;
    }
    .pill b{color:#fff;}

    /* ===== Card panel ===== */
    .card-soft{
      background:
        radial-gradient(circle at 12% 18%, rgba(96,165,250,.12), rgba(15,23,42,0) 52%),
        rgba(17,24,39,.28);
      border:1px solid rgba(148,163,184,.12);
      border-radius: var(--radius-sm);
      padding: .85rem .9rem;
      backdrop-filter: blur(14px);
    }

    /* ===== Table ===== */
    .table-wrap{
      background:
        radial-gradient(circle at 10% 12%, rgba(96,165,250,.10), rgba(15,23,42,0) 42%),
        rgba(17,24,39,.35);
      border:1px solid rgba(148,163,184,.12);
      border-radius: var(--radius-sm);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .table{
      color: var(--ink);
      margin:0;
    }
    .table thead th{
      background: rgba(7,11,24,.55);
      color: rgba(232,238,252,.75);
      border-bottom: 1px solid rgba(148,163,184,.16)!important;
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .08em;
      padding-top:.85rem;
      padding-bottom:.85rem;
    }
    .table td{
      border-color: rgba(148,163,184,.10);
      padding-top:.85rem;
      padding-bottom:.85rem;
      font-size:.78rem;
      vertical-align: middle;
    }
    .table tbody tr:hover{background: rgba(37,99,235,.08);}

    .badge-status{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:.22rem .55rem;
      border-radius:999px;
      font-weight:800;
      font-size:.68rem;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(15,23,42,.22);
      color:#fff;
    }

    .btn-mini{
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      padding:.42rem .7rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.18);
      color:#fff;
      text-decoration:none;
      font-weight:800;
      font-size:.72rem;
      transition: transform .08s linear, filter .08s linear;
      white-space: nowrap;
    }
    .btn-mini:hover{transform:translateY(-1px);filter:brightness(1.06);}
    .btn-mini-green{background: rgba(34,197,94,.20); border-color: rgba(134,239,172,.28); color:#05250f;}
    .btn-mini-blue{background: rgba(37,99,235,.22); border-color: rgba(96,165,250,.28);}
    .btn-mini-ghost{background: rgba(15,23,42,.14);}

    code{
      background: rgba(15,23,42,.35);
      border: 1px solid rgba(148,163,184,.16);
      padding:.1rem .35rem;
      border-radius: 8px;
      color: rgba(232,238,252,.9);
    }

    @media (max-width: 900px){
      .nav-left{min-width:unset}
    }
    @media (max-width: 768px){
      .dash-shell{margin:.55rem .35rem 2.5rem;}
      .dash-nav{flex-direction:column;align-items:flex-start;}
      .dash-header{flex-direction:column;align-items:flex-start;}
      .nav-actions{width:100%;justify-content:flex-start}
    }
  </style>


  <div class="dash-shell">

    <!-- TOP NAV -->
    <div class="dash-nav">
      <div class="nav-left">
        <div class="nav-pill">Leads</div>
        <div class="nav-title">
          <strong>Cotizaciones recibidas</strong>
          <small>Sitio: {{ current_page().get('business_name','') if current_page() else '' }}</small>
        </div>
      </div>

      <div class="nav-actions">
        <a class="btnx btnx-ghost" href="{{ url_for('dashboard') }}">‚Üê Dashboard</a>
        <a class="btnx btnx-ghost" href="{{ url_for('billing_portal') }}">üí≥ Pagos / Plan</a>

        {% set CP = current_page() %}
        {% if CP and CP.get('slug') %}
          <a class="btnx btnx-blue" target="_blank" href="{{ url_for('negocio_por_slug', slug=CP.slug) }}">üëÄ Ver p√∫blico</a>
        {% endif %}
      </div>
    </div>

    <!-- HEADER -->
    <div class="dash-header">
      <div class="dash-title">
        <h1 class="brand-font">Leads / Cotizaciones</h1>
        <small>Registros desde el bot√≥n ‚ÄúCotizar‚Äù + WhatsApp. √ösalos para KPIs y seguimiento.</small>
      </div>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <span class="pill">Total <b>{{ leads|length }}</b></span>
        <span class="pill">Canal <b>WhatsApp</b></span>
        <span class="pill">Estado <b>New</b></span>
      </div>
    </div>

    <!-- BODY -->
    <div class="dash-body">

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for cat,msg in messages %}
            <div class="alert alert-{{ cat if cat else 'info' }}"
                 style="border:1px solid rgba(148,163,184,.18); background: rgba(15,23,42,.22); color:#fff;">
              {{ msg }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <div class="card-soft mb-3">
        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div class="d-flex flex-wrap gap-2">
            <span class="pill">‚ö° Nuevos primero</span>
            <span class="pill">üõ° Guardados en BD</span>
            <span class="pill">üìà √ötiles para KPIs</span>
          </div>
          <div class="muted" style="font-size:.72rem">
            Tip: responde r√°pido para mayor conversi√≥n.
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <div class="card-soft" style="border:0;border-bottom:1px solid rgba(148,163,184,.12);border-radius:0;">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="brand-font" style="font-weight:800;">Lista de leads</div>
            <div class="muted" style="font-size:.72rem">
              Total cargados: <strong style="color:#fff">{{ leads|length }}</strong>
            </div>
          </div>
        </div>

        {% if leads and leads|length > 0 %}
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Items</th>
                  <th>Canal</th>
                  <th>IP</th>
                  <th class="text-end">Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                {% for l in leads %}
                  <tr>
                    <td class="small muted">
                      {% if l.created_at %}{{ l.created_at.strftime('%d/%m/%Y %H:%M') }}{% else %}-{% endif %}
                    </td>

                    <td>
                      <div style="font-weight:800;color:#fff;">{{ l.customer_name }}</div>
                      <div class="small muted">
                        <span class="badge-status">‚óè {{ l.status or 'new' }}</span>
                      </div>
                    </td>

                    <td>
                      {% if l.items %}
                        <div class="small">
                          {% for it in l.items %}
                            <div style="color:rgba(232,238,252,.92)">‚Ä¢ <strong style="color:#fff">{{ it.title }}</strong> √ó {{ it.qty }}</div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <span class="small muted">‚Äî</span>
                      {% endif %}
                    </td>

                    <td>
                      <span class="pill">üí¨ {{ (l.channel or 'whatsapp') }}</span>
                    </td>

                    <td class="small muted">{{ l.ip or '-' }}</td>

                    <td class="text-end">
                      {% set wa = (current_page().get('whatsapp','') if current_page() else '') %}
                      {% if wa %}
                        {% set msg = "Hola, soy " ~ (l.customer_name or "") ~ ". Quisiera cotizar: " %}
                        {% if l.items %}
                          {% for it in l.items %}
                            {% set msg = msg ~ it.title ~ " x" ~ it.qty ~ "; " %}
                          {% endfor %}
                        {% endif %}
                        <a class="btn-mini btn-mini-green"
                           target="_blank"
                           href="https://wa.me/{{ wa|replace(' ','') }}?text={{ msg|urlencode }}">
                          <i class="bi bi-whatsapp"></i> Responder
                        </a>
                      {% else %}
                        <span class="small muted">Sin WhatsApp</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <div class="brand-font" style="font-size:1.35rem;font-weight:900;color:#fff;">A√∫n no hay leads</div>
            <p class="muted mb-0">Cuando alguien cotice, aqu√≠ ver√°s su solicitud y el detalle.</p>
            <div class="mt-3">
              {% set CP = current_page() %}
              {% if CP and CP.get('slug') %}
                <a class="btn-mini btn-mini-blue" target="_blank" href="{{ url_for('negocio_por_slug', slug=CP.slug) }}">
                  üëÄ Ver p√°gina p√∫blica
                </a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
