<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>{{ page.business_name or '' }}</title>
  {% if page.description %}
    <meta name="description" content="{{ page.description[:160] }}">
  {% endif %}
  {% if page.business_name %}
    <meta name="author" content="{{ page.business_name }}">
  {% endif %}

  {# ===== OG ===== #}
  {% set og_img = page.cover_image or page.image %}
  {% if og_img and not (og_img.startswith('http://') or og_img.startswith('https://')) %}
    {% set og_img = url_for('uploaded_file', filename=og_img, _external=True) %}
  {% endif %}
  {% if page.business_name %}
    <meta property="og:title" content="{{ page.business_name }}">
  {% endif %}
  {% if page.slogan or page.description %}
    <meta property="og:description" content="{{ (page.slogan or page.description)[:200] }}">
  {% endif %}
  {% if og_img %}
    <meta property="og:image" content="{{ og_img }}">
  {% endif %}
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:type" content="website">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <style>
    /* =========================================================
       BASE / VARIABLES — usa el color que viene del negocio
       ========================================================= */
    :root {
      --brand: {{ page.color and "'" ~ page.color ~ "'" or '#b52a2a' }}; /* si viene, se usa */
      --bg: #0b0d11;
      --bg-soft: #13161b;
      --card: rgba(19,22,27,.8);
      --card-strong: rgba(23,27,34,1);
      --ink: #f8fafc;
      --ink-soft: #c4cad4;
      --ink-muted: #7f8793;
      --line: rgba(248,249,250,.03);
      --radius: 16px;
      --shadow: 0 14px 40px rgba(0,0,0,.25);
    }

    html, body {
      background: radial-gradient(circle at 0% 0%, rgba(255,255,255,.03) 0%, #0b0d11 58%);
      color: var(--ink);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      scroll-behavior: smooth;
    }

    body {
      padding-bottom: 65px; /* para que no lo tape el aviso fijo */
    }

    .container-section { max-width: 1180px; }

    /* =========================================================
       NAV
       ========================================================= */
    #mainNavbar {
      background: rgba(9,10,12,.35);
      backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(248,249,250,.02);
    }
    #mainNavbar .nav-link {
      color: rgba(248,249,250,.85);
      font-weight: 500;
      font-size: .85rem;
      position:relative;
      padding-inline:.6rem;
    }
    #mainNavbar .nav-link::after{
      content:'';
      position:absolute;
      left:14px; right:14px; bottom:-10px;
      height:3px;
      background:linear-gradient(90deg, var(--brand), rgba(255,255,255,0));
      border-radius:99px;
      transform:scaleX(0);
      transform-origin:left;
      transition:.2s;
    }
    #mainNavbar .nav-link:hover,
    #mainNavbar .nav-link:focus,
    #mainNavbar .nav-link.active{color:#fff;}
    #mainNavbar .nav-link:hover::after,
    #mainNavbar .nav-link.active::after{transform:scaleX(1);}
    .navbar-brand {
      font-weight: 800;
      color:#fff;
      display:flex;
      align-items:center;
      gap:.4rem;
    }
    .navbar-brand small{
      font-size:.6rem;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.06);
      padding:.12rem .6rem;
      border-radius:999px;
    }

    /* =========================================================
       HERO
       ========================================================= */
    .hero{
      position:relative;
      padding:110px 0 80px;
      overflow:hidden;
      border-bottom:1px solid rgba(248,249,250,.015);
      {% if page.cover_image %}
      background:
        linear-gradient(130deg, rgba(11,13,17,1) 0%, rgba(11,13,17,.93) 60%, rgba(11,13,17,1) 100%),
        url('{{ url_for("uploaded_file", filename=page.cover_image) }}') center/cover no-repeat;
      {% else %}
      background: radial-gradient(circle at 0% 0%, color-mix(in srgb, var(--brand) 65%, #000 35%), #0b0d11 60%, #0b0d11 100%);
      {% endif %}
    }
    .barber-stripes{
      position:absolute;
      inset:0;
      background-image:repeating-linear-gradient(-45deg,
        rgba(181,42,42,.38) 0 20px,
        rgba(181,42,42,0) 20px 40px,
        rgba(31,92,227,.32) 40px 60px,
        rgba(31,92,227,0) 60px 80px
      );
      opacity:.1;
      mix-blend-mode:screen;
      pointer-events:none;
    }
    .hero-avatar{
      width:210px;
      height:210px;
      border-radius:999px;
      object-fit:cover;
      border:5px solid rgba(11,13,17,1);
      outline:1px solid rgba(248,249,250,.2);
      box-shadow:0 12px 35px rgba(0,0,0,.38);
      margin-inline:auto;
      background:#0b0d11;
    }
    .hero-pill{
      display:inline-flex;
      gap:.5rem;
      align-items:center;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(248,249,250,.08);
      border-radius:999px;
      padding:.35rem .85rem;
      font-size:.68rem;
      letter-spacing:.05em;
      text-transform:uppercase;
    }
    .hero-title{
      font-weight:800;
      letter-spacing:-.01em;
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      align-items:center;
    }
    .hero-sub{
      color:rgba(248,249,250,.7);
      max-width:520px;
      line-height:1.5;
    }
    .btn-brand{
      background:var(--brand);
      border:none;
      border-radius:999px;
      color:#fff;
      padding:.6rem 1.25rem;
      font-weight:600;
      display:inline-flex;
      gap:.5rem;
      align-items:center;
    }
    .btn-soft{
      background:rgba(248,249,250,.06);
      border:1px solid rgba(248,249,250,.03);
      border-radius:999px;
      color:#fff;
      padding:.6rem 1.2rem;
      display:inline-flex;
      gap:.4rem;
      align-items:center;
    }

    /* =========================================================
       SECCIONES
       ========================================================= */
    section[id]{
      padding-top:3.1rem;
      padding-bottom:3.1rem;
    }

    /* =========================================================
       CARDS CON AIRE
       ========================================================= */
    .card-soft{
      background:var(--card);
      border:1px solid rgba(248,249,250,.03);
      border-radius:var(--radius);
      box-shadow:none;
      display:flex;
      flex-direction:column;
    }
    .card-soft > * + *{margin-top:.8rem;}
    .card-soft p{
      margin-bottom:.45rem;
      line-height:1.5;
    }
    .text-muted-2{color:var(--ink-muted);}

    /* =========================================================
       GALERÍA
       ========================================================= */
    .gallery-wrap{
      background:rgba(19,22,27,.5);
      border:1px solid rgba(248,249,250,.02);
      border-radius:14px;
      padding:1.1rem 1.2rem 1.25rem;
    }
    .gallery-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px,1fr));
      gap:.8rem;
    }
    .gal-item{
      position:relative;
      border-radius:12px;
      overflow:hidden;
      aspect-ratio:4/3;
      background:#0b0d11;
      border:1px solid rgba(248,249,250,.02);
      cursor:pointer;
      transition:.1s;
    }
    .gal-item:hover{transform:translateY(-2px);}
    .gal-item img,.gal-item video{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .gal-item span.badge{
      position:absolute;top:.4rem;left:.4rem;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(248,249,250,.2);
      border-radius:999px;
      font-size:.65rem;
    }
    @media(max-width:768px){
      .gallery-grid{display:flex;overflow-x:auto;gap:.8rem;scroll-snap-type:x mandatory;}
      .gal-item{flex:0 0 62vw;scroll-snap-align:start;}
    }

    /* =========================================================
       AVISOS BOTTOM (siempre)
       ========================================================= */
    .noticias-section{
      position:fixed;
      bottom:1rem;
      left:0;
      right:0;
      z-index:1200;
      background:transparent;
      pointer-events:none;
    }
    .noticias-inner{
      pointer-events:all;
      background:rgba(11,13,17,.92);
      border:1px solid rgba(248,249,250,.04);
      backdrop-filter:blur(16px);
      border-radius:999px;
      padding:.35rem .65rem .35rem 1rem;
      display:flex;
      align-items:center;
      gap:.65rem;
      width:fit-content;
      margin-inline:auto;
      min-height:42px;
    }
    .aviso-pill{
      background:transparent;
      border:0;
      border-radius:999px;
      display:inline-flex;
      gap:.4rem;
      align-items:center;
      color:#fff;
      font-size:.78rem;
      white-space:nowrap;
    }
    .aviso-close{
      width:26px;height:26px;
      border-radius:999px;
      border:1px solid rgba(248,249,250,.12);
      background:rgba(0,0,0,.1);
      display:grid;place-items:center;
      cursor:pointer;
    }

    /* =========================================================
       PRODUCTOS / SERVICIOS
       ========================================================= */
    .product-card{
      background:var(--card-strong);
      border:1px solid rgba(248,249,250,.025);
      border-radius:14px;
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .product-card img{border-radius:14px 14px 0 0;}
    .product-card .p-3{
      display:flex;
      flex-direction:column;
      gap:.5rem;
      height:100%;
    }
    .badge-tag{
      background:rgba(0,0,0,.28);
      border:1px solid rgba(248,249,250,.02);
      border-radius:999px;
      font-size:.6rem;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .form-control,.form-select,.form-control-sm{
      background:rgba(0,0,0,.18);
      border:1px solid rgba(248,249,250,.02);
      color:#fff;
      border-radius:10px;
    }
    .form-control:focus{border-color:rgba(248,249,250,.1);box-shadow:none;}

    /* =========================================================
       RESEÑAS BONITAS
       ========================================================= */
    .reviews-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:1rem;
    }
    .review-card{
      background:rgba(19,22,27,.35);
      border:1px solid rgba(248,249,250,.02);
      border-radius:14px;
      padding:1rem .95rem 1rem;
      display:flex;
      gap:.8rem;
    }
    .review-avatar{
      width:44px;height:44px;border-radius:999px;
      background:color-mix(in srgb, var(--brand) 70%, #000 30%);
      display:grid;place-items:center;
      font-weight:700;
      color:#0b0d11;
      text-transform:uppercase;
      color: white;
    }
    .review-body > * + *{margin-top:.4rem;}
    .review-stars i{font-size:.8rem;}
    .review-date{font-size:.68rem;color:rgba(248,249,250,.42);}
    .review-empty{
      background:rgba(248,249,250,.02);
      border:1px solid rgba(248,249,250,.01);
      border-radius:14px;
      padding:1.2rem;
      text-align:center;
      color:var(--ink-muted);
    }

    /* =========================================================
       WHATSAPP FLOAT
       ========================================================= */
    .wa-fab {
      position: fixed;
      bottom: 10%;
      left: 16px;
      z-index: 2000;
    }
    .wa-fab a {
      background: #25D366;
      color: #fff;
      border-radius: 999px;
      padding: .55rem .95rem;
      display: inline-flex;
      align-items: center;
      gap: .45rem;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 12px 20px rgba(37,211,102,.35);
    }

    /* FOOTER */
    footer{
      background:#090b0d;
      border-top:1px solid rgba(248,249,250,.02);
    }

    @media(max-width:991px){
      .hero{text-align:center;}
      .hero-sub{margin-inline:auto;}
      .wa-fab{left:1rem;bottom:10%;}
      .noticias-inner{max-width:92%;border-radius:18px;flex-wrap:wrap;justify-content:space-between;}
    }
  </style>
</head>
<body data-bs-spy="scroll" data-bs-target="#mainNavbar" data-bs-offset="80" tabindex="0">

  <!-- NAV -->
  <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="fa-solid fa-scissors"></i>
        {{ page.business_name or '' }}
        {% if page.founding_date %}
          <small>since {{ page.founding_date }}</small>
        {% endif %}
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navbarNav" class="collapse navbar-collapse justify-content-end">
        <ul class="navbar-nav gap-2">
          {% if page.description or services_list or pm_list or page.address %}
            <li class="nav-item"><a class="nav-link" href="#info">Info</a></li>
          {% endif %}
          {% if page.cover_image or (page.media_gallery and page.media_gallery|length > 0) or (galeria and galeria|length>0) %}
            <li class="nav-item"><a class="nav-link" href="#galeria">Galería</a></li>
          {% endif %}
          {% if posts %}
            <li class="nav-item"><a class="nav-link" href="#publicaciones">Blog</a></li>
          {% endif %}
          {% if (servicios and servicios|length>0) or (productos_fisicos and productos_fisicos|length>0) %}
            <li class="nav-item"><a class="nav-link" href="#productos">Servicios</a></li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="#reservar">Reservar</a></li>
          {% if reseñas %}
            <li class="nav-item"><a class="nav-link" href="#reseñas">Reseñas</a></li>
          {% endif %}
          <li class="nav-item"><a class="nav-link" href="#contacto">Contacto</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- AVISOS (siempre) -->
  <div class="noticias-section" id="avisosShell">
    <div class="noticias-inner">
      <i class="bi bi-megaphone-fill text-warning"></i>

      {% if avisos and avisos|length > 0 %}
        <div id="noticiasCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="5500">
          <div class="carousel-inner">
            {% for aviso in avisos %}
            <div class="carousel-item {% if loop.first %}active{% endif %}">
              <span class="aviso-pill">
                {% if aviso.title %}<strong>{{ aviso.title }}</strong>{% endif %}
                {% if aviso.content %} — {{ aviso.content }}{% endif %}
              </span>
            </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <span class="aviso-pill">Sin avisos registrados.</span>
      {% endif %}

      <button type="button" class="aviso-close" id="avisoCloseBtn">
        <i class="bi bi-x-lg" style="font-size:.6rem; color: white;"></i>
      </button>
    </div>
  </div>

  <!-- HERO -->
  <header class="hero">
    <div class="barber-stripes"></div>
    <div class="container container-section">
      <div class="row align-items-center g-4">
        <div class="col-md-4 text-center text-md-start">
          {% if page.image %}
            <img src="{{ url_for('uploaded_file', filename=page.image) }}" alt="{{ page.business_name or '' }}" class="hero-avatar">
          {% endif %}
        </div>
        <div class="col-md-8">
          {% if page.slogan %}
          <div class="hero-pill mb-2">
            <i class="fa-solid fa-scissors"></i> {{ page.slogan }}
          </div>
          {% endif %}
          {% if page.business_name %}
          <h1 class="hero-title display-6 mb-1">
            {{ page.business_name }}
          </h1>
          {% endif %}
          {% if page.description %}
            <p class="hero-sub mb-3">{{ page.description }}</p>
          {% endif %}
          <div class="d-flex flex-wrap gap-2">
            <a href="#reservar" class="btn-brand"><i class="bi bi-calendar-week"></i> Reservar</a>
            {% if (servicios and servicios|length) or (productos_fisicos and productos_fisicos|length) %}
              <a href="#productos" class="btn-soft"><i class="bi bi-list-stars"></i> Ver servicios</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- INFO -->
  {% if page.description or services_list or pm_list or page.address or page.operating_hours %}
  <section id="info" class="container container-section py-5">
    <div class="row g-4">
      {% if page.description or services_list or pm_list %}
      <div class="col-md-6">
        <div class="card-soft h-100 p-3">
          {% if page.description %}<h2 class="h6 d-flex gap-2 align-items-center"><i class="bi bi-info-circle text-danger"></i> Información</h2>{% endif %}
          {% if page.description %}
            <p class="text-muted-2">{{ page.description }}</p>
          {% endif %}

          {% if services_list %}
            <div>
              <p class="mb-2 fw-semibold small text-uppercase text-muted-2">Servicios</p>
              <div class="d-flex flex-wrap gap-2">
                {% for s in services_list %}
                  <span class="badge bg-light text-dark border-0">{{ s }}</span>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          {% if pm_list %}
            <div>
              <p class="mb-2 fw-semibold small text-uppercase text-muted-2 mt-3">Métodos de pago</p>
              <div class="d-flex flex-wrap gap-2">
                {% for p in pm_list %}
                  <span class="badge" style="background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.1);">{{ p }}</span>
                {% endfor %}
              </div>
            </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      {% if page.address or page.city or page.state or page.operating_hours or (page.lat is not none and page.lng is not none) %}
      <div class="col-md-6">
        <div class="card-soft h-100 p-3">
          <h2 class="h6 d-flex gap-2 align-items-center"><i class="bi bi-geo-alt text-primary"></i> Ubicación y horario</h2>
          {% if page.address %}<p class="mb-1">{{ page.address }}</p>{% endif %}
          {% if page.city or page.state %}
            <p class="mb-1">
              {% if page.city %}{{ page.city }}{% endif %}
              {% if page.state %}{{ ', ' ~ page.state }}{% endif %}
            </p>
          {% endif %}
          {% if page.postal_code %}
            <p class="mb-1">CP: {{ page.postal_code }}</p>
          {% endif %}
          {% if page.operating_hours %}
            <p class="mb-0 text-muted-2">Horario: {{ page.operating_hours }}</p>
          {% endif %}

          {% set has_coords = page.lat is not none and page.lng is not none %}
          {% if has_coords %}
            <div id="map" class="mt-3" style="height:240px;border-radius:14px;overflow:hidden;"></div>
            <a class="btn-soft mt-3" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ page.lat }},{{ page.lng }}">
              <i class="bi bi-geo"></i> Cómo llegar
            </a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- GALERÍA -->
  {% set tiene_portada = page.cover_image %}
  {% set tiene_media = page.media_gallery and page.media_gallery|length > 0 %}
  {% set tiene_galeria = galeria and galeria|length > 0 %}
  {% if tiene_portada or tiene_media or tiene_galeria %}
  <section id="galeria" class="container container-section pb-5">
    <h2 class="h5 mb-3">Galería</h2>
    <div class="gallery-wrap">
      <div class="gallery-grid">
        {% if tiene_portada %}
        <div class="gal-item img-zoom-trigger" data-img-src="{{ url_for('uploaded_file', filename=page.cover_image) }}">
          <img src="{{ url_for('uploaded_file', filename=page.cover_image) }}" alt="Portada">
          <span class="badge"><i class="bi bi-star-fill"></i> Portada</span>
        </div>
        {% endif %}

        {% if tiene_media %}
          {% for item in page.media_gallery %}
            {% if item is string %}
              <div class="gal-item img-zoom-trigger" data-img-src="{{ url_for('uploaded_file', filename=item) }}">
                <img src="{{ url_for('uploaded_file', filename=item) }}" alt="Media">
              </div>
            {% else %}
              {% set fpath = item.path %}
              {% if item.type == 'video' %}
              <div class="gal-item">
                <video src="{{ url_for('uploaded_file', filename=fpath) }}" muted playsinline></video>
                <span class="badge"><i class="bi bi-camera-reels"></i> Video</span>
              </div>
              {% else %}
              <div class="gal-item img-zoom-trigger" data-img-src="{{ url_for('uploaded_file', filename=fpath) }}">
                <img src="{{ url_for('uploaded_file', filename=fpath) }}" alt="Media">
              </div>
              {% endif %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {% if tiene_galeria %}
          {% for g in (galeria or [])[:12] %}
          <div class="gal-item img-zoom-trigger" data-img-src="{{ url_for('uploaded_file', filename=g) }}">
            <img src="{{ url_for('uploaded_file', filename=g) }}" alt="Foto {{ loop.index }}">
          </div>
          {% endfor %}
        {% endif %}
      </div>
    </div>
  </section>
  {% endif %}

  <!-- PUBLICACIONES -->
  {% if posts and posts|length > 0 %}
  <section id="publicaciones" class="container container-section pb-5">
    <h2 class="h5 mb-3">Publicaciones recientes</h2>
    <div class="row g-4">
      {% for post in posts %}
      <div class="col-md-4">
        <article class="card-soft h-100 p-0">
          {% if post.cabecera %}
            <img src="{{ url_for('uploaded_file', filename=post.cabecera) }}" class="w-100 img-zoom-trigger" style="height:170px;object-fit:cover;" data-img-src="{{ url_for('uploaded_file', filename=post.cabecera) }}">
          {% endif %}
          <div class="p-3 d-flex flex-column gap-2 h-100">
            <h3 class="h6 mb-0">{{ post.title }}</h3>
            {% if post.content %}
              <p class="text-muted-2 mb-0">{{ post.content[:110] }}...</p>
            {% endif %}
            <a href="{{ url_for('ver_post', post_id=post._id) }}" class="btn-soft mt-auto">Leer más</a>
          </div>
        </article>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- SERVICIOS / PRODUCTOS -->
  {% if (servicios and servicios|length>0) or (productos_fisicos and productos_fisicos|length>0) %}
  <section id="productos" class="container container-section pb-5">
    <h2 class="h5 mb-3">Servicios / Productos</h2>
    <form id="form-cotizar" class="row g-3 g-md-4">
      {% if servicios and servicios|length>0 %}
      <div class="col-12"><p class="small text-muted-2 mb-1 text-uppercase">Servicios</p></div>
      {% for item in servicios %}
      <div class="col-md-4 col-sm-6">
        <div class="product-card h-100">
          {% if item.image %}
            <img src="{{ url_for('uploaded_file', filename=item.image) }}" alt="{{ item.title }}" class="img-fluid img-zoom-trigger" style="height:200px;object-fit:cover;" data-img-src="{{ url_for('uploaded_file', filename=item.image) }}">
          {% endif %}
          <div class="p-3">
            <div class="d-flex justify-content-between gap-2 align-items-start">
              <h6 class="mb-0">{{ item.title }}</h6>
              <span class="badge-tag">Servicio</span>
            </div>
            {% if item.description %}
              <p class="small text-muted-2 mb-0">{{ item.description }}</p>
            {% endif %}
            {% if item.show_price %}
              <span class="badge bg-success bg-opacity-75 mt-1"> ${{ "%.2f"|format(item.price) }} </span>
            {% endif %}
            <div class="mt-auto pt-2">
              <label class="small text-muted-2 mb-1">Cantidad</label>
              <input type="number" min="0" value="0" class="form-control form-control-sm"
                     name="prod_{{ item.title | replace(' ','_') }}"
                     data-item-nombre="{{ item.title }}">
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% endif %}

      {% if productos_fisicos and productos_fisicos|length>0 %}
      <div class="col-12 mt-2"><p class="small text-muted-2 mb-1 text-uppercase">Productos</p></div>
      {% for item in productos_fisicos %}
      <div class="col-md-4 col-sm-6">
        <div class="product-card h-100">
          {% if item.image %}
            <img src="{{ url_for('uploaded_file', filename=item.image) }}" alt="{{ item.title }}" class="img-fluid img-zoom-trigger" style="height:200px;object-fit:cover;" data-img-src="{{ url_for('uploaded_file', filename=item.image) }}">
          {% endif %}
          <div class="p-3">
            <div class="d-flex justify-content-between gap-2 align-items-start">
              <h6 class="mb-0">{{ item.title }}</h6>
              <span class="badge-tag">Producto</span>
            </div>
            {% if item.description %}
              <p class="small text-muted-2 mb-0">{{ item.description }}</p>
            {% endif %}
            {% if item.show_price %}
              <span class="badge bg-success bg-opacity-75 mt-1"> ${{ "%.2f"|format(item.price) }} </span>
            {% endif %}
            <div class="mt-auto pt-2">
              <label class="small text-muted-2 mb-1">Cantidad</label>
              <input type="number" min="0" value="0" class="form-control form-control-sm"
                     name="prod_{{ item.title | replace(' ','_') }}"
                     data-item-nombre="{{ item.title }}">
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
      {% endif %}

      <div class="col-12 text-center mt-2">
        {% if page.whatsapp %}
          <button type="submit" class="btn-brand px-4"><i class="bi bi-whatsapp"></i> Cotizar</button>
        {% else %}
          <button type="submit" class="btn-brand px-4">Cotizar</button>
        {% endif %}
      </div>
    </form>

    <!-- Modal Cotizar -->
    <div class="modal fade" id="cotizarModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background:var(--card);border:1px solid rgba(248,249,250,.03);">
          <div class="modal-header border-0">
            <h5 class="modal-title">Antes de cotizar</h5>
            <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted-2 small mb-2">Escribe tu nombre.</p>
            <input type="text" id="nombreClienteInput" class="form-control mb-2">
            <div id="errorModalNombre" class="text-danger small d-none mb-2">Escribe tu nombre 🙏</div>
            <p class="text-muted-2 small mb-1">Tu selección:</p>
            <div id="resumenSeleccion" class="p-2 rounded" style="background:rgba(0,0,0,.08);max-height:200px;overflow-y:auto;"></div>
          </div>
          <div class="modal-footer border-0">
            <button class="btn btn-outline-light" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn-brand" id="enviarCotizacionBtn"><i class="bi bi-whatsapp"></i> Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Zoom (galería/productos) -->
    <div class="modal fade" id="zoomModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" style="max-width: 850px;">
        <div class="modal-content bg-transparent border-0">
          <img id="zoomedImage" src="" class="img-fluid rounded" alt="">
        </div>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- FAB WhatsApp -->
  {% if page.whatsapp %}
  <div class="wa-fab">
    <a href="https://wa.me/{{ page.whatsapp | replace(' ','') }}" target="_blank">
      <i class="bi bi-whatsapp"></i>
      <span class="d-none d-md-inline">WhatsApp</span>
    </a>
  </div>
  {% endif %}

  <!-- RESERVA -->
  <section id="reservar" class="container container-section pb-5">
    <div class="row g-4 align-items-center">
      <div class="col-lg-5">
        <h2 class="h5 mb-2">Reserva tu lugar</h2>
        {% if page.business_name %}
          <p class="text-muted-2 mb-3">En {{ page.business_name }} puedes reservar y te contestamos por WhatsApp.</p>
        {% endif %}
      </div>
      <div class="col-lg-7">
        <div class="card-soft p-4">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small">Tu nombre</label>
              <input type="text" id="reservaNombre" class="form-control">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label small">Fecha</label>
              <input type="date" id="reservaFecha" class="form-control">
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label small">Hora</label>
              <input type="time" id="reservaHora" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label small">Servicio</label>
              <select id="reservaServicio" class="form-select">
                <option value="">Selecciona</option>
                {% if servicios %}
                  {% for s in servicios %}
                    <option value="{{ s.title }}">{{ s.title }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
            <div class="col-md-3 col-6">
              <label class="form-label small">Personas</label>
              <input type="number" id="reservaPersonas" class="form-control" min="1" value="1">
            </div>
            <div class="col-12">
              <label class="form-label small">Mensaje / detalle</label>
              <textarea id="reservaMensaje" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-12 d-flex gap-2">
              <button id="btnEnviarReserva" class="btn-brand flex-grow-1"><i class="bi bi-whatsapp"></i> Enviar reserva</button>
              <button type="reset" class="btn-soft" onclick="document.getElementById('reservaNombre').value='';document.getElementById('reservaMensaje').value='';">Limpiar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- RESEÑAS -->
  <section id="reseñas" class="container container-section pb-5">
    <div class="card-soft mb-4 p-4">
      <h3 class="h5 mb-3">Deja tu reseña</h3>
      {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info">
          {% for m in messages %}<div>{{ m }}</div>{% endfor %}
        </div>
        {% endif %}
      {% endwith %}
      <form method="POST">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label small">Tu nombre</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label small d-block">Calificación</label>
            <div id="starRating">
              {% for i in range(1,6) %}
                <i class="bi bi-star-fill fs-4 me-1 text-secondary star-icon" data-value="{{ i }}"></i>
              {% endfor %}
            </div>
            <input type="hidden" name="estrellas" id="estrellas" value="0" required>
          </div>
          <div class="col-12">
            <label class="form-label small">Comentario</label>
            <textarea name="comentario" rows="3" class="form-control" required></textarea>
          </div>
          <div class="col-12">
            <button class="btn-brand" type="submit"><i class="bi bi-send"></i> Enviar</button>
          </div>
        </div>
      </form>
    </div>

    {% if reseñas and reseñas|length > 0 %}
    <div class="reviews-grid">
      {% for r in reseñas %}
      <div class="review-card">
        <div class="review-avatar">
          {{ r.nombre[:1]|upper if r.nombre }}
        </div>
        <div class="review-body">
          {% if r.nombre %}<h6 class="mb-0">{{ r.nombre }}</h6>{% endif %}
          <div class="review-stars">
            {% for i in range(1,6) %}
              {% if r.estrellas and i <= r.estrellas %}
                <i class="bi bi-star-fill text-warning"></i>
              {% else %}
                <i class="bi bi-star text-secondary"></i>
              {% endif %}
            {% endfor %}
          </div>
          {% if r.comentario %}
            <p class="mb-0 text-muted-2">{{ r.comentario }}</p>
          {% endif %}
          {% if r.fecha %}
            <div class="review-date">{{ r.fecha.strftime('%d/%m/%Y') }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="review-empty mt-3">Aún no hay reseñas.</div>
    {% endif %}
  </section>

  <!-- CONTACTO -->
  <section id="contacto" class="container container-section pb-5">
    <h2 class="h5 mb-3">Contacto</h2>
    <div class="row g-4">
      {% if page.phone or page.email or page.website %}
      <div class="col-md-6">
        <div class="card-soft p-3">
          {% if page.phone %}<p class="mb-1"><i class="fas fa-phone me-2 text-success"></i>{{ page.phone }}</p>{% endif %}
          {% if page.email %}<p class="mb-1"><i class="fas fa-envelope me-2 text-danger"></i>{{ page.email }}</p>{% endif %}
          {% if page.website %}<p class="mb-0"><i class="fas fa-globe me-2 text-primary"></i><a href="{{ page.website }}" target="_blank" class="text-light text-decoration-none">{{ page.website }}</a></p>{% endif %}
        </div>
      </div>
      {% endif %}
      {% if page.facebook or page.instagram or page.tiktok %}
      <div class="col-md-6">
        <div class="card-soft p-3">
          {% if page.facebook %}<p class="mb-1"><i class="fab fa-facebook me-2 text-primary"></i><a href="{{ page.facebook }}" target="_blank" class="text-light text-decoration-none">Facebook</a></p>{% endif %}
          {% if page.instagram %}<p class="mb-1"><i class="fab fa-instagram me-2 text-danger"></i><a href="{{ page.instagram }}" target="_blank" class="text-light text-decoration-none">Instagram</a></p>{% endif %}
          {% if page.tiktok %}<p class="mb-0"><i class="fab fa-tiktok me-2"></i><a href="{{ page.tiktok }}" target="_blank" class="text-light text-decoration-none">TikTok</a></p>{% endif %}
        </div>
      </div>
      {% endif %}
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="py-4">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
      {% if page.business_name %}
        <p class="mb-0 small text-muted-2">&copy; 2025 {{ page.business_name }}.</p>
      {% else %}
        <p class="mb-0 small text-muted-2">&copy; 2025.</p>
      {% endif %}
    </div>
  </footer>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
    // cerrar avisos
    const avisoCloseBtn = document.getElementById('avisoCloseBtn');
    const avisosShell = document.getElementById('avisosShell');
    if (avisoCloseBtn && avisosShell) {
      avisoCloseBtn.addEventListener('click', () => {
        avisosShell.style.opacity = '0';
        avisosShell.style.pointerEvents = 'none';
        setTimeout(() => avisosShell.style.display = 'none', 250);
      });
    }

    // zoom imagen
    document.querySelectorAll('.img-zoom-trigger').forEach(el => {
      el.addEventListener('click', () => {
        const src = el.getAttribute('data-img-src');
        const modal = document.getElementById('zoomModal');
        const img = document.getElementById('zoomedImage');
        if (img && src) img.src = src;
        if (modal) new bootstrap.Modal(modal).show();
      });
    });

    // mapa
    (function(){
      const lat = {{ page.lat is not none and page.lat or 'null' }};
      const lng = {{ page.lng is not none and page.lng or 'null' }};
      if (lat !== null && lng !== null){
        const map = L.map('map', {scrollWheelZoom:false}).setView([lat,lng], 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);
        L.marker([lat,lng]).addTo(map).bindPopup(`{{ page.business_name|e if page.business_name }}`);
        setTimeout(()=>map.invalidateSize(), 300);
      }
    })();

    // estrellas reseñas
    const stars = document.querySelectorAll('#starRating .star-icon');
    const estrellasInput = document.getElementById('estrellas');
    if (stars.length && estrellasInput) {
      stars.forEach(star => {
        star.addEventListener('click', () => {
          const val = parseInt(star.dataset.value);
          estrellasInput.value = val;
          stars.forEach(s => s.classList.remove('text-warning'));
          stars.forEach(s => s.classList.add('text-secondary'));
          for (let i = 0; i < val; i++) {
            stars[i].classList.remove('text-secondary');
            stars[i].classList.add('text-warning');
          }
        });
      });
    }

    // cotizar
    const formCotizar = document.getElementById('form-cotizar');
    const cotizarModal = document.getElementById('cotizarModal');
    const resumenSeleccion = document.getElementById('resumenSeleccion');
    const nombreClienteInput = document.getElementById('nombreClienteInput');
    const errorModalNombre = document.getElementById('errorModalNombre');
    const enviarCotizacionBtn = document.getElementById('enviarCotizacionBtn');
    let cotizacionLineas = [];

    if(formCotizar){
      formCotizar.addEventListener('submit', (e)=>{
        e.preventDefault();
        cotizacionLineas = [];
        formCotizar.querySelectorAll('input[type="number"]').forEach(inp=>{
          const qty = parseInt(inp.value);
          if(qty > 0){
            const nombre = inp.dataset.itemNombre || inp.name.replace('prod_','').replace(/_/g,' ');
            cotizacionLineas.push(`- ${nombre}: ${qty}`);
          }
        });
        if(!cotizacionLineas.length){
          alert('Ingresa al menos una cantidad 🙏');
          return;
        }
        resumenSeleccion.innerHTML = cotizacionLineas.map(l=>`<div>${l}</div>`).join('');
        errorModalNombre.classList.add('d-none');
        new bootstrap.Modal(cotizarModal).show();
        setTimeout(()=>nombreClienteInput.focus(), 250);
      });
    }

    if(enviarCotizacionBtn){
      enviarCotizacionBtn.addEventListener('click', ()=>{
        const nombre = (nombreClienteInput.value || '').trim();
        if(!nombre){
          errorModalNombre.classList.remove('d-none');
          return;
        }
        const whatsappNumber = "{{ page.whatsapp | replace(' ', '') if page.whatsapp }}";
        let mensaje = `Hola, soy ${nombre} y quiero cotizar:%0A`;
        cotizacionLineas.forEach(l=>{mensaje += encodeURIComponent(l) + "%0A";});
        if(whatsappNumber){
          window.open(`https://wa.me/${whatsappNumber}?text=${mensaje}`, '_blank');
        } else {
          alert('No hay WhatsApp configurado en este negocio.');
        }
      });
    }

    // reserva a WhatsApp
    const btnEnviarReserva = document.getElementById('btnEnviarReserva');
    if(btnEnviarReserva){
      btnEnviarReserva.addEventListener('click', ()=>{
        const nombre = (document.getElementById('reservaNombre').value || '').trim();
        const fecha = document.getElementById('reservaFecha').value;
        const hora = document.getElementById('reservaHora').value;
        const servicio = document.getElementById('reservaServicio').value;
        const personas = document.getElementById('reservaPersonas').value || '1';
        const mensaje = (document.getElementById('reservaMensaje').value || '').trim();
        const wa = "{{ page.whatsapp | replace(' ', '') if page.whatsapp }}";
        if(!wa){ alert('No hay WhatsApp configurado 🙏'); return; }
        if(!nombre){ alert('Escribe tu nombre 🙏'); return; }

        let txt = `Hola, soy ${encodeURIComponent(nombre)} y quiero hacer una reserva.%0A`;
        if(fecha) txt += `📅 Fecha: ${encodeURIComponent(fecha)}%0A`;
        if(hora) txt += `⏰ Hora: ${encodeURIComponent(hora)}%0A`;
        if(servicio) txt += `✂️ Servicio: ${encodeURIComponent(servicio)}%0A`;
        if(personas) txt += `👥 Personas: ${encodeURIComponent(personas)}%0A`;
        if(mensaje) txt += `📝 Detalle: ${encodeURIComponent(mensaje)}%0A`;

        window.open(`https://wa.me/${wa}?text=${txt}`, '_blank');
      });
    }
  </script>
</body>
</html>
