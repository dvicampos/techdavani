<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{{ page.get('business_name','') }}</title>
  <meta name="description" content="{{ page.get('description','')[:160] }}">
  <meta name="keywords" content="{{ page.get('category','') }}">
  <meta name="author" content="{{ page.get('business_name','') }}">

  <!-- OG / Twitter (solo si hay imagen configurada) -->
  <meta property="og:title" content="{{ page.get('business_name','') }}">
  <meta property="og:description" content="{{ page.get('slogan') or page.get('description','')[:200] }}">
  {% if page.get('image') %}
    <meta property="og:image" content="{{ url_for('uploaded_file', filename=page['image']) }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="{{ url_for('uploaded_file', filename=page['image']) }}">
  {% endif %}
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:type" content="website">

  <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root{
      --brand: {{ page.get('color') or '#111827' }};
      --accent:#ef4444;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --bg:#0b0d10;
      --card:#111418;
      --radius:18px;
      --shadow:0 18px 40px rgba(0,0,0,.25);
      --map-h: clamp(260px, 42vh, 520px);
      --section-gap: clamp(1.25rem, 2vw + .5rem, 3rem);
      --container-pad: clamp(12px, 2vw, 24px);
    }

    /* Base */
    html {scroll-behavior: smooth;}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.55;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }
    a{text-decoration:none}
    img{max-width:100%; height:auto; display:block}

    .container { padding-left: var(--container-pad); padding-right: var(--container-pad); }

    h1,h2,h3,.display-5{ letter-spacing:-.02em; }
    h1,.display-5{font-size: clamp(1.8rem, 2.4vw + 1.1rem, 3rem);}
    h2{font-size: clamp(1.25rem, 1.2vw + 1rem, 2rem);}
    h3{font-size: clamp(1.1rem, .9vw + .95rem, 1.6rem);}

    section { margin-top: var(--section-gap); margin-bottom: var(--section-gap); }

    [id] { scroll-margin-top: 84px; }

    :focus-visible{
      outline:2px solid #93c5fd;
      outline-offset:2px;
      border-radius:8px;
    }

    /* Top announcement bar */
    .topbar{
      background:linear-gradient(90deg, var(--brand), #0b0d10);
      border-bottom:1px solid rgba(229,231,235,.08)
    }
    .topbar .pill{
      display:inline-flex; gap:.5rem; align-items:center;
      padding:.25rem .6rem; border-radius:999px;
      border:1px dashed rgba(255,255,255,.35); color:#fff
    }

    /* Navbar */
    .nav-glass{
      position:sticky; top:0; z-index:1020;
      background:linear-gradient(90deg, rgba(17,24,39,.85), rgba(17,24,39,.65));
      backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(229,231,235,.08)
    }
    .navbar-brand{font-weight:800; letter-spacing:.3px}
    .nav-link{color:#cbd5e1!important}
    .nav-link:hover{color:#fff!important}
    .offcanvas{
      background: #0d1116;
      border-left:1px solid rgba(229,231,235,.08)
    }

    /* Chips */
    .chips{display:flex; gap:.5rem; flex-wrap:wrap}
    @media (max-width: 576px){
      .chips{
        flex-wrap:nowrap; overflow:auto; -webkit-overflow-scrolling:touch; padding-bottom:.25rem;
        scrollbar-width:none;
      }
      .chips::-webkit-scrollbar{display:none}
    }
    .chip{
      border:1px solid rgba(229,231,235,.18);
      color:#e5e7eb; padding:.35rem .75rem; border-radius:999px; background:#0f1318; white-space:nowrap
    }
    .chip.active{background:#e5e7eb;color:#0b0d10;font-weight:700}

    /* Hero */
    .hero{
      position:relative; overflow:hidden; border-radius:0 0 28px 28px; 
      background:
        radial-gradient(900px 420px at 90% -10%, rgba(239,68,68,.16), transparent 60%),
        radial-gradient(700px 360px at 10% -20%, rgba(59,130,246,.14), transparent 60%),
        linear-gradient(180deg, #0b0d10, #0d0f13 55%, #0b0d10)
    }
    .title{font-weight:900; line-height:1.05}
    .cta{
      display:inline-flex; gap:.6rem; align-items:center;
      background:var(--accent); color:#fff; border:none;
      padding:.9rem 1.2rem; border-radius:999px; font-weight:700;
      box-shadow:0 14px 34px rgba(239,68,68,.25)
    }
    .cta:hover{transform:translateY(-2px)}
    .hero-img{
      width:100%; aspect-ratio: 16/10; object-fit:cover;
      border-radius:20px; border:1px solid rgba(229,231,235,.08);
      box-shadow:0 30px 80px rgba(0,0,0,.45)
    }
    .hero-badge{
      position:absolute; right:2%; top:14%;
      background:#111827; border:1px solid rgba(229,231,235,.08);
      padding:.7rem .9rem; border-radius:14px
    }
    @media (max-width: 576px){
      .hero-badge{ position:static; margin-top:.75rem; width:max-content }
    }

    /* Productos grid */
    .grid{
      display:grid; gap:18px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    @media (min-width:1440px){
      .grid{ gap:22px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); }
    }

    .card-prod{
      background:var(--card); border:1px solid rgba(229,231,235,.08);
      border-radius:var(--radius); overflow:hidden;
      transition:transform .14s ease, box-shadow .14s ease, border-color .14s ease
    }
    .card-prod:hover{transform:translateY(-3px); box-shadow:var(--shadow); border-color:rgba(229,231,235,.18)}
    .prod-media{position:relative}
    .prod-tag{
      position:absolute; left:10px; top:10px; background:#0b0d10;
      border:1px solid rgba(229,231,235,.12); padding:.25rem .45rem; border-radius:8px; font-size:.78rem
    }
    .prod-img{width:100%; aspect-ratio: 4/3; object-fit:cover}
    .prod-body{padding:14px}
    .prod-title{
      font-weight:700; color:#fff; margin:0 0 4px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }
    .prod-price{color:#93c5fd; font-weight:800}
    .prod-old{color:#94a3b8; text-decoration:line-through; font-weight:600; margin-left:.5rem}
    .sizes{display:flex; gap:.35rem; flex-wrap:wrap}
    .size{border:1px solid rgba(229,231,235,.22); border-radius:10px; padding:.2rem .5rem; font-size:.85rem; color:#e5e7eb; cursor:pointer}
    .size.active{background:#e5e7eb; color:#0b0d10; font-weight:800}
    .btn-outline{border:1px solid rgba(229,231,235,.28); color:#e5e7eb; padding:.55rem .8rem; border-radius:12px; background:transparent; font-weight:700}
    .btn-primary{background:linear-gradient(90deg, var(--accent), #fb7185); color:#fff; border:none; padding:.55rem .9rem; border-radius:12px; font-weight:800}

    /* Acciones producto */
    .actions{ display:grid; grid-template-columns: 100%; gap:8px; align-items:center }
    @media (min-width: 421px){ .actions{ grid-template-columns: minmax(86px, 120px) 1fr auto } }
    .actions input[type=number]{ min-width:86px }

    /* Servicios */
    .service-card{
      background:var(--card);
      border:1px solid rgba(229,231,235,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      height:100%;
      padding:1rem 1.25rem;
    }
    .service-title{
      font-weight:700;
      color:var(--ink);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .service-price{
      font-weight:800;
      color:#93c5fd;
      white-space:nowrap;
    }
    .service-desc{
      color:var(--muted);
      font-size:.9rem;
      margin-top:.5rem;
      margin-bottom:1rem;
    }

    /* Highlights (info general) */
    .highlights{display:grid; gap:12px; grid-template-columns:repeat(12,1fr)}
    .hl{grid-column: span 12; background:rgba(255,255,255,.03); border:1px solid rgba(229,231,235,.08); border-radius:14px; padding:14px}
    @media(min-width: 768px){ .hl{grid-column: span 4} }
    .hl i{opacity:.85}

    /* Vis√≠tanos */
    .visit{background:linear-gradient(180deg, #0d0f13, #0b0d10)}
    #mapWrap{border:1px solid rgba(229,231,235,.08); border-radius:18px; overflow:hidden}
    #map{height: var(--map-h); min-height:260px}

    /* Tarjetas gen√©ricas */
    .card-review{background:var(--card); border:1px solid rgba(229,231,235,.08); border-radius:16px}

    /* Footer */
    footer{border-top:1px solid rgba(229,231,235,.08)}

    /* FAB */
    .fab-wa{
      position:fixed; right:18px; bottom:calc(18px + env(safe-area-inset-bottom)); z-index:1060;
    }

    @media (prefers-reduced-motion: reduce){
      * {animation: none!important; transition: none!important}
    }
  </style>
</head>
<body>

<!-- TOP ANNOUNCEMENT BAR -->
{% if avisos and avisos|length %}
<div class="topbar py-1">
  <div class="container d-flex align-items-center justify-content-center gap-2 flex-wrap">
    {% for a in avisos[:3] %}
      <span class="pill small"><i class="bi bi-megaphone"></i> <b>{{ a.title }}</b>{% if a.date %} ¬∑ {{ a.date.strftime("%d/%m/%Y") }}{% endif %}</span>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- NAV -->
<nav class="navbar navbar-dark navbar-expand-lg nav-glass">
  <div class="container">
    <a class="navbar-brand" href="/">{{ page.get('business_name','') }}</a>
    <button class="navbar-toggler border-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#navOff" aria-controls="navOff" aria-label="Abrir men√∫">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="navOff" aria-labelledby="navOffLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="navOffLabel">{{ page.get('business_name','') }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          {% if posts %}<li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#novedades">Novedades</a></li>{% endif %}
          {% if productos_fisicos %}<li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#productos">Productos</a></li>{% endif %}
          {% if servicios %}<li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#servicios">Servicios</a></li>{% endif %}
          <li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#info">Informaci√≥n</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#visitanos">Vis√≠tanos</a></li>
          <li class="nav-item"><a class="nav-link" data-bs-dismiss="offcanvas" href="#contacto">Contacto</a></li>
        </ul>
      </div>
    </div>
  </div>
</nav>

<!-- HERO -->
{% set has_hero_copy = page.get('slogan') or page.get('headline') or page.get('hero_text') %}
{% set has_hero_media = page.get('image') %}
{% if has_hero_copy or has_hero_media or (avisos and avisos|length) %}
<header class="hero" style="padding-top:42px">
  <div class="container py-5">
    <div class="row g-4 align-items-center">
      {% if has_hero_copy %}
      <div class="col-lg-6">
        {% if page.get('tagline') %}
          <div class="chips mb-2"><span class="chip">{{ page.tagline }}</span></div>
        {% endif %}

        {% if page.get('headline') %}
          <h1 class="title display-5 text-white">{{ page.headline }}</h1>
        {% elif page.get('slogan') %}
          <h1 class="title display-5 text-white">{{ page.slogan }}</h1>
        {% endif %}

        {% if page.get('hero_text') %}<p class="mt-2 text-secondary">{{ page.hero_text }}</p>{% endif %}

        {% if avisos and avisos|length %}
          <div class="chips mt-3">
            {% for a in avisos[:4] %}<span class="chip"><i class="bi bi-bell"></i> {{ a.title }}</span>{% endfor %}
          </div>
        {% endif %}

        <div class="d-flex gap-2 mt-3 flex-wrap">
          {% if productos_fisicos %}<a href="#productos" class="cta"><i class="bi bi-bag-heart"></i> Comprar</a>{% endif %}
          {% if posts %}<a href="#novedades" class="btn btn-outline">Novedades</a>{% endif %}
        </div>
      </div>
      {% endif %}

      {% if has_hero_media %}
      <div class="col-lg-6">
        <img class="hero-img" src="{{ url_for('uploaded_file', filename=page['image']) }}" alt="{{ page.get('business_name','') }}" loading="lazy" decoding="async"
             onerror="this.style.display='none'">
        {% if page.get('promo_code') or page.get('promo_note') %}
        <div class="hero-badge small">
          {% if page.get('promo_note') %}<div class="fw-bold">{{ page.promo_note }}</div>{% endif %}
          {% if page.get('promo_code') %}<div class="text-secondary">C√≥digo: <span class="text-white fw-bold">{{ page.promo_code }}</span></div>{% endif %}
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
</header>
{% endif %}

<!-- NOVEDADES -->
{% if posts and posts|length %}
<section id="novedades" class="container">
  <div class="d-flex align-items-end justify-content-between mb-3 flex-wrap gap-2">
    <h2 class="m-0">Novedades</h2>
    {% if posts|length > 3 and page.get('business_name') %}
      <a class="text-secondary" href="{{ url_for('lista_blogs_negocio', nombre=page.get('business_name',''), page=1) }}">Ver todo</a>
    {% endif %}
  </div>
  <div class="row g-3">
    {% for post in posts[:3] %}
    <div class="col-12 col-sm-6 col-md-4">
      <div class="card card-review h-100">
        {% if post.cabecera %}
          <img src="{{ url_for('uploaded_file', filename=post.cabecera) }}" class="card-img-top" style="aspect-ratio:16/10;object-fit:cover" alt="Post"
               loading="lazy" decoding="async" onerror="this.style.display='none'">
        {% endif %}
        <div class="card-body">
          <h6 class="fw-bold text-white">{{ post.title }}</h6>
          {% if post.content %}<p class="text-secondary small mb-3">{{ post.content[:120] }}{% if post.content|length>120 %}...{% endif %}</p>{% endif %}
          <a class="btn btn-outline btn-sm" href="{{ url_for('ver_post', post_id=post._id) }}">Leer m√°s</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

{% if productos_fisicos and productos_fisicos|length %}
<section id="productos" class="container">
  <div class="d-flex align-items-end justify-content-between mb-3 flex-wrap gap-2">
    <h2 class="m-0">Productos</h2>
    <div class="d-flex gap-2 align-items-center w-auto">
      <label class="text-secondary small d-none d-sm-inline" for="sort">Ordenar:</label>
      <select id="sort" class="form-select form-select-sm bg-dark text-white border-secondary">
        <option value="new">Recientes</option>
        <option value="low">Precio: menor a mayor</option>
        <option value="high">Precio: mayor a menor</option>
      </select>
    </div>
  </div>

  {# sacamos las categor√≠as desde productos_fisicos #}
  {% set cats = productos_fisicos | map(attribute='category') | list | select('string') | list %}
  {% set cats_unique = cats | unique | list if cats else [] %}
  {% if cats_unique and cats_unique|length > 1 %}
  <div class="chips mb-3" id="chips">
    <span class="chip active" data-cat="all">Todo</span>
    {% for c in cats_unique %}
      <span class="chip" data-cat="{{ c }}">{{ c }}</span>
    {% endfor %}
  </div>
  {% endif %}

  <!-- FORM de cotizaci√≥n -->
  <form id="cotizarForm">
    <div class="grid" id="prodGrid">
      {% for p in productos_fisicos %}
      <article class="card-prod" data-cat="{{ p.get('category','') }}">
        <div class="prod-media">
          {% if p.get('image') %}
            <img class="prod-img img-zoom-trigger"
                 data-bs-toggle="modal"
                 data-bs-target="#zoomModal"
                 data-img-src="{{ url_for('uploaded_file', filename=p.image) }}"
                 src="{{ url_for('uploaded_file', filename=p.image) }}"
                 alt="{{ p.title }}"
                 loading="lazy"
                 decoding="async"
                 onerror="this.closest('.prod-media').style.display='none'">
          {% endif %}
          {% if p.get('badge') %}
            <span class="prod-tag">{{ p.badge }}</span>
          {% endif %}
        </div>

        <div class="prod-body">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <h5 class="prod-title">{{ p.title }}</h5>
            <div class="text-end">
              {% if p.get('price') is not none %}
                <span class="prod-price">${{ '%.2f'|format(p.price) }}</span>
              {% endif %}
              {% if p.get('compare_at') is not none %}
                <span class="prod-old">${{ '%.2f'|format(p.compare_at) }}</span>
              {% endif %}
            </div>
          </div>

          {% if p.get('description') %}
          <p class="text-secondary small mb-2">
            {{ p.description[:90] }}{% if p.description|length>90 %}...{% endif %}
          </p>
          {% endif %}

          {% if p.get('sizes') and p.sizes|length %}
          <div class="sizes">
            {% for s in p.sizes %}
              <span class="size" role="button" tabindex="0" data-size="{{ s }}">{{ s }}</span>
            {% endfor %}
          </div>
          {% endif %}

          <!-- acciones -->
          <div class="actions">
            <input
              type="number"
              class="form-control form-control-sm bg-dark text-white border-secondary qty-input"
              min="0"
              value="0"
              name="qty_{{ loop.index }}"
            >
            <!-- sumar r√°pido -->
            <button
              type="button"
              class="btn btn-outline btn-sm w-100 add-btn"
            >+</button>

            {% if page.get('whatsapp') %}
            <!-- boton pedir solo este producto -->
            <button
              type="button"
              class="btn btn-primary btn-sm buy-btn"
              aria-label="Comprar por WhatsApp" data-track="click_whatsapp_fab"
            >
              <i class="bi bi-whatsapp"></i>
            </button>
            {% endif %}
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    {% if page.get('whatsapp') %}
    <div class="text-center mt-3">
      <button type="submit" class="btn btn-primary btn-lg" id="abrirCotizarModalBtn" data-track="click_whatsapp_fab">
        <i class="bi bi-whatsapp me-2"></i> Cotizar por WhatsApp
      </button>
    </div>
    {% endif %}
  </form>

  <!-- MODAL COTIZACI√ìN (pide nombre y muestra resumen) -->
  <div class="modal fade" id="cotizarModal" tabindex="-1" aria-labelledby="cotizarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content shadow">
        <div class="modal-header" style="background:linear-gradient(90deg, var(--accent), #fb7185); color:#fff;">
          <h5 class="modal-title" id="cotizarModalLabel">Antes de enviar ‚úçÔ∏è</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-3">
            Cu√©ntanos tu nombre para saber c√≥mo dirigirnos a ti cuando te respondamos por WhatsApp.
          </p>

          <div class="mb-3">
            <label for="nombreClienteInput" class="form-label">Tu nombre</label>
            <input
              type="text"
              class="form-control"
              id="nombreClienteInput"
              placeholder="Ej. Ana / Carlos Mart√≠nez"
            >
          </div>

          <label class="form-label small text-secondary">Resumen de tu solicitud</label>
          <div
            id="resumenSeleccion"
            class="bg-dark border border-secondary rounded p-2 small text-white"
            style="max-height:200px; overflow-y:auto;"
          ></div>

          <div class="text-danger small mt-2 d-none" id="errorModalNombre">
            Por favor escribe tu nombre üôè
          </div>
        </div>

        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-outline-brand" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-brand" id="enviarCotizacionBtn">
            <i class="bi bi-whatsapp me-1"></i> Enviar por WhatsApp
          </button>
        </div>
      </div>
    </div>
  </div>

</section>
{% endif %}

<!-- SERVICIOS (usa servicios) -->
{% if servicios and servicios|length %}
<section id="servicios" class="container">
  <div class="d-flex align-items-end justify-content-between mb-3 flex-wrap gap-2">
    <h2 class="m-0">Servicios</h2>
  </div>

  <div class="row g-4">
    {% for s in servicios %}
    <div class="col-md-6 col-lg-4 d-flex">
      <div class="service-card d-flex flex-column w-100">
        <div class="service-title">
          <span>{{ s.title }}</span>
          {% if s.get('show_price') %}
            <span class="service-price">${{ "%.2f"|format(s.price) }}</span>
          {% endif %}
        </div>

        {% if s.get('description') %}
          <div class="service-desc">{{ s.description }}</div>
        {% endif %}

        {% if page.get('whatsapp') %}
          <a class="btn btn-outline w-100 mt-auto"
             href="https://wa.me/{{ page.whatsapp | replace(' ','') }}?text={{ ('Hola, me interesa el servicio: ' ~ s.title)|urlencode }}"
             target="_blank" data-track="click_whatsapp_fab">
            <i class="bi bi-whatsapp me-1"></i> Preguntar por WhatsApp
          </a>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}
{% if promos and promos|length > 0 %}
<section class="container my-4" id="promos">
  <h2 class="section-title brand-font">Promos activas</h2>
  <div class="row g-3">
    {% for p in promos %}
      <div class="col-md-6">
        <div class="card card-brutal h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>{{ p.title }}</span>
            {% if p.code %}<span class="badge-pill" style="background:#111;border-color:#fff;">{{ p.code }}</span>{% endif %}
          </div>
          <div class="card-body">
            {% if p.description %}<p class="mb-2">{{ p.description }}</p>{% endif %}
            {% if p.discount_type in ['percent','fixed'] %}
              <div class="chip"><i class="bi bi-tag"></i>
                {% if p.discount_type=='percent' %}{{ p.value }}% OFF{% else %}${{ p.value }} OFF{% endif %}
              </div>
            {% else %}
              <div class="chip"><i class="bi bi-info-circle"></i> Promoci√≥n</div>
            {% endif %}
            {% if p.ends_at %}
              <div class="mt-2 text-muted-2 small"><i class="bi bi-clock"></i> Vigente hasta {{ p.ends_at.strftime('%d/%m/%Y') }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}


<!-- INFORMACI√ìN -->
<section class="container" id="info">
  <h2 class="mb-3">Informaci√≥n</h2>
  <div class="highlights mb-3">
    {% if page.get('category') %}<div class="hl"><i class="bi bi-tag me-2"></i><b>Categor√≠a:</b> {{ page.category }}</div>{% endif %}
    {% if page.get('operating_hours') %}<div class="hl"><i class="bi bi-clock me-2"></i><b>Horario:</b> {{ page.operating_hours }}</div>{% endif %}
    {% if page.get('payment_methods') %}<div class="hl"><i class="bi bi-credit-card me-2"></i><b>Pagos:</b> {{ page.payment_methods }}</div>{% endif %}
    {% if page.get('delivery_available') %}<div class="hl"><i class="bi bi-truck me-2"></i><b>Env√≠os:</b> S√≠</div>{% endif %}
  </div>

  <div class="row g-4">
    {% if page.get('description') %}
    <div class="col-lg-7">
      <div class="card-review p-3 h-100">
        <h4 class="mb-2">Sobre nosotros</h4>
        <p class="mb-0 text-secondary">{{ page.description }}</p>
      </div>
    </div>
    {% endif %}

    <div class="col-lg-5">
      <div class="card-review p-3 h-100">
        <h5 class="mb-2">Detalles</h5>
        {% if page.get('founding_date') %}<p class="mb-2"><i class="bi bi-calendar-event me-2"></i>Fundaci√≥n: {{ page.founding_date }}</p>{% endif %}
        {% if page.get('services') %}<p class="mb-2"><i class="bi bi-stars me-2"></i>Servicios: {{ page.services }}</p>{% endif %}
        {% if page.get('address') %}<p class="mb-2"><i class="bi bi-geo-alt me-2"></i>Direcci√≥n: {{ page.address }}</p>{% endif %}
        {% if page.get('city') or page.get('state') or page.get('postal_code') %}<p class="mb-0"><i class="bi bi-geo me-2"></i>{{ page.get('city','') }}{% if page.get('state') %}, {{ page.state }}{% endif %}{% if page.get('postal_code') %} ¬∑ CP {{ page.postal_code }}{% endif %}</p>{% endif %}
      </div>
    </div>
  </div>
</section>

<!-- VIS√çTANOS -->
<section id="visitanos" class="visit py-5">
  <div class="container">
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
      <h2 class="m-0">Vis√≠tanos</h2>
      {% if page.get('lat') is not none and page.get('lng') is not none %}
        <a class="btn btn-outline btn-sm" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ page.lat }},{{ page.lng }}" data-track="click_maps"><i class="bi bi-sign-turn-right"></i> C√≥mo llegar</a>
      {% elif page.get('address') %}
        <a class="btn btn-outline btn-sm" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ page.address | urlencode }}" data-track="click_maps"><i class="bi bi-search"></i> Buscar direcci√≥n</a>
      {% endif %}
    </div>

    {% set has_coords = page.get('lat') is not none and page.get('lng') is not none %}
    {% if has_coords %}
      <div id="mapWrap"><div id="map" role="region" aria-label="Mapa de ubicaci√≥n"></div></div>
    {% else %}
      <div class="card-review p-3">
        <p class="mb-2 text-secondary">A√∫n no hay coordenadas guardadas.</p>
        {% if page.get('address') %}
          <div class="d-flex gap-2 flex-wrap">
            <a class="btn btn-outline btn-sm" target="_blank" href="https://www.google.com/maps/search/?api=1&query={{ page.address | urlencode }}" data-track="click_maps">Google Maps</a>
            <a class="btn btn-outline btn-sm" target="_blank" href="https://www.openstreetmap.org/search?query={{ page.address | urlencode }}" data-track="click_maps">OpenStreetMap</a>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

<!-- CONTACTO -->
<section id="contacto" class="container">
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card-review p-3">
        <h4 class="mb-3">Contacto</h4>
        {% if page.get('phone') %}<p class="mb-1" data-track="click_phone"><i class="bi bi-telephone text-success me-2"></i> {{ page.phone }}</p>{% endif %}
        {% if page.get('email') %}<p class="mb-1"><i class="bi bi-envelope text-danger me-2"></i> {{ page.email }}</p>{% endif %}
        {% if page.get('website') %}<p class="mb-1"><i class="bi bi-globe me-2 text-primary"></i> <a class="text-secondary" href="{{ page.website }}" target="_blank" rel="noopener" data-track="click_website">{{ page.website }}</a></p>{% endif %}
        <div class="d-flex gap-2 mt-2 flex-wrap">
          {% if page.get('facebook') %}<a class="btn btn-outline btn-sm" href="{{ page.facebook }}" target="_blank" rel="noopener"><i class="bi bi-facebook"></i></a>{% endif %}
          {% if page.get('instagram') %}<a class="btn btn-outline btn-sm" href="{{ page.instagram }}" target="_blank" rel="noopener"><i class="bi bi-instagram"></i></a>{% endif %}
          {% if page.get('tiktok') %}<a class="btn btn-outline btn-sm" href="{{ page.tiktok }}" target="_blank" rel="noopener"><i class="bi bi-tiktok"></i></a>{% endif %}
        </div>
      </div>
    </div>

    {% if page.get('whatsapp') %}
    <div class="col-md-6">
      <div class="card-review p-3">
        <h4 class="mb-3">Escr√≠benos</h4>
        <form onsubmit="openWhats(event)">
          <div class="row g-2">
            <div class="col-md-6"><input class="form-control bg-dark text-white border-secondary" id="cname" placeholder="Nombre" required></div>
            <div class="col-md-6"><input class="form-control bg-dark text-white border-secondary" id="cmail" placeholder="Email" type="email"></div>
            <div class="col-12"><textarea class="form-control bg-dark text-white border-secondary" id="cmsg" rows="3" placeholder="Mensaje"></textarea></div>
          </div>
          <button class="btn btn-primary mt-2" type="submit" data-track="click_whatsapp_fab"><i class="bi bi-whatsapp me-1"></i> Enviar por WhatsApp</button>
        </form>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- RESE√ëAS -->
{% if rese√±as %}
<section class="container" id="rese√±as">
  <h2 class="mb-3">Rese√±as</h2>
  <div class="row g-3">
    {% for r in rese√±as %}
    <div class="col-12 col-md-6">
      <div class="card-review p-3 h-100">
        <div class="d-flex align-items-center justify-content-between">
          <strong>{{ r.nombre }}</strong>
          <div>
            {% for i in range(1,6) %}
              {% if i <= r.estrellas %}<i class="bi bi-star-fill text-warning"></i>{% else %}<i class="bi bi-star text-secondary"></i>{% endif %}
            {% endfor %}
          </div>
        </div>
        {% if r.comentario %}<p class="mt-2 mb-0 text-secondary">{{ r.comentario }}</p>{% endif %}
        {% if r.fecha %}<small class="text-secondary">{{ r.fecha.strftime('%d/%m/%Y') }}</small>{% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}
<!-- Reservas  -->
  {% include "public/reservas.html" %}
<!-- FOOTER -->
<footer class="py-4">
  <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center gap-2">
    <div class="text-secondary small">
      {% if page.get('business_name') %}¬© {{ 2025 }} <b>{{ page.business_name }}</b>.{% endif %} Todos los derechos reservados.
    </div>
    <div class="d-flex gap-3 flex-wrap">
      {% if productos_fisicos %}<a class="text-secondary" href="#productos">Productos</a>{% endif %}
      {% if servicios %}<a class="text-secondary" href="#servicios">Servicios</a>{% endif %}
      {% if posts %}<a class="text-secondary" href="#novedades">Novedades</a>{% endif %}
      <a class="text-secondary" href="#contacto">Contacto</a>
    </div>
  </div>
</footer>

<!-- FAB WhatsApp -->
{% if page.get('whatsapp') %}
<a href="https://wa.me/{{ page.whatsapp | replace(' ','') }}" class="fab-wa" target="_blank" aria-label="WhatsApp" data-track="click_whatsapp_fab">
  <span class="d-inline-flex align-items-center justify-content-center rounded-circle" style="width:56px;height:56px;background:#25D366;box-shadow:0 10px 26px rgba(37,211,102,.35)">
    <i class="bi bi-whatsapp text-white fs-3"></i>
  </span>
</a>
{% endif %}

<!-- Modal Zoom -->
<div class="modal fade" id="zoomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content bg-transparent border-0">
      <img id="zoomedImage" class="w-100 rounded" alt="Preview">
    </div>
  </div>
</div>

<!-- Leaflet / Bootstrap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ================ ZOOM IMAGEN PRODUCTO =================
  document.querySelectorAll('.img-zoom-trigger')?.forEach(el=>{
    el.addEventListener('click', e=>{
      const src = e.currentTarget.getAttribute('data-img-src') || e.currentTarget.src;
      const img = document.getElementById('zoomedImage');
      if(img) img.src = src;
    })
  });

  // ================ FILTRO POR CATEGOR√çA (chips) =================
  const chipsWrap = document.getElementById('chips');
  const chips = chipsWrap ? chipsWrap.querySelectorAll('.chip') : [];
  const grid  = document.getElementById('prodGrid');

  chips.forEach(ch=>{
    ch.addEventListener('click', ()=>{
      chips.forEach(c=>c.classList.remove('active'));
      ch.classList.add('active');
      const cat = ch.dataset.cat;
      grid?.querySelectorAll('.card-prod').forEach(card=>{
        card.style.display = (cat==='all' || card.dataset.cat===cat) ? '' : 'none';
      });
      // reflow para evitar huecos raros
      grid?.offsetHeight;
    });
  });

  // ================ ORDENAMIENTO =================
  const sortSel = document.getElementById('sort');
  sortSel?.addEventListener('change', ()=>{
    const cards = Array
      .from(grid.querySelectorAll('.card-prod'))
      .filter(c=>c.style.display!=='none');
    const byPrice = c => parseFloat(
      (c.querySelector('.prod-price')?.textContent || '')
        .replace(/[^0-9.]/g,'') || 0
    );
    if (sortSel.value==='low')  cards.sort((a,b)=>byPrice(a)-byPrice(b));
    if (sortSel.value==='high') cards.sort((a,b)=>byPrice(b)-byPrice(a));
    if (sortSel.value==='new')  cards.sort(()=>0.5-Math.random());
    cards.forEach(c=>grid.appendChild(c));
  });

  // ================ TALLAS (marcar activa) =================
  document.querySelectorAll('.card-prod').forEach(card=>{
    const sizeEls = card.querySelectorAll('.size');
    sizeEls.forEach(s=>{
      function activate(){
        sizeEls.forEach(x=>x.classList.remove('active'));
        s.classList.add('active');
      }
      s.addEventListener('click', activate);
      s.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){
          e.preventDefault();
          activate();
        }
      });
    });
  });

  // ================ WHATSAPP / COTIZACI√ìN =================
  const telefono = "{{ page.get('whatsapp','') | replace(' ','') }}";

  // estado temporal para el modal
  let cotizacionLineas = [];   // array de strings "- Producto X (Talla) x Cant"
  let compraIndividual = false; // true si vino de "buy now" 1 producto

  const cotizarForm           = document.getElementById('cotizarForm');
  const cotizarModalEl        = document.getElementById('cotizarModal');
  const resumenSeleccionDiv   = document.getElementById('resumenSeleccion');
  const nombreClienteInput    = document.getElementById('nombreClienteInput');
  const errorModalNombre      = document.getElementById('errorModalNombre');
  const enviarCotizacionBtn   = document.getElementById('enviarCotizacionBtn');

  const bsCotizarModal = cotizarModalEl ? new bootstrap.Modal(cotizarModalEl) : null;

  // helper: arma "- Nombre (talla) x cant"
  function lineaProducto(card){
    const title = card.querySelector('.prod-title')?.textContent?.trim() || 'Producto';
    const qtyInput = card.querySelector('.qty-input');
    const qty = qtyInput?.valueAsNumber || 0;
    const sizeSel = card.querySelector('.size.active')?.dataset.size || '';
    if(qty <= 0) return null;
    return `- ${title}${sizeSel?(" ("+sizeSel+")"):""} x ${qty}`;
  }

  // sumar r√°pido con "+"
  document.querySelectorAll('.card-prod .add-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const wrap = btn.closest('.card-prod');
      const qtyInput = wrap.querySelector('.qty-input');
      qtyInput.value = (qtyInput.valueAsNumber || 0) + 1;
      btn.classList.add('btn-success');
      setTimeout(()=>btn.classList.remove('btn-success'), 450);
    });
  });

  // flujo "Cotizar por WhatsApp" (varios productos)
  cotizarForm?.addEventListener('submit', e=>{
    e.preventDefault();
    if(!telefono){
      alert("No hay n√∫mero de WhatsApp configurado.");
      return;
    }

    compraIndividual = false;
    cotizacionLineas = [];

    // recorremos TODOS los productos visibles (aunque est√©n ocultos por filtro igual cuenta, t√∫ decides)
    document.querySelectorAll('.card-prod').forEach(card=>{
      const l = lineaProducto(card);
      if(l){ cotizacionLineas.push(l); }
    });

    if(!cotizacionLineas.length){
      alert("Selecciona al menos 1 producto con cantidad > 0 üôè");
      return;
    }

    // pintar preview en el modal
    resumenSeleccionDiv.innerHTML = cotizacionLineas.map(l => `<div>${l}</div>`).join('');
    // reset errores
    errorModalNombre.classList.add('d-none');
    nombreClienteInput.classList.remove('is-invalid');
    // abrir modal
    bsCotizarModal?.show();
    setTimeout(()=>{ nombreClienteInput.focus(); }, 250);
  });

  // flujo "buy now" de un producto (bot√≥n con √≠cono de whatsapp)
  document.querySelectorAll('.card-prod .buy-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!telefono){
        alert("No hay n√∫mero de WhatsApp configurado.");
        return;
      }

      compraIndividual = true;
      cotizacionLineas = [];

      const card = btn.closest('.card-prod');

      // si el user no puso cantidad, asumimos 1
      const qtyInput = card.querySelector('.qty-input');
      if(qtyInput && (!qtyInput.valueAsNumber || qtyInput.valueAsNumber <=0)){
        qtyInput.value = 1;
      }

      const l = lineaProducto(card);
      if(l){ cotizacionLineas.push(l); }

      if(!cotizacionLineas.length){
        alert("Selecciona cantidad v√°lida üôè");
        return;
      }

      resumenSeleccionDiv.innerHTML = cotizacionLineas.map(l => `<div>${l}</div>`).join('');
      errorModalNombre.classList.add('d-none');
      nombreClienteInput.classList.remove('is-invalid');
      bsCotizarModal?.show();
      setTimeout(()=>{ nombreClienteInput.focus(); }, 250);
    });
  });

  // CLICK EN "Enviar por WhatsApp" dentro del modal
  enviarCotizacionBtn?.addEventListener('click', ()=>{
    const nombreCliente = (nombreClienteInput.value || '').trim();
    if(!nombreCliente){
      errorModalNombre.classList.remove('d-none');
      nombreClienteInput.classList.add('is-invalid');
      nombreClienteInput.focus();
      return;
    }

    // armamos el mensaje final
    // %0A = salto de l√≠nea URL-encoded
    let mensaje = `Hola, soy ${nombreCliente} y quiero ${compraIndividual ? 'pedir' : 'cotizar'}:%0A`;
    cotizacionLineas.forEach(linea=>{
      mensaje += encodeURIComponent(linea) + "%0A";
    });

    const urlWhatsapp = `https://wa.me/${telefono}?text=${mensaje}`;
    window.open(urlWhatsapp, '_blank');
  });

  // ================ CONTACTO -> openWhats (ya pedimos nombre ah√≠ con inputs) =================
  window.openWhats = function(e){
    e.preventDefault();
    if(!telefono){
      alert("No hay n√∫mero de WhatsApp configurado.");
      return;
    }
    const name = document.getElementById('cname')?.value || '';
    const mail = document.getElementById('cmail')?.value || '';
    const msg  = document.getElementById('cmsg')?.value || '';
    const t = `Hola, soy ${name}. ${mail?("Email: "+mail+". "):""}${msg}`;
    window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(t)}`, '_blank');
  }

  // ================ MAPA (IntersectionObserver lazy init) =================
  (function(){
    const hasCoords = {{ 'true' if (page.get('lat') is not none and page.get('lng') is not none) else 'false' }};
    if(!hasCoords) return;

    const lat = {{ page.get('lat') if page.get('lat') is not none else 'null' }};
    const lng = {{ page.get('lng') if page.get('lng') is not none else 'null' }};

    function initMap(){
      const target = document.getElementById('map');
      if(!target || target.dataset.ready) return;
      target.dataset.ready = '1';

      const map = L.map('map', { scrollWheelZoom:false, zoomControl:true }).setView([lat,lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom:19,
        attribution:'&copy; OpenStreetMap'
      }).addTo(map);
      L.marker([lat,lng]).addTo(map).bindPopup({{ page.get('business_name','"Negocio"')|tojson }});
      setTimeout(()=>map.invalidateSize(), 250);
      window.addEventListener('resize', ()=>map.invalidateSize());
      const off = document.getElementById('navOff');
      off?.addEventListener('hidden.bs.offcanvas', ()=>setTimeout(()=>map.invalidateSize(), 200));
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const target = document.getElementById('map');
      if(!target) return;
      if('IntersectionObserver' in window){
        const io = new IntersectionObserver(entries=>{
          entries.forEach(e=>{
            if(e.isIntersecting){
              initMap();
              io.disconnect();
            }
          });
        }, {threshold:.15});
        io.observe(target);
      } else {
        initMap();
      }
    });
  })();

  // ================ ESTRELLAS (rese√±as) =================
  (() => {
    const stars = document.querySelectorAll('.star-icon');
    const input = document.getElementById('estrellas');
    if(!stars.length || !input) return;
    stars.forEach(s=>{
      s.addEventListener('click', ()=>{
        const v = parseInt(s.dataset.value);
        input.value = v;
        stars.forEach(i=>{
          const n = parseInt(i.dataset.value);
          i.classList.remove('text-warning','text-secondary');
          i.classList.add(n<=v ? 'text-warning' : 'text-secondary');
        });
      });
    });
  })();
</script>

<!-- Leaflet init -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
(function(){
  const hasCoords = {{ 'true' if (page.get('lat') is not none and page.get('lng') is not none) else 'false' }};
  if(!hasCoords) return;

  const lat = {{ page.get('lat') if page.get('lat') is not none else 'null' }};
  const lng = {{ page.get('lng') if page.get('lng') is not none else 'null' }};

  function initMap(){
    const target = document.getElementById('map');
    if(!target || target.dataset.ready) return;
    target.dataset.ready = '1';

    const map = L.map('map', { scrollWheelZoom:false, zoomControl:true }).setView([lat, lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OSM'}).addTo(map);
    const marker = L.marker([lat, lng]).addTo(map);
    marker.bindPopup(`<strong>{{ page.get('business_name','')|e }}</strong><br>{{ (page.get('address','') or '')|e }}`);

    setTimeout(()=>map.invalidateSize(), 250);
    window.addEventListener('resize', ()=>map.invalidateSize());

    const off = document.getElementById('navOff');
    off?.addEventListener('hidden.bs.offcanvas', ()=>setTimeout(()=>map.invalidateSize(), 200));
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const target = document.getElementById('map');
    if(!target) return;

    if('IntersectionObserver' in window){
      const io = new IntersectionObserver(entries=>{
        entries.forEach(e=>{ if(e.isIntersecting){ initMap(); io.disconnect(); } });
      }, {threshold: .15});
      io.observe(target);
    } else {
      initMap();
    }
  });
})();
</script>
<script>
/**
 * =========================================================
 *  PUBLIC MODULE: Analytics + Cotizar (Lead) + UX helpers
 *  Requiere endpoints:
 *   - POST /api/track
 *   - POST /api/leads
 *  Requiere que backend pase `slug` o que page.slug exista:
 *   ctx incluye: slug=slug
 * =========================================================
 */

const SITE_SLUG = "{{ slug or page.get('slug','') }}";
const BUSINESS_NAME = "{{ page.get('business_name','')|e }}";
const BUSINESS_WA = "{{ (page.get('whatsapp','') or '')|replace(' ','') }}";

/* -----------------------------
   Analytics: track() helper
------------------------------ */
function track(type, meta){
  try{
    if(!SITE_SLUG) return;
    fetch("/api/track", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ slug: SITE_SLUG, type, meta: meta || {} })
    }).catch(()=>{});
  }catch(e){}
}

// View event (al cargar)
track("view", { path: location.pathname, ref: document.referrer || "" });

/* Track clicks en cualquier elemento con data-track */
document.addEventListener("click", (e)=>{
  const el = e.target.closest("[data-track]");
  if(!el) return;
  const type = el.getAttribute("data-track");
  const href = el.getAttribute("href") || "";
  track(type, { href });
});

/* -----------------------------
   Zoom Modal (im√°genes)
------------------------------ */
(function zoomModule(){
  const zoomed = document.getElementById("zoomedImage");
  if(!zoomed) return;

  document.addEventListener("click", (e)=>{
    const img = e.target.closest(".img-zoom-trigger");
    if(!img) return;
    const src = img.getAttribute("data-img-src") || img.getAttribute("src");
    if(src) zoomed.src = src;
    track("open_zoom", { src: src || "" });
  });
})();

/* -----------------------------
   Star rating (rese√±as)
------------------------------ */
(function starsModule(){
  const stars = Array.from(document.querySelectorAll(".star-icon"));
  const input = document.getElementById("estrellas");
  if(!stars.length || !input) return;

  function paint(v){
    stars.forEach(s=>{
      const n = parseInt(s.dataset.value || "0", 10);
      if(n <= v){
        s.classList.remove("text-secondary");
        s.classList.add("text-warning");
      }else{
        s.classList.remove("text-warning");
        s.classList.add("text-secondary");
      }
    });
  }

  stars.forEach(s=>{
    s.style.cursor = "pointer";
    s.addEventListener("click", ()=>{
      const v = parseInt(s.dataset.value || "0", 10);
      input.value = String(v);
      paint(v);
      track("rate_star_select", { value: v });
    });
  });
})();

/* -----------------------------
   Cotizar -> Modal -> WhatsApp
   + Save lead server-side
------------------------------ */
(async function cotizarModule(){
  const form = document.getElementById("form-cotizar");
  const modalEl = document.getElementById("cotizarModal");
  const resumenEl = document.getElementById("resumenSeleccion");
  const nombreInput = document.getElementById("nombreClienteInput");
  const errNombre = document.getElementById("errorModalNombre");
  const enviarBtn = document.getElementById("enviarCotizacionBtn");

  if(!form || !modalEl || !resumenEl || !nombreInput || !enviarBtn) return;

  // Bootstrap modal instance
  const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);

  let selectedItems = []; // [{title, qty}]

  function getSelectedItems(){
    const inputs = Array.from(form.querySelectorAll('input[type="number"][data-item-nombre]'));
    const items = [];
    for(const inp of inputs){
      const title = (inp.dataset.itemNombre || "").trim();
      const qty = parseInt(inp.value || "0", 10);
      if(title && Number.isFinite(qty) && qty > 0){
        items.push({ title, qty });
      }
    }
    return items;
  }

  function renderResumen(items){
    if(!items.length){
      resumenEl.innerHTML = `<div class="text-muted">No seleccionaste nada todav√≠a.</div>`;
      return;
    }
    resumenEl.innerHTML = items.map(it => {
      return `<div>‚Ä¢ <strong>${escapeHtml(it.title)}</strong> √ó ${it.qty}</div>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    selectedItems = getSelectedItems();

    if(!selectedItems.length){
      track("cotizar_empty", {});
      // feedback simple sin alert fea
      resumenEl.innerHTML = `<div class="text-danger fw-bold">Selecciona al menos 1 producto/servicio con cantidad > 0.</div>`;
      bsModal.show();
      return;
    }

    track("cotizar_open_modal", { items: selectedItems.length });
    renderResumen(selectedItems);
    errNombre.classList.add("d-none");
    nombreInput.value = "";
    bsModal.show();
    setTimeout(()=> nombreInput.focus(), 150);
  });

  async function createLead(nombre, items){
    try{
      const r = await fetch("/api/leads", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          slug: SITE_SLUG,
          nombre,
          items,
          canal: "whatsapp"
        })
      });
      return await r.json();
    }catch(e){
      return { ok:false, error:"network" };
    }
  }

  function buildWhatsAppMessage(nombre, items){
    const lines = [];
    lines.push(`Hola, soy ${nombre}.`);
    lines.push(`Quisiera cotizar con ${BUSINESS_NAME}:`);
    for(const it of items){
      lines.push(`- ${it.title} x${it.qty}`);
    }
    lines.push(`Gracias.`);
    return lines.join("\n");
  }

  function openWhatsApp(text){
    if(!BUSINESS_WA){
      // fallback: no whatsapp definido
      alert("Este negocio a√∫n no tiene WhatsApp configurado.");
      return;
    }
    const url = `https://wa.me/${BUSINESS_WA}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank", "noopener");
  }

  enviarBtn.addEventListener("click", async ()=>{
    const nombre = (nombreInput.value || "").trim();

    if(!nombre){
      errNombre.classList.remove("d-none");
      track("cotizar_missing_name", {});
      nombreInput.focus();
      return;
    }

    if(!selectedItems.length){
      track("cotizar_missing_items", {});
      bsModal.hide();
      return;
    }

    enviarBtn.disabled = true;
    enviarBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Enviando...`;

    track("cotizar_send_click", { items: selectedItems.length });

    // 1) Guardar lead en servidor
    const resp = await createLead(nombre, selectedItems);

    // 2) Abrir WhatsApp SIEMPRE (no romper UX)
    const msg = buildWhatsAppMessage(nombre, selectedItems);
    openWhatsApp(msg);

    // 3) Track resultado lead
    if(resp && resp.ok){
      track("lead_saved", { lead_id: resp.lead_id || "" });
    }else{
      track("lead_save_failed", { error: (resp && resp.error) || "unknown" });
    }

    // reset UI
    setTimeout(()=>{
      enviarBtn.disabled = false;
      enviarBtn.innerHTML = `<i class="bi bi-whatsapp me-1"></i> Enviar por WhatsApp`;
      bsModal.hide();
    }, 250);
  });

})();
</script>

</body>
</html>
