<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{{ page.get('business_name','Restaurante') }}</title>
  <meta name="description" content="{{ page.get('slogan') or page.get('description','')[:160] }}">
  <meta name="keywords" content="{{ page.get('category','Restaurante') }}, comida, men√∫, reservaciones">
  <meta name="author" content="{{ page.get('business_name','') }}">

  {# OG / Twitter - si hay portada la usamos #}
  <meta property="og:title" content="{{ page.get('business_name','Restaurante') }}">
  <meta property="og:description" content="{{ page.get('slogan') or page.get('description','')[:200] }}">
  {% if page.get('cover_image') %}
    <meta property="og:image" content="{{ url_for('uploaded_file', filename=page.cover_image, _external=True) }}">
  {% else %}
    <meta property="og:image" content="{{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True) }}">
  {% endif %}
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:type" content="restaurant">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Favicon / CSS -->
  <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" type="image/png" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --brand: {{ "'" ~ (page.get('color') or '#c2410c') ~ "'" }};
      --brand-2: color-mix(in oklab, var(--brand) 70%, #000 30%);
      --bg:#0b0f14; --card:#0f141b; --ink:#e5e7eb; --muted:#9aa4b2; --line:#1f2937;
      --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.24);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#fafafa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      }
    }

    html{scroll-behavior:smooth}
    body{
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg); color:var(--ink)
    }

    /* NAV */
    .navbar{
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .navbar .nav-link{ color:#fff; font-weight:600; opacity:.9 }
    .navbar .nav-link:hover,.navbar .nav-link.active{ opacity:1 }

    /* HERO con portada */
    .hero{
      position: relative;
      {% if page.get('cover_image') %}
      background:
        linear-gradient(130deg, rgba(11,15,20,.9) 8%, rgba(11,15,20,.35) 58%, rgba(11,15,20,0) 100%),
        url("{{ url_for('uploaded_file', filename=page.cover_image) }}") center/cover no-repeat;
      {% else %}
      background:
        radial-gradient(900px 400px at -10% -20%, color-mix(in oklab, var(--brand) 38%, #fff 62%) 0%, transparent 55%),
        linear-gradient(180deg, color-mix(in oklab, var(--bg) 90%, #000 10%) 0%, var(--bg) 100%);
      {% endif %}
      border-bottom:1px solid var(--line);
      overflow: clip;
    }
    .hero::after{
      content:""; position:absolute; inset:auto -10% -40% -10%; height:55%;
      background: radial-gradient(50% 60% at 50% 0%, color-mix(in oklab, var(--brand) 35%, transparent) 0%, transparent 70%);
      pointer-events:none;
    }
    .hero-logo{
      inline-size:min(240px,45vw); block-size:min(240px,45vw);
      object-fit:cover; border-radius:999px; border:3px solid #fff;
      box-shadow:0 12px 36px rgba(2,6,23,.25);
    }
    .pill{
      display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .75rem;
      border-radius:999px; background:rgba(255,255,255,.14); color:#fff;
      border:1px solid rgba(255,255,255,.24)
    }
    .chips .chip{
      display:inline-block; padding:.25rem .6rem; border:1px solid var(--line);
      border-radius:999px; color:var(--muted); margin:.25rem .35rem .25rem 0;
      font-weight:600; font-size:.85rem
    }

    .btn-brand{
      background:var(--brand)!important; border-color:var(--brand)!important;
      color:#fff!important; font-weight:700
    }
    .btn-brand:hover{ filter:brightness(.96) }
    .btn-outline-brand{
      border-color:var(--brand)!important; color:var(--brand)!important
    }
    .btn-outline-brand:hover{
      background:var(--brand)!important; color:#fff!important
    }

    .card-soft{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .section-title{ font-weight:800; letter-spacing:.2px }

    /* ===== MEN√ö ===== */
    .menu-tools{ gap:.6rem; flex-wrap:wrap }
    .menu-search{ max-width:480px }
    .tabs .btn{
      --bs-btn-padding-y:.4rem; --bs-btn-padding-x:.9rem; --bs-btn-border-radius:999px;
      border:1px solid var(--line); background:transparent; color:var(--ink); font-weight:600
    }
    .tabs .btn.active{ background:var(--brand); color:#fff; border-color:transparent }

    .menu-card{
      display:flex; flex-wrap:wrap;
      gap:14px; align-items:flex-start;
      padding:12px; border-bottom:1px dashed var(--line)
    }
    .menu-card:last-child{ border-bottom:0 }

    .menu-thumb{
      width:86px; height:86px; border-radius:12px; object-fit:cover;
      border:1px solid var(--line); background:#fff
    }
    .menu-name{ font-weight:800 }
    .menu-price{ font-weight:800; color:var(--brand) }
    .badge-diet{
      font-size:.72rem; border:1px solid var(--line);
      border-radius:999px; padding:.12rem .45rem;
      color:var(--muted)
    }

    .pedido-box label{ font-size:.7rem; color:var(--muted); margin:0; }
    .pedido-box input{min-width:70px;}

    /* ===== SERVICIOS ===== */
    .service-card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      height:100%;
      padding:1rem 1.25rem;
    }

    /* GALER√çA mejorada */
    .gallery-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap:1rem;
    }
    .gal-item{
      position:relative;
      border-radius:14px;
      overflow:hidden;
      aspect-ratio:4/3;
      background:#000;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.05);
    }
    .gal-item img,.gal-item video{
      width:100%;height:100%;object-fit:cover;display:block;
    }
    .gal-item::after{
      content:"";position:absolute;inset:0;background:linear-gradient(180deg,transparent 50%,rgba(0,0,0,.4) 100%);opacity:0;transition:.2s;
    }
    .gal-item:hover::after{opacity:1;}
    .badge-type{
      position:absolute;top:.5rem;left:.5rem;background:rgba(0,0,0,.6);color:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.7rem;
      backdrop-filter:blur(2px);
    }

    /* MAPA */
    #map{
      height: 340px; border-radius:16px;
      border:1px solid var(--line); overflow:hidden;
      box-shadow:var(--shadow)
    }

    /* CTA sticky bottom */
    .cta-stick{
      position:sticky; bottom:0; inset-inline:0; z-index:1020;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      border-top:1px solid rgba(255,255,255,.15);
      backdrop-filter: saturate(1.2) blur(6px);
    }

    /* WhatsApp flotante */
    .floating-wa{
      position: fixed; bottom: 18px; right: 18px; z-index: 1050;
      background:#25D366; color:#fff; border-radius:999px;
      padding:.7rem .9rem; box-shadow:0 12px 34px rgba(37,211,102,.35);
    }
    .floating-wa:hover{ color:#fff; filter:brightness(.95) }

    /* Bot√≥n men√∫ digital */
    .floating-menu{
      position: fixed; bottom: 78px; right: 18px; z-index: 1050;
      background:var(--card); color:var(--ink); border:1px solid rgba(255,255,255,.14);
      border-radius:999px; padding:.55rem .9rem; display:flex; gap:.4rem; align-items:center;
      box-shadow:0 16px 42px rgba(0,0,0,.28);
    }
    .floating-menu small{font-size:.7rem;line-height:1;}

    /* Offcanvas men√∫ digital */
    .offcanvas-menu{
      background: radial-gradient(circle at top, rgba(11,15,20,1) 0%, #050608 65%);
      color:#fff;
    }
    .offcanvas-menu .list-group-item{
      background:transparent;
      border:1px solid rgba(255,255,255,.05);
      border-radius:14px;
      margin-bottom:.55rem;
    }

    @media (max-width: 991.98px){
      .menu-thumb{ width:74px; height:74px }
      .menu-card{ padding:10px }
    }
    @media (max-width: 767.98px){
      .navbar-brand{ font-size:1.05rem }
      .section-title{ font-size:1.25rem }
      .btn-brand,.btn-outline-brand{ width:100% }
      .menu-name,.menu-price{ font-size:1rem }
      .gallery-grid{grid-template-columns:1fr 1fr;}
    }
    @media (min-width: 1200px){
      .container{ max-width: 1140px }
    }

    /* Avisos inline */
    .avisos-inline{
      border:1px solid var(--line);
      border-radius:12px;
      background: color-mix(in oklab, var(--brand) 10%, var(--card));
      box-shadow: var(--shadow);
    }
    .avisos-inline .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.25rem .6rem; border-radius:999px;
      border:1px dashed var(--line);
      color:var(--ink); font-weight:600;
      white-space:nowrap;
    }
    .avisos-inline time{ color:var(--muted); font-size:.8rem }

    .modal-content{ background-color: #000 !important; }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Restaurant",
    "name": {{ page.get('business_name','"Restaurante"')|tojson }},
    "description": {{ (page.get('description') or page.get('slogan') or '')|tojson }},
    "servesCuisine": {{ (page.get('category') or 'Comida')|tojson }},
    "image": {% if page.get('cover_image') %}
      {{ url_for('uploaded_file', filename=page.cover_image, _external=True)|tojson }}
    {% else %}
      {{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True)|tojson }}
    {% endif %},
    "telephone": {{ (page.get('phone') or '')|tojson }},
    "address": {
      "@type":"PostalAddress",
      "streetAddress": {{ (page.get('address') or '')|tojson }},
      "addressLocality": {{ (page.get('city') or '')|tojson }},
      "addressRegion": {{ (page.get('state') or '')|tojson }},
      "postalCode": {{ (page.get('postal_code') or '')|tojson }},
      "addressCountry": "MX"
    },
    "url": {{ request.url|tojson }}
  }
  </script>
</head>
<body data-bs-spy="scroll" data-bs-target="#mainNavbar" data-bs-offset="80" tabindex="0">

  <!-- NAV -->
  <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">{{ page.get('business_name','Restaurante') }}</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navcollapse" aria-label="Abrir navegaci√≥n">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navcollapse" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#menu">Men√∫</a></li>
          <li class="nav-item"><a class="nav-link" href="#servicios">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="#reservas">Reservas</a></li>
          <li class="nav-item"><a class="nav-link" href="#info">Informaci√≥n</a></li>
          <li class="nav-item"><a class="nav-link" href="#galeria">Galer√≠a</a></li>
          <li class="nav-item"><a class="nav-link" href="#rese√±as">Rese√±as</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero pt-6" style="padding-top:94px;">
    <div class="container py-4 py-md-5">
      <div class="row align-items-center g-4">
        <div class="col-md-4 text-center">
          {% if page.get('image') %}
            <img loading="lazy" src="{{ url_for('uploaded_file', filename=page['image']) }}" class="hero-logo" alt="Logo {{ page.get('business_name','') }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='images/default_image.png') }}" class="hero-logo" alt="Logo del negocio">
          {% endif %}
        </div>
        <div class="col-md-8">
          {% if page.get('slogan') %}
            <span class="pill mb-2"><i class="bi bi-fire"></i>{{ page['slogan'] }}</span>
          {% endif %}
          <h1 class="display-6 fw-extrabold mb-2">{{ page.get('business_name','Restaurante') }}</h1>

          <!-- chips de features generales -->
          <div class="chips mt-2">
            {% for tag in (page.get('services','') or '').split(',') if tag.strip() %}
              <span class="chip">{{ tag.strip() }}</span>
            {% endfor %}
          </div>

          <div class="mt-3 d-flex flex-wrap gap-2">
            {% if page.get('whatsapp') %}
              <a class="btn btn-brand" href="#menu" data-track="click_whatsapp_fab"><i class="bi bi-bag-heart me-1"></i> Hacer pedido</a>
            {% endif %}
            {% if page.get('phone') %}
              <a class="btn btn-outline-brand" href="tel:{{ page.phone }}" data-track="click_phone"><i class="bi bi-telephone me-1"></i> Llamar</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- AVISOS -->
  {% if avisos and avisos|length>0 %}
  <section class="container my-4">
    <div class="avisos-inline p-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-megaphone-fill fs-5 text-white"></i>
          <strong class="section-title m-0">Avisos</strong>
        </div>
        <button class="btn btn-outline-brand btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#avisosLista">
          Ver todos
        </button>
      </div>

      <div class="mt-2 d-flex flex-wrap gap-2">
        {% for a in avisos[:3] %}
          <span class="chip">
            <i class="bi bi-dot"></i>
            <span><strong>{{ a.title }}</strong> ‚Äî {{ a.content }}</span>
            {% if a.date %}<time class="ms-1">{{ a.date.strftime("%d/%m/%Y") }}</time>{% endif %}
          </span>
        {% endfor %}
        {% if avisos|length > 3 %}
          <span class="chip"><i class="bi bi-plus-circle"></i> {{ avisos|length - 3 }} m√°s</span>
        {% endif %}
      </div>

      <div id="avisosLista" class="collapse mt-2">
        <ul class="m-0 ps-0" style="list-style:none">
          {% for a in avisos %}
          <li class="py-2 border-top" style="border-color:var(--line)!important">
            <strong>{{ a.title }}</strong> ‚Äî {{ a.content }}
            {% if a.date %}<time class="ms-2">{{ a.date.strftime('%d/%m/%Y') }}</time>{% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- MEN√ö -->
  <section id="menu" class="container my-5">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <h2 class="section-title m-0">üçΩÔ∏è Men√∫</h2>

      <div class="menu-tools d-flex">
        <input id="menuSearch" type="search" class="form-control menu-search" placeholder="Buscar platillo o ingrediente‚Ä¶">
        <div id="menuTabs" class="tabs btn-group" role="group" aria-label="Categor√≠as"></div>
      </div>
    </div>

    {% set hay_menu_items = (productos_fisicos and productos_fisicos|length>0) %}

    {% if hay_menu_items %}
      {# agrupamos productos_fisicos por categor√≠a #}
      {% set categorias = {} %}
      {% for it in (productos_fisicos or []) %}
        {% set cat = it.get('category') or 'Platillos' %}
        {% if cat not in categorias %}{% set _ = categorias.update({cat: []}) %}{% endif %}
        {% set _ = categorias[cat].append(it) %}
      {% endfor %}

      {% if page.get('whatsapp') %}
      <div class="card-soft p-3 mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="text-white fw-semibold">
            <i class="bi bi-bag-heart me-2"></i>
            Selecciona cantidades y pulsa ‚ÄúPedir por WhatsApp‚Äù.
          </div>
          <small class="text-success">
            No pagas aqu√≠ ‚Äî solo mandas el pedido üòå
          </small>
        </div>
      </div>
      {% endif %}

      <form id="pedidoForm">
        <div id="menuGrid" class="row g-4">
          {% for categoria, items in categorias.items() %}
          <div class="col-12 menu-col" data-category="{{ categoria|e }}">
            <div class="card-soft p-3 h-100">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="m-0">{{ categoria }}</h5>
                <span class="badge text-bg-dark">{{ items|length }}</span>
              </div>

              {% for it in items %}
              <article class="menu-card"
                       data-name="{{ (it.title or '')|e }}"
                       data-tags="{{ (it.tags or '')|e }}">
                {% if it.get('image') %}
                  <img class="menu-thumb" loading="lazy" src="{{ url_for('uploaded_file', filename=it.image) }}" alt="{{ it.title }}">
                {% else %}
                  <img class="menu-thumb" loading="lazy" src="{{ url_for('static', filename='img/default-product.png') }}" alt="Imagen">
                {% endif %}

                <div class="flex-grow-1 w-100">
                  <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap w-100">
                    <div class="flex-grow-1 me-auto">
                      <div class="menu-name">{{ it.title }}</div>

                      {% if it.get('description') %}
                        <div class="text-success small">{{ it.description }}</div>
                      {% endif %}

                      {% if it.get('tags') %}
                        <div class="mt-1">
                          {% for t in it.tags.split(',') if t.strip() %}
                            <span class="badge-diet me-1">{{ t.strip() }}</span>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>

                    <div class="text-end pedido-box" style="min-width:90px">
                      {% if it.get('show_price') %}
                        <div class="menu-price text-nowrap">
                          ${{ "%.2f"|format(it.price) }}
                        </div>
                      {% endif %}
                      <label class="form-label mt-2">Cant.</label>
                      <input
                        type="number"
                        class="form-control form-control-sm pedido-input"
                        min="0"
                        value="0"
                        name="item_{{ it.title | replace(' ','_') }}"
                        data-item-nombre="{{ it.title }}">
                    </div>
                  </div>
                </div>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>

        {% if page.get('whatsapp') %}
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-brand px-4" data-track="click_whatsapp_fab">
            <i class="bi bi-whatsapp me-1"></i> Pedir por WhatsApp
          </button>
        </div>
        {% endif %}
      </form>

      <!-- Modal confirmaci√≥n pedido -->
      <div class="modal fade" id="pedidoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="border-radius:16px;">
            <div class="modal-header" style="background:linear-gradient(90deg, var(--brand), var(--brand-2)); color:#fff; border:none;">
              <h5 class="modal-title fw-bold">Tu pedido üìù</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Tu nombre</label>
                <input type="text" class="form-control" id="pedidoNombreInput" placeholder="Ej. Carlos">
                <div class="text-danger small mt-1 d-none" id="pedidoErrorNombre">Por favor, escribe tu nombre.</div>
              </div>
              <div>
                <div class="form-label mb-1">Resumen:</div>
                <div id="pedidoResumen" class="border rounded p-2 small" style="max-height:220px;overflow-y:auto;"></div>
              </div>
            </div>
            <div class="modal-footer" style="border:none;">
              <button class="btn btn-outline-brand" data-bs-dismiss="modal">Editar</button>
              <button class="btn btn-brand" id="pedidoEnviarBtn">
                <i class="bi bi-whatsapp me-1"></i>Enviar por WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning text-warning bg-transparent border border-warning">
        A√∫n no hay platillos / productos cargados.
      </div>
    {% endif %}
  </section>

  <!-- SERVICIOS -->
  <section id="servicios" class="container my-5">
    {% if servicios and servicios|length>0 %}
      <h2 class="section-title mb-3">üõé Servicios especiales</h2>
      <div class="row g-4">
        {% for s in servicios %}
        <div class="col-md-6 col-lg-4 d-flex">
          <div class="service-card d-flex flex-column w-100">
            <div class="service-title">
              <span>{{ s.title }}</span>
              {% if s.get('show_price') %}
                <span class="service-price">${{ "%.2f"|format(s.price) }}</span>
              {% endif %}
            </div>

            {% if s.get('description') %}
              <div class="service-desc">{{ s.description }}</div>
            {% endif %}

            {% if page.get('whatsapp') %}
              <a class="btn btn-outline-brand w-100 mt-auto"
                 href="https://wa.me/{{ page.whatsapp | replace(' ','') }}?text={{ ('Hola, me interesa el servicio: ' ~ s.title)|urlencode }}"
                 target="_blank">
                <i class="bi bi-whatsapp me-1"></i> Preguntar por WhatsApp
              </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- RESERVAS -->
  <section id="reservas" class="container my-5">
    <h2 class="section-title mb-3">üìÜ Reservas</h2>
    <div class="card-soft p-3 p-md-4">
      {% if page.get('whatsapp') %}
      <form id="reservaForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" id="res_date" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Hora</label>
          <input type="time" class="form-control" id="res_time" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Personas</label>
          <input type="number" class="form-control" id="res_people" min="1" value="2" required>
        </div>
        <div class="col-12">
          <label class="form-label">Notas (opcional)</label>
          <input type="text" class="form-control" id="res_notes" placeholder="Ej. mesa cerca de ventana, aniversario‚Ä¶">
        </div>
        <div class="col-12 d-grid d-md-inline">
          <button type="submit" class="btn btn-brand" data-track="click_whatsapp_fab"><i class="bi bi-whatsapp me-1"></i> Solicitar por WhatsApp</button>
        </div>
      </form>
      {% else %}
        <div class="alert alert-info m-0">Agrega tu n√∫mero de WhatsApp en el panel para activar reservas.</div>
      {% endif %}
    </div>
  </section>

  {% if promos and promos|length > 0 %}
<section class="container my-4" id="promos">
  <h2 class="section-title brand-font">Promos activas</h2>
  <div class="row g-3">
    {% for p in promos %}
      <div class="col-md-6">
        <div class="card card-brutal h-100">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>{{ p.title }}</span>
            {% if p.code %}<span class="badge-pill" style="background:#111;border-color:#fff;">{{ p.code }}</span>{% endif %}
          </div>
          <div class="card-body">
            {% if p.description %}<p class="mb-2">{{ p.description }}</p>{% endif %}
            {% if p.discount_type in ['percent','fixed'] %}
              <div class="chip"><i class="bi bi-tag"></i>
                {% if p.discount_type=='percent' %}{{ p.value }}% OFF{% else %}${{ p.value }} OFF{% endif %}
              </div>
            {% else %}
              <div class="chip"><i class="bi bi-info-circle"></i> Promoci√≥n</div>
            {% endif %}
            {% if p.ends_at %}
              <div class="mt-2 text-muted-2 small"><i class="bi bi-clock"></i> Vigente hasta {{ p.ends_at.strftime('%d/%m/%Y') }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</section>
{% endif %}


  <!-- INFO + UBICACI√ìN -->
  <section id="info" class="container my-5">
    <h2 class="section-title mb-3">üìù Informaci√≥n</h2>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card-soft h-100 p-3">
          <p><i class="fa-solid fa-align-left me-2 text-primary"></i><strong>Qui√©nes somos:</strong> {{ page.get('description','') }}</p>
          <p><i class="fa-solid fa-utensils me-2 text-primary"></i><strong>Cocina:</strong> {{ page.get('category','Restaurante') }}</p>
          {% if page.get('operating_hours') %}
          <p><i class="fa-regular fa-clock me-2 text-primary"></i><strong>Horario:</strong> {{ page['operating_hours'] }}</p>
          {% endif %}
          {% if page.get('payment_methods') %}
          <p><i class="fa-regular fa-credit-card me-2 text-primary"></i><strong>Pagos:</strong> {{ page['payment_methods'] }}</p>
          {% endif %}
          {% if page.get('delivery_available') %}
          <p><i class="fa-solid fa-truck me-2 text-primary"></i><strong>Entrega a domicilio:</strong> S√≠</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6" id="ubicacion">
        <div class="card-soft h-100 p-3">
          <p class="mb-1"><i class="fa-solid fa-location-dot me-2 text-primary"></i><strong>Direcci√≥n</strong></p>
          <p class="text-success mb-2">{{ page.get('address','') }}, {{ page.get('city','') }}, {{ page.get('state','') }} {{ page.get('postal_code','') }}</p>
          {% set has_coords = page.get('lat') is not none and page.get('lng') is not none %}
          {% if has_coords %}
            <div id="map" class="mb-2"></div>
            <div class="d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-brand btn-sm" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ page.lat }},{{ page.lng }}" data-track="click_maps"><i class="bi bi-geo-alt me-1"></i>C√≥mo llegar</a>
            </div>
          {% else %}
            <div class="alert alert-warning">A√∫n no hay coordenadas guardadas.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- GALER√çA (usa portada + media_gallery + galeria) -->
  <section id="galeria" class="container my-5">
    <div class="d-flex justify-content-between align-items-center gap-2 mb-3 flex-wrap">
      <h2 class="section-title mb-0 d-flex align-items-center gap-2">
        <span class="badge bg-warning-subtle text-warning-emphasis rounded-pill"><i class="bi bi-images"></i></span>
        Galer√≠a
      </h2>
      {% if page.get('address') %}
      <span class="text-muted small"><i class="bi bi-geo-alt"></i> {{ page.address }}</span>
      {% endif %}
    </div>

    {% set tiene_portada = page.get('cover_image') %}
    {% set tiene_media = page.get('media_gallery') and page.media_gallery|length > 0 %}
    {% set tiene_galeria_vieja = galeria and galeria|length > 0 %}

    {% if tiene_portada or tiene_media or tiene_galeria_vieja %}
    <div class="gallery-grid">
      {% if tiene_portada %}
      <div class="gal-item" data-type="image" data-src="{{ url_for('uploaded_file', filename=page.cover_image) }}">
        <img src="{{ url_for('uploaded_file', filename=page.cover_image) }}" alt="Portada">
        <span class="badge-type"><i class="bi bi-image"></i> Portada</span>
      </div>
      {% endif %}

      {% if tiene_media %}
        {% for item in page.media_gallery %}
          {% if item is string %}
            <div class="gal-item" data-type="image" data-src="{{ url_for('uploaded_file', filename=item) }}">
              <img src="{{ url_for('uploaded_file', filename=item) }}" alt="Imagen de la galer√≠a">
              <span class="badge-type"><i class="bi bi-image"></i> Imagen</span>
            </div>
          {% else %}
            {% set fpath = item.path %}
            {% set ftype = item.type or 'image' %}
            {% if ftype == 'video' %}
              <div class="gal-item" data-type="video" data-src="{{ url_for('uploaded_file', filename=fpath) }}">
                <video src="{{ url_for('uploaded_file', filename=fpath) }}" muted playsinline></video>
                <span class="badge-type"><i class="bi bi-play-fill"></i> Video</span>
              </div>
            {% else %}
              <div class="gal-item" data-type="image" data-src="{{ url_for('uploaded_file', filename=fpath) }}">
                <img src="{{ url_for('uploaded_file', filename=fpath) }}" alt="Imagen de la galer√≠a">
                <span class="badge-type"><i class="bi bi-image"></i> Imagen</span>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {% if tiene_galeria_vieja %}
        {% for g in (galeria or [])[:8] %}
        <div class="gal-item" data-type="image" data-src="{{ url_for('uploaded_file', filename=g) }}">
          <img loading="lazy" src="{{ url_for('uploaded_file', filename=g) }}" alt="Foto {{ loop.index }}">
          <span class="badge-type"><i class="bi bi-image"></i> Galer√≠a</span>
        </div>
        {% endfor %}
      {% endif %}
    </div>
    {% else %}
      <div class="card-soft p-3 text-secondary">Carga una portada o im√°genes para mostrarlas aqu√≠.</div>
    {% endif %}
  </section>

  <!-- NOVEDADES -->
  {% if posts and posts|length>0 %}
  <section class="container my-5">
    <h2 class="section-title mb-3">üì∞ Novedades</h2>
    <div class="row g-3">
      {% for post in posts[:3] %}
      <div class="col-12 col-sm-6 col-lg-4 d-flex">
        <article class="card-soft d-flex flex-column w-100">
          {% if post.get('cabecera') %}
            <img loading="lazy" src="{{ url_for('uploaded_file', filename=post.cabecera) }}" alt="Imagen de {{ post.title }}" style="width:100%;aspect-ratio:16/9;object-fit:cover;">
          {% endif %}
          <div class="p-3 d-flex flex-column flex-grow-1">
            <h6 class="fw-bold mb-1">{{ post.title }}</h6>
            <p class="text-success small mb-3">{{ post.content[:110] }}...</p>
            <div class="mt-auto">
              <a href="{{ url_for('ver_post', post_id=post._id) }}" class="btn btn-brand w-100">Leer m√°s</a>
            </div>
          </div>
        </article>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- RESE√ëAS -->
  <section id="rese√±as" class="container my-5">
    <h2 class="section-title mb-3">‚≠ê Rese√±as</h2>
    <div class="card-soft p-3 p-md-4 mb-4">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-info mb-3">
            {% for message in messages %}<div>{{ message }}</div>{% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      <form method="POST" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tu nombre</label>
          <input type="text" name="nombre" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Calificaci√≥n</label>
          <div id="starRating" class="fs-4">
            {% for i in range(1,6) %}
              <i class="bi bi-star-fill text-secondary me-1 star-icon" data-value="{{ i }}"></i>
            {% endfor %}
          </div>
          <input type="hidden" name="estrellas" id="estrellas" value="0" required>
        </div>
        <div class="col-12">
          <label class="form-label">Comentario</label>
          <textarea name="comentario" class="form-control" rows="3" required></textarea>
        </div>
        <div class="col-12 d-grid d-md-inline">
          <button class="btn btn-brand">Enviar rese√±a</button>
        </div>
      </form>
    </div>

    {% if rese√±as and rese√±as|length>0 %}
    <div class="row g-3">
      {% for r in rese√±as %}
      <div class="col-12 col-md-6">
        <div class="card-soft h-100 p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0">{{ r.nombre }}</h6>
            <div>
              {% for i in range(1,6) %}
                {% if i <= r.estrellas %}
                  <i class="bi bi-star-fill text-warning"></i>
                {% else %}
                  <i class="bi bi-star text-secondary"></i>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <p class="mt-2 mb-1">{{ r.comentario }}</p>
          <small class="text-success">{{ r.fecha.strftime('%d/%m/%Y') }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <p class="text-warning">A√∫n no hay rese√±as.</p>
    {% endif %}
  </section>

  <!-- CTA STICKY -->
  <div class="cta-stick py-2">
    <div class="container d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <strong class="text-white"><i class="bi bi-bag-heart me-1"></i> ¬øSe te antoj√≥ algo?</strong>
      <div class="d-flex gap-2">
        <a href="#menu" class="btn btn-light btn-sm"><i class="bi bi-egg-fried me-1"></i> Ver men√∫</a>
        {% if page.get('whatsapp') %}
        <a class="btn btn-dark btn-sm" href="#reservas" data-track="click_whatsapp_fab"><i class="bi bi-calendar-check me-1"></i> Reservar</a>
        {% endif %}
      </div>
    </div>
  </div>
<!-- Reservas  -->
  {% include "public/reservas.html" %}
  <!-- FOOTER -->
  <footer class="mt-5 py-4" style="background: linear-gradient(90deg, var(--brand), var(--brand-2)); color:#fff">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
      <div class="mb-2 mb-md-0">¬© {{ now().year if now else 2025 }} <strong>{{ page.get('business_name','Restaurante') }}</strong></div>
      <div class="d-flex gap-3">
        {% if page.get('facebook') %}<a class="text-white" href="{{ page.facebook }}" target="_blank" aria-label="Facebook"><i class="bi bi-facebook"></i></a>{% endif %}
        {% if page.get('instagram') %}<a class="text-white" href="{{ page.instagram }}" target="_blank" aria-label="Instagram"><i class="bi bi-instagram"></i></a>{% endif %}
        {% if page.get('tiktok') %}<a class="text-white" href="{{ page.tiktok }}" target="_blank" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>{% endif %}
      </div>
    </div>
  </footer>

  <!-- WhatsApp flotante -->
  {% if page.get('whatsapp') %}
  <a class="floating-wa" href="#menu" aria-label="WhatsApp pedido r√°pido" data-track="click_whatsapp_fab">
    <i class="bi bi-whatsapp fs-4"></i>
  </a>
  {% endif %}

  <!-- Bot√≥n MEN√ö DIGITAL -->
  {% if productos_fisicos and productos_fisicos|length>0 %}
  <button class="floating-menu" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenuDigital" aria-controls="offcanvasMenuDigital">
    <i class="bi bi-phone-vibrate"></i>
    <div>
      <div style="font-weight:600;font-size:.75rem;">Men√∫ digital</div>
      <small>Tocar para ver</small>
    </div>
  </button>
  {% endif %}

  <!-- Offcanvas MEN√ö DIGITAL -->
  <div class="offcanvas offcanvas-end offcanvas-menu" tabindex="-1" id="offcanvasMenuDigital" aria-labelledby="offcanvasMenuDigitalLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title d-flex gap-2 align-items-center" id="offcanvasMenuDigitalLabel">
        <i class="bi bi-egg-fried"></i> {{ page.get('business_name','Men√∫') }}
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      {% if hay_menu_items %}
        {% for categoria, items in categorias.items() %}
        <div class="mb-3">
          <h6 class="text-uppercase small text-muted mb-2">{{ categoria }}</h6>
          <div class="list-group list-group-flush">
            {% for it in items %}
            <div class="list-group-item d-flex justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-semibold">{{ it.title }}</div>
                {% if it.get('description') %}
                  <div class="text-white-50 small">{{ it.description }}</div>
                {% endif %}
              </div>
              {% if it.get('show_price') %}
              <span class="badge bg-light text-dark rounded-pill">${{ "%.2f"|format(it.price) }}</span>
              {% endif %}
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      {% else %}
      <p class="text-white-50">No hay platillos a√∫n.</p>
      {% endif %}
    </div>
  </div>

  <!-- Modal zoom galer√≠a -->
  <div class="modal fade" id="zoomModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content bg-transparent border-0">
        <div class="modal-body p-0">
          <img src="" alt="Imagen ampliada" id="zoomedImage" class="img-fluid rounded shadow d-none">
        </div>
        <div class="modal-footer border-0 justify-content-center">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
  // Estrellas rese√±as
  (() => {
    const stars = document.querySelectorAll('.star-icon');
    const input = document.getElementById('estrellas');
    if(!stars.length) return;
    stars.forEach(s=>{
      s.addEventListener('click', ()=>{
        const v = parseInt(s.dataset.value);
        input.value = v;
        stars.forEach(i=>{
          const n = parseInt(i.dataset.value);
          i.classList.remove('text-warning','text-secondary');
          i.classList.add(n<=v ? 'text-warning' : 'text-secondary');
        });
      });
    });
  })();

  // Reserva por WhatsApp
  (() => {
    const form = document.getElementById('reservaForm');
    if(!form) return;
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const d = document.getElementById('res_date').value;
      const t = document.getElementById('res_time').value;
      const p = document.getElementById('res_people').value || '2';
      const notes = document.getElementById('res_notes').value || '';
      const to = "{{ (page.get('whatsapp') or '') | replace(' ','') }}";
      if(!to){ alert('No hay WhatsApp configurado.'); return; }
      let msg = `Hola, quiero reservar mesa:%0A- Fecha: ${d}%0A- Hora: ${t}%0A- Personas: ${p}`;
      if(notes) msg += `%0A- Notas: ${encodeURIComponent(notes)}`;
      const url = `https://wa.me/${to}?text=${msg}`;
      window.open(url, '_blank');
    });
  })();

  // Pedido por WhatsApp (usa productos_fisicos)
  (() => {
    const formPedido = document.getElementById('pedidoForm');
    if(!formPedido) return;

    const modalEl = document.getElementById('pedidoModal');
    const nombreInput = document.getElementById('pedidoNombreInput');
    const errorNombre = document.getElementById('pedidoErrorNombre');
    const resumenDiv = document.getElementById('pedidoResumen');
    const enviarBtn = document.getElementById('pedidoEnviarBtn');
    let lineas = [];

    formPedido.addEventListener('submit', (e)=>{
      e.preventDefault();
      lineas = [];

      formPedido.querySelectorAll('input[type=number]').forEach(inp=>{
        const n = parseInt(inp.value||"0");
        if(n>0){
          const nombre = inp.getAttribute('data-item-nombre') || inp.name.replace('item_','').replaceAll('_',' ');
          lineas.push(`- ${nombre}: ${n}`);
        }
      });

      if(!lineas.length){
        alert("Ingresa cantidad para al menos un platillo.");
        return;
      }

      if(resumenDiv){
        resumenDiv.innerHTML = lineas.map(l=>`<div>${l}</div>`).join('');
      }
      if(errorNombre){ errorNombre.classList.add('d-none'); }
      if(nombreInput){ nombreInput.classList.remove('is-invalid'); }

      new bootstrap.Modal(modalEl).show();
      setTimeout(()=>{ if(nombreInput){ nombreInput.focus(); }},200);
    });

    if(enviarBtn){
      enviarBtn.addEventListener('click', ()=>{
        const nombre = (nombreInput && nombreInput.value || '').trim();
        if(!nombre){
          errorNombre && errorNombre.classList.remove('d-none');
          nombreInput && nombreInput.classList.add('is-invalid');
          nombreInput && nombreInput.focus();
          return;
        }
        const wa = "{{ (page.get('whatsapp') or '') | replace(' ','') }}";
        if(!wa){ alert('No hay WhatsApp configurado.'); return; }

        let msj = `Hola, soy ${encodeURIComponent(nombre)} y quiero pedir:%0A`;
        lineas.forEach(l=>{
          msj += encodeURIComponent(l) + "%0A";
        });

        const url = `https://wa.me/${wa}?text=${msj}`;
        window.open(url,'_blank');
      });
    }
  })();

  // Mapa Leaflet
  (() => {
    const lat = {{ page.get('lat') if page.get('lat') is not none else 'null' }};
    const lng = {{ page.get('lng') if page.get('lng') is not none else 'null' }};
    if(lat!==null && lng!==null){
      const map = L.map('map', {scrollWheelZoom:false}).setView([lat,lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      L.marker([lat,lng]).addTo(map).bindPopup({{ page.get('business_name','"Restaurante"')|tojson }});
      setTimeout(()=>map.invalidateSize(), 300);
    }
  })();

  // Tabs categor√≠a + b√∫squeda (para productos_fisicos)
  (() => {
    const cols = [...document.querySelectorAll('.menu-col')];
    if(!cols.length) return;

    const tabsWrap = document.getElementById('menuTabs');
    const search = document.getElementById('menuSearch');

    const cats = [...new Set(cols.map(c => c.dataset.category))].sort((a,b)=>a.localeCompare(b,'es'));

    const mkBtn = (label, val, active=false) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn' + (active ? ' active' : '');
      b.textContent = label;
      b.dataset.cat = val || '';
      b.addEventListener('click', () => {
        [...tabsWrap.querySelectorAll('.btn')].forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        filter();
      });
      return b;
    };

    tabsWrap.appendChild(mkBtn('Todo','',true));
    cats.forEach(c => tabsWrap.appendChild(mkBtn(c,c,false)));

    function filter(){
      const q = (search.value || '').toLowerCase().trim();
      const active = tabsWrap.querySelector('.btn.active')?.dataset.cat || '';

      cols.forEach(col => {
        const catOk = !active || col.dataset.category === active;
        const items = col.querySelectorAll('.menu-card');
        let visibleCount = 0;

        items.forEach(it=>{
          const name = (it.dataset.name||'').toLowerCase();
          const tags = (it.dataset.tags||'').toLowerCase();
          const match = !q || name.includes(q) || tags.includes(q);
          it.style.display = (catOk && match) ? '' : 'none';
          if(catOk && match) visibleCount++;
        });

        col.style.display = visibleCount ? '' : 'none';
      });
    }

    search?.addEventListener('input', filter);
  })();

  // Zoom galer√≠a
  (() => {
    const items = document.querySelectorAll('.gal-item');
    const modalEl = document.getElementById('zoomModal');
    const zoomedImage = document.getElementById('zoomedImage');
    let videoEl = null;

    items.forEach(it => {
      it.addEventListener('click', () => {
        const type = it.getAttribute('data-type');
        const src = it.getAttribute('data-src');
        const modal = new bootstrap.Modal(modalEl);

        if (type === 'video') {
          zoomedImage.classList.add('d-none');
          if (!videoEl) {
            videoEl = document.createElement('video');
            videoEl.controls = true;
            videoEl.style.width = '100%';
            videoEl.style.borderRadius = '14px';
            modalEl.querySelector('.modal-body').prepend(videoEl);
          }
          videoEl.src = src;
          videoEl.classList.remove('d-none');
          modal.show();
        } else {
          if (videoEl) {
            videoEl.pause();
            videoEl.classList.add('d-none');
          }
          zoomedImage.src = src;
          zoomedImage.classList.remove('d-none');
          modal.show();
        }
      });
    });

    if (modalEl) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        if (videoEl) {
          videoEl.pause();
        }
      });
    }
  })();
  </script>
  <script>
/**
 * =========================================================
 *  PUBLIC MODULE: Analytics + Cotizar (Lead) + UX helpers
 *  Requiere endpoints:
 *   - POST /api/track
 *   - POST /api/leads
 *  Requiere que backend pase `slug` o que page.slug exista:
 *   ctx incluye: slug=slug
 * =========================================================
 */

const SITE_SLUG = "{{ slug or page.get('slug','') }}";
const BUSINESS_NAME = "{{ page.get('business_name','')|e }}";
const BUSINESS_WA = "{{ (page.get('whatsapp','') or '')|replace(' ','') }}";

/* -----------------------------
   Analytics: track() helper
------------------------------ */
function track(type, meta){
  try{
    if(!SITE_SLUG) return;
    fetch("/api/track", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ slug: SITE_SLUG, type, meta: meta || {} })
    }).catch(()=>{});
  }catch(e){}
}

// View event (al cargar)
track("view", { path: location.pathname, ref: document.referrer || "" });

/* Track clicks en cualquier elemento con data-track */
document.addEventListener("click", (e)=>{
  const el = e.target.closest("[data-track]");
  if(!el) return;
  const type = el.getAttribute("data-track");
  const href = el.getAttribute("href") || "";
  track(type, { href });
});

/* -----------------------------
   Zoom Modal (im√°genes)
------------------------------ */
(function zoomModule(){
  const zoomed = document.getElementById("zoomedImage");
  if(!zoomed) return;

  document.addEventListener("click", (e)=>{
    const img = e.target.closest(".img-zoom-trigger");
    if(!img) return;
    const src = img.getAttribute("data-img-src") || img.getAttribute("src");
    if(src) zoomed.src = src;
    track("open_zoom", { src: src || "" });
  });
})();

/* -----------------------------
   Star rating (rese√±as)
------------------------------ */
(function starsModule(){
  const stars = Array.from(document.querySelectorAll(".star-icon"));
  const input = document.getElementById("estrellas");
  if(!stars.length || !input) return;

  function paint(v){
    stars.forEach(s=>{
      const n = parseInt(s.dataset.value || "0", 10);
      if(n <= v){
        s.classList.remove("text-secondary");
        s.classList.add("text-warning");
      }else{
        s.classList.remove("text-warning");
        s.classList.add("text-secondary");
      }
    });
  }

  stars.forEach(s=>{
    s.style.cursor = "pointer";
    s.addEventListener("click", ()=>{
      const v = parseInt(s.dataset.value || "0", 10);
      input.value = String(v);
      paint(v);
      track("rate_star_select", { value: v });
    });
  });
})();

/* -----------------------------
   Cotizar -> Modal -> WhatsApp
   + Save lead server-side
------------------------------ */
(async function cotizarModule(){
  const form = document.getElementById("form-cotizar");
  const modalEl = document.getElementById("cotizarModal");
  const resumenEl = document.getElementById("resumenSeleccion");
  const nombreInput = document.getElementById("nombreClienteInput");
  const errNombre = document.getElementById("errorModalNombre");
  const enviarBtn = document.getElementById("enviarCotizacionBtn");

  if(!form || !modalEl || !resumenEl || !nombreInput || !enviarBtn) return;

  // Bootstrap modal instance
  const bsModal = bootstrap.Modal.getOrCreateInstance(modalEl);

  let selectedItems = []; // [{title, qty}]

  function getSelectedItems(){
    const inputs = Array.from(form.querySelectorAll('input[type="number"][data-item-nombre]'));
    const items = [];
    for(const inp of inputs){
      const title = (inp.dataset.itemNombre || "").trim();
      const qty = parseInt(inp.value || "0", 10);
      if(title && Number.isFinite(qty) && qty > 0){
        items.push({ title, qty });
      }
    }
    return items;
  }

  function renderResumen(items){
    if(!items.length){
      resumenEl.innerHTML = `<div class="text-muted">No seleccionaste nada todav√≠a.</div>`;
      return;
    }
    resumenEl.innerHTML = items.map(it => {
      return `<div>‚Ä¢ <strong>${escapeHtml(it.title)}</strong> √ó ${it.qty}</div>`;
    }).join("");
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    selectedItems = getSelectedItems();

    if(!selectedItems.length){
      track("cotizar_empty", {});
      // feedback simple sin alert fea
      resumenEl.innerHTML = `<div class="text-danger fw-bold">Selecciona al menos 1 producto/servicio con cantidad > 0.</div>`;
      bsModal.show();
      return;
    }

    track("cotizar_open_modal", { items: selectedItems.length });
    renderResumen(selectedItems);
    errNombre.classList.add("d-none");
    nombreInput.value = "";
    bsModal.show();
    setTimeout(()=> nombreInput.focus(), 150);
  });

  async function createLead(nombre, items){
    try{
      const r = await fetch("/api/leads", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          slug: SITE_SLUG,
          nombre,
          items,
          canal: "whatsapp"
        })
      });
      return await r.json();
    }catch(e){
      return { ok:false, error:"network" };
    }
  }

  function buildWhatsAppMessage(nombre, items){
    const lines = [];
    lines.push(`Hola, soy ${nombre}.`);
    lines.push(`Quisiera cotizar con ${BUSINESS_NAME}:`);
    for(const it of items){
      lines.push(`- ${it.title} x${it.qty}`);
    }
    lines.push(`Gracias.`);
    return lines.join("\n");
  }

  function openWhatsApp(text){
    if(!BUSINESS_WA){
      // fallback: no whatsapp definido
      alert("Este negocio a√∫n no tiene WhatsApp configurado.");
      return;
    }
    const url = `https://wa.me/${BUSINESS_WA}?text=${encodeURIComponent(text)}`;
    window.open(url, "_blank", "noopener");
  }

  enviarBtn.addEventListener("click", async ()=>{
    const nombre = (nombreInput.value || "").trim();

    if(!nombre){
      errNombre.classList.remove("d-none");
      track("cotizar_missing_name", {});
      nombreInput.focus();
      return;
    }

    if(!selectedItems.length){
      track("cotizar_missing_items", {});
      bsModal.hide();
      return;
    }

    enviarBtn.disabled = true;
    enviarBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Enviando...`;

    track("cotizar_send_click", { items: selectedItems.length });

    // 1) Guardar lead en servidor
    const resp = await createLead(nombre, selectedItems);

    // 2) Abrir WhatsApp SIEMPRE (no romper UX)
    const msg = buildWhatsAppMessage(nombre, selectedItems);
    openWhatsApp(msg);

    // 3) Track resultado lead
    if(resp && resp.ok){
      track("lead_saved", { lead_id: resp.lead_id || "" });
    }else{
      track("lead_save_failed", { error: (resp && resp.error) || "unknown" });
    }

    // reset UI
    setTimeout(()=>{
      enviarBtn.disabled = false;
      enviarBtn.innerHTML = `<i class="bi bi-whatsapp me-1"></i> Enviar por WhatsApp`;
      bsModal.hide();
    }, 250);
  });

})();
</script>

</body>
</html>
