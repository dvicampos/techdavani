<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{{ page.get('business_name','Restaurante') }}</title>
  <meta name="description" content="{{ page.get('slogan') or page.get('description','')[:160] }}">
  <meta name="keywords" content="{{ page.get('category','Restaurante') }}, comida, menú, reservaciones">
  <meta name="author" content="{{ page.get('business_name','') }}">

  <!-- OG / Twitter -->
  <meta property="og:title" content="{{ page.get('business_name','Restaurante') }}">
  <meta property="og:description" content="{{ page.get('slogan') or page.get('description','')[:200] }}">
  <meta property="og:image" content="{{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True) }}">
  <meta property="og:url" content="{{ request.url }}">
  <meta property="og:type" content="restaurant">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Favicon / CSS -->
  <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" type="image/png" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --brand: {{ "'" ~ (page.get('color') or '#c2410c') ~ "'" }};
      --brand-2: color-mix(in oklab, var(--brand) 70%, #000 30%);
      --bg:#0b0f14; --card:#0f141b; --ink:#e5e7eb; --muted:#9aa4b2; --line:#1f2937;
      --radius:16px; --shadow:0 16px 40px rgba(0,0,0,.24);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#fafafa; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; }
    }

    html{scroll-behavior:smooth}
    body{
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg); color:var(--ink)
    }

    /* NAV */
    .navbar{
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      backdrop-filter: saturate(1.2) blur(6px);
    }
    .navbar .nav-link{ color:#fff; font-weight:600; opacity:.9 }
    .navbar .nav-link:hover,.navbar .nav-link.active{ opacity:1 }

    /* HERO */
    .hero{
      position: relative;
      background:
        radial-gradient(900px 400px at -10% -20%, color-mix(in oklab, var(--brand) 38%, #fff 62%) 0%, transparent 55%),
        linear-gradient(180deg, color-mix(in oklab, var(--bg) 90%, #000 10%) 0%, var(--bg) 100%);
      border-bottom:1px solid var(--line);
      overflow: clip;
    }
    .hero::after{
      content:""; position:absolute; inset:auto -10% -40% -10%; height:55%;
      background: radial-gradient(50% 60% at 50% 0%, color-mix(in oklab, var(--brand) 35%, transparent) 0%, transparent 70%);
      pointer-events:none;
    }
    .hero-logo{
      inline-size:min(240px,45vw); block-size:min(240px,45vw);
      object-fit:cover; border-radius:999px; border:3px solid #fff;
      box-shadow:0 12px 36px rgba(2,6,23,.25);
    }
    .pill{
      display:inline-flex; gap:.5rem; align-items:center; padding:.35rem .75rem;
      border-radius:999px; background:rgba(255,255,255,.14); color:#fff;
      border:1px solid rgba(255,255,255,.24)
    }
    .chips .chip{
      display:inline-block; padding:.25rem .6rem; border:1px solid var(--line);
      border-radius:999px; color:var(--muted); margin:.25rem .35rem .25rem 0;
      font-weight:600; font-size:.85rem
    }

    .btn-brand{
      background:var(--brand)!important; border-color:var(--brand)!important;
      color:#fff!important; font-weight:700
    }
    .btn-brand:hover{ filter:brightness(.96) }
    .btn-outline-brand{
      border-color:var(--brand)!important; color:var(--brand)!important
    }
    .btn-outline-brand:hover{
      background:var(--brand)!important; color:#fff!important
    }

    .card-soft{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .section-title{ font-weight:800; letter-spacing:.2px }

    /* ===== MENÚ (SOLO PRODUCTOS_FISICOS / PLATILLOS) ===== */
    .menu-tools{ gap:.6rem; flex-wrap:wrap }
    .menu-search{ max-width:480px }
    .tabs .btn{
      --bs-btn-padding-y:.4rem; --bs-btn-padding-x:.9rem; --bs-btn-border-radius:999px;
      border:1px solid var(--line); background:transparent; color:var(--ink); font-weight:600
    }
    .tabs .btn.active{ background:var(--brand); color:#fff; border-color:transparent }

    .menu-card{
      display:flex; flex-wrap:wrap;
      gap:14px; align-items:flex-start;
      padding:12px; border-bottom:1px dashed var(--line)
    }
    .menu-card:last-child{ border-bottom:0 }

    .menu-thumb{
      width:86px; height:86px; border-radius:12px; object-fit:cover;
      border:1px solid var(--line); background:#fff
    }
    .menu-name{ font-weight:800 }
    .menu-price{ font-weight:800; color:var(--brand) }
    .badge-diet{
      font-size:.72rem; border:1px solid var(--line);
      border-radius:999px; padding:.12rem .45rem;
      color:var(--muted)
    }

    .pedido-box label{
      font-size:.7rem; color:var(--muted); margin:0;
    }
    .pedido-box input{min-width:70px;}

    /* ===== SERVICIOS EXTRA (catering, eventos, etc) ===== */
    .service-card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      height:100%;
      padding:1rem 1.25rem;
    }
    .service-title{
      font-weight:700;
      color:var(--ink);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .service-price{
      font-weight:800;
      color:var(--brand);
      white-space:nowrap;
    }
    .service-desc{
      color:var(--muted);
      font-size:.9rem;
      margin-top:.5rem;
      margin-bottom:1rem;
    }

    /* GALERÍA */
    .gallery img{
      width:100%; aspect-ratio: 1/1;
      object-fit:cover; border-radius:10px; border:1px solid var(--line)
    }

    /* MAPA */
    #map{
      height: 340px; border-radius:16px;
      border:1px solid var(--line); overflow:hidden;
      box-shadow:var(--shadow)
    }

    /* RESEÑAS */
    .star{ color:#fbbf24 }

    /* CTA sticky bottom */
    .cta-stick{
      position:sticky; bottom:0; inset-inline:0; z-index:1020;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      border-top:1px solid rgba(255,255,255,.15);
      backdrop-filter: saturate(1.2) blur(6px);
    }

    /* WhatsApp flotante */
    .floating-wa{
      position: fixed; bottom: 18px; right: 18px; z-index: 1050;
      background:#25D366; color:#fff; border-radius:999px;
      padding:.7rem .9rem; box-shadow:0 12px 34px rgba(37,211,102,.35);
    }
    .floating-wa:hover{ color:#fff; filter:brightness(.95) }

    @media (max-width: 991.98px){
      .menu-thumb{ width:74px; height:74px }
      .menu-card{ padding:10px }
    }
    @media (max-width: 767.98px){
      .navbar-brand{ font-size:1.05rem }
      .section-title{ font-size:1.25rem }
      .btn-brand,.btn-outline-brand{ width:100% }
      .menu-name,.menu-price{ font-size:1rem }
    }
    @media (min-width: 1200px){
      .container{ max-width: 1140px }
    }

    /* Avisos inline */
    .avisos-inline{
      border:1px solid var(--line);
      border-radius:12px;
      background: color-mix(in oklab, var(--brand) 10%, var(--card));
      box-shadow: var(--shadow);
    }
    .avisos-inline .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.25rem .6rem; border-radius:999px;
      border:1px dashed var(--line);
      color:var(--ink); font-weight:600;
      white-space:nowrap;
    }
    .avisos-inline time{
      color:var(--muted); font-size:.8rem
    }
    .modal-content{
      background-color: #000 !important;
    }
  </style>

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Restaurant",
    "name": {{ page.get('business_name','"Restaurante"')|tojson }},
    "description": {{ (page.get('description') or page.get('slogan') or '')|tojson }},
    "servesCuisine": {{ (page.get('category') or 'Comida')|tojson }},
    "image": {{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True)|tojson }},
    "telephone": {{ (page.get('phone') or '')|tojson }},
    "address": {
      "@type":"PostalAddress",
      "streetAddress": {{ (page.get('address') or '')|tojson }},
      "addressLocality": {{ (page.get('city') or '')|tojson }},
      "addressRegion": {{ (page.get('state') or '')|tojson }},
      "postalCode": {{ (page.get('postal_code') or '')|tojson }},
      "addressCountry": "MX"
    },
    "url": {{ request.url|tojson }}
  }
  </script>
</head>
<body data-bs-spy="scroll" data-bs-target="#mainNavbar" data-bs-offset="80" tabindex="0">

  <!-- NAV -->
  <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/">{{ page.get('business_name','Restaurante') }}</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navcollapse" aria-label="Abrir navegación">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="navcollapse" class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#menu">Menú</a></li>
          <li class="nav-item"><a class="nav-link" href="#servicios">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="#reservas">Reservas</a></li>
          <li class="nav-item"><a class="nav-link" href="#info">Información</a></li>
          <li class="nav-item"><a class="nav-link" href="#galeria">Galería</a></li>
          <li class="nav-item"><a class="nav-link" href="#reseñas">Reseñas</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero pt-6" style="padding-top:94px;">
    <div class="container py-4 py-md-5">
      <div class="row align-items-center g-4">
        <div class="col-md-4 text-center">
          {% if page.get('image') %}
            <img loading="lazy" src="{{ url_for('uploaded_file', filename=page['image']) }}" class="hero-logo" alt="Logo {{ page.get('business_name','') }}">
          {% else %}
            <img loading="lazy" src="{{ url_for('static', filename='images/default_image.png') }}" class="hero-logo" alt="Logo del negocio">
          {% endif %}
        </div>
        <div class="col-md-8">
          {% if page.get('slogan') %}
            <span class="pill mb-2"><i class="bi bi-fire"></i>{{ page['slogan'] }}</span>
          {% endif %}
          <h1 class="display-6 fw-extrabold mb-2">{{ page.get('business_name','Restaurante') }}</h1>

          <!-- chips de features generales -->
          <div class="chips mt-2">
            {% for tag in (page.get('services','') or '').split(',') if tag.strip() %}
              <span class="chip">{{ tag.strip() }}</span>
            {% endfor %}
          </div>

          <div class="mt-3 d-flex flex-wrap gap-2">
            {% if page.get('whatsapp') %}
              <a class="btn btn-brand" href="#menu"><i class="bi bi-bag-heart me-1"></i> Hacer pedido</a>
            {% endif %}
            {% if page.get('phone') %}
              <a class="btn btn-outline-brand" href="tel:{{ page.phone }}"><i class="bi bi-telephone me-1"></i> Llamar</a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- AVISOS -->
  {% if avisos and avisos|length>0 %}
  <section class="container my-4">
    <div class="avisos-inline p-3">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-megaphone-fill fs-5 text-white"></i>
          <strong class="section-title m-0">Avisos</strong>
        </div>
        <button class="btn btn-outline-brand btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#avisosLista">
          Ver todos
        </button>
      </div>

      <div class="mt-2 d-flex flex-wrap gap-2">
        {% for a in avisos[:3] %}
          <span class="chip">
            <i class="bi bi-dot"></i>
            <span><strong>{{ a.title }}</strong> — {{ a.content }}</span>
            {% if a.date %}<time class="ms-1">{{ a.date.strftime("%d/%m/%Y") }}</time>{% endif %}
          </span>
        {% endfor %}
        {% if avisos|length > 3 %}
          <span class="chip"><i class="bi bi-plus-circle"></i> {{ avisos|length - 3 }} más</span>
        {% endif %}
      </div>

      <div id="avisosLista" class="collapse mt-2">
        <ul class="m-0 ps-0" style="list-style:none">
          {% for a in avisos %}
          <li class="py-2 border-top" style="border-color:var(--line)!important">
            <strong>{{ a.title }}</strong> — {{ a.content }}
            {% if a.date %}<time class="ms-2">{{ a.date.strftime('%d/%m/%Y') }}</time>{% endif %}
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </section>
  {% endif %}

  <!-- MENÚ (usa productos_fisicos = comida/platillos) -->
  <section id="menu" class="container my-5">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
      <h2 class="section-title m-0">🍽️ Menú</h2>

      <div class="menu-tools d-flex">
        <input id="menuSearch" type="search" class="form-control menu-search" placeholder="Buscar platillo o ingrediente…">
        <div id="menuTabs" class="tabs btn-group" role="group" aria-label="Categorías"></div>
      </div>
    </div>

    {% set hay_menu_items = (productos_fisicos and productos_fisicos|length>0) %}

    {% if hay_menu_items %}
      {# agrupamos productos_fisicos por categoría #}
      {% set categorias = {} %}
      {% for it in (productos_fisicos or []) %}
        {% set cat = it.get('category') or 'Platillos' %}
        {% if cat not in categorias %}
          {% set _ = categorias.update({cat: []}) %}
        {% endif %}
        {% set _ = categorias[cat].append(it) %}
      {% endfor %}

      {% if page.get('whatsapp') %}
      <div class="card-soft p-3 mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="text-white fw-semibold">
            <i class="bi bi-bag-heart me-2"></i>
            Selecciona cantidades y pulsa “Pedir por WhatsApp”.
          </div>
          <small class="text-success">
            No pagas aquí — solo mandas el pedido 😌
          </small>
        </div>
      </div>
      {% endif %}

      <form id="pedidoForm">
        <div id="menuGrid" class="row g-4">
          {% for categoria, items in categorias.items() %}
          <div class="col-12 menu-col" data-category="{{ categoria|e }}">
            <div class="card-soft p-3 h-100">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <h5 class="m-0">{{ categoria }}</h5>
                <span class="badge text-bg-dark">{{ items|length }}</span>
              </div>

              {% for it in items %}
              <article class="menu-card"
                       data-name="{{ (it.title or '')|e }}"
                       data-tags="{{ (it.tags or '')|e }}">
                {% if it.get('image') %}
                  <img class="menu-thumb" loading="lazy" src="{{ url_for('uploaded_file', filename=it.image) }}" alt="{{ it.title }}">
                {% else %}
                  <img class="menu-thumb" loading="lazy" src="{{ url_for('static', filename='img/default-product.png') }}" alt="Imagen">
                {% endif %}

                <div class="flex-grow-1 w-100">
                  <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap w-100">
                    <div class="flex-grow-1 me-auto">
                      <div class="menu-name">{{ it.title }}</div>

                      {% if it.get('description') %}
                        <div class="text-success small">{{ it.description }}</div>
                      {% endif %}

                      {% if it.get('tags') %}
                        <div class="mt-1">
                          {% for t in it.tags.split(',') if t.strip() %}
                            <span class="badge-diet me-1">{{ t.strip() }}</span>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </div>

                    <div class="text-end pedido-box" style="min-width:90px">
                      {% if it.get('show_price') %}
                        <div class="menu-price text-nowrap">
                          ${{ "%.2f"|format(it.price) }}
                        </div>
                      {% endif %}
                      <label class="form-label mt-2">Cant.</label>
                      <input
                        type="number"
                        class="form-control form-control-sm pedido-input"
                        min="0"
                        value="0"
                        name="item_{{ it.title | replace(' ','_') }}"
                        data-item-nombre="{{ it.title }}">
                    </div>
                  </div>
                </div>
              </article>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>

        {% if page.get('whatsapp') %}
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-brand px-4">
            <i class="bi bi-whatsapp me-1"></i> Pedir por WhatsApp
          </button>
        </div>
        {% endif %}
      </form>

      <!-- Modal confirmación pedido -->
      <div class="modal fade" id="pedidoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content" style="border-radius:16px;">
            <div class="modal-header" style="background:linear-gradient(90deg, var(--brand), var(--brand-2)); color:#fff; border:none;">
              <h5 class="modal-title fw-bold">Tu pedido 📝</h5>
              <button class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Tu nombre</label>
                <input type="text" class="form-control" id="pedidoNombreInput" placeholder="Ej. Carlos">
                <div class="text-danger small mt-1 d-none" id="pedidoErrorNombre">Por favor, escribe tu nombre.</div>
              </div>
              <div>
                <div class="form-label mb-1">Resumen:</div>
                <div id="pedidoResumen" class="border rounded p-2 small" style="max-height:220px;overflow-y:auto;"></div>
              </div>
            </div>
            <div class="modal-footer" style="border:none;">
              <button class="btn btn-outline-brand" data-bs-dismiss="modal">Editar</button>
              <button class="btn btn-brand" id="pedidoEnviarBtn">
                <i class="bi bi-whatsapp me-1"></i>Enviar por WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="alert alert-warning text-warning bg-transparent border border-warning">
        Aún no hay platillos / productos cargados.
      </div>
    {% endif %}
  </section>

  <!-- SERVICIOS -->
  <section id="servicios" class="container my-5">
    {% if servicios and servicios|length>0 %}
      <h2 class="section-title mb-3">🛎 Servicios especiales</h2>
      <div class="row g-4">
        {% for s in servicios %}
        <div class="col-md-6 col-lg-4 d-flex">
          <div class="service-card d-flex flex-column w-100">
            <div class="service-title">
              <span>{{ s.title }}</span>
              {% if s.get('show_price') %}
                <span class="service-price">${{ "%.2f"|format(s.price) }}</span>
              {% endif %}
            </div>

            {% if s.get('description') %}
              <div class="service-desc">{{ s.description }}</div>
            {% endif %}

            {% if page.get('whatsapp') %}
              <a class="btn btn-outline-brand w-100 mt-auto"
                 href="https://wa.me/{{ page.whatsapp | replace(' ','') }}?text={{ ('Hola, me interesa el servicio: ' ~ s.title)|urlencode }}"
                 target="_blank">
                <i class="bi bi-whatsapp me-1"></i> Preguntar por WhatsApp
              </a>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </section>

  <!-- RESERVAS -->
  <section id="reservas" class="container my-5">
    <h2 class="section-title mb-3">📆 Reservas</h2>
    <div class="card-soft p-3 p-md-4">
      {% if page.get('whatsapp') %}
      <form id="reservaForm" class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Fecha</label>
          <input type="date" class="form-control" id="res_date" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Hora</label>
          <input type="time" class="form-control" id="res_time" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Personas</label>
          <input type="number" class="form-control" id="res_people" min="1" value="2" required>
        </div>
        <div class="col-12">
          <label class="form-label">Notas (opcional)</label>
          <input type="text" class="form-control" id="res_notes" placeholder="Ej. mesa cerca de ventana, aniversario…">
        </div>
        <div class="col-12 d-grid d-md-inline">
          <button type="submit" class="btn btn-brand"><i class="bi bi-whatsapp me-1"></i> Solicitar por WhatsApp</button>
        </div>
      </form>
      {% else %}
        <div class="alert alert-info m-0">Agrega tu número de WhatsApp en el panel para activar reservas.</div>
      {% endif %}
    </div>
  </section>

  <!-- INFO + UBICACIÓN -->
  <section id="info" class="container my-5">
    <h2 class="section-title mb-3">📝 Información</h2>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card-soft h-100 p-3">
          <p><i class="fa-solid fa-align-left me-2 text-primary"></i><strong>Quiénes somos:</strong> {{ page.get('description','') }}</p>
          <p><i class="fa-solid fa-utensils me-2 text-primary"></i><strong>Cocina:</strong> {{ page.get('category','Restaurante') }}</p>
          {% if page.get('operating_hours') %}
          <p><i class="fa-regular fa-clock me-2 text-primary"></i><strong>Horario:</strong> {{ page['operating_hours'] }}</p>
          {% endif %}
          {% if page.get('payment_methods') %}
          <p><i class="fa-regular fa-credit-card me-2 text-primary"></i><strong>Pagos:</strong> {{ page['payment_methods'] }}</p>
          {% endif %}
          {% if page.get('delivery_available') %}
          <p><i class="fa-solid fa-truck me-2 text-primary"></i><strong>Entrega a domicilio:</strong> Sí</p>
          {% endif %}
        </div>
      </div>
      <div class="col-md-6" id="ubicacion">
        <div class="card-soft h-100 p-3">
          <p class="mb-1"><i class="fa-solid fa-location-dot me-2 text-primary"></i><strong>Dirección</strong></p>
          <p class="text-success mb-2">{{ page.get('address','') }}, {{ page.get('city','') }}, {{ page.get('state','') }} {{ page.get('postal_code','') }}</p>
          {% set has_coords = page.get('lat') is not none and page.get('lng') is not none %}
          {% if has_coords %}
            <div id="map" class="mb-2"></div>
            <div class="d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-brand btn-sm" target="_blank" href="https://www.google.com/maps/dir/?api=1&destination={{ page.lat }},{{ page.lng }}"><i class="bi bi-geo-alt me-1"></i>Cómo llegar</a>
            </div>
          {% else %}
            <div class="alert alert-warning">Aún no hay coordenadas guardadas.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <!-- GALERÍA -->
  <section id="galeria" class="container my-5">
    <h2 class="section-title mb-3">📷 Galería</h2>
    <div class="row g-3 gallery">
      {% for g in (galeria or [])[:8] %}
      <div class="col-6 col-md-3">
        <img loading="lazy" src="{{ url_for('uploaded_file', filename=g) }}" alt="Foto {{ loop.index }}">
      </div>
      {% else %}
      <div class="col-12">
        <div class="card-soft p-3 text-secondary">Carga imágenes para mostrarlas en la galería.</div>
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- NOVEDADES -->
  {% if posts and posts|length>0 %}
  <section class="container my-5">
    <h2 class="section-title mb-3">📰 Novedades</h2>
    <div class="row g-3">
      {% for post in posts[:3] %}
      <div class="col-12 col-sm-6 col-lg-4 d-flex">
        <article class="card-soft d-flex flex-column w-100">
          {% if post.get('cabecera') %}
            <img loading="lazy" src="{{ url_for('uploaded_file', filename=post.cabecera) }}" alt="Imagen de {{ post.title }}" style="width:100%;aspect-ratio:16/9;object-fit:cover;">
          {% endif %}
          <div class="p-3 d-flex flex-column flex-grow-1">
            <h6 class="fw-bold mb-1">{{ post.title }}</h6>
            <p class="text-success small mb-3">{{ post.content[:110] }}...</p>
            <div class="mt-auto">
              <a href="{{ url_for('ver_post', post_id=post._id) }}" class="btn btn-brand w-100">Leer más</a>
            </div>
          </div>
        </article>
      </div>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- RESEÑAS -->
  <section id="reseñas" class="container my-5">
    <h2 class="section-title mb-3">⭐ Reseñas</h2>
    <div class="card-soft p-3 p-md-4 mb-4">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-info mb-3">
            {% for message in messages %}<div>{{ message }}</div>{% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      <form method="POST" class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Tu nombre</label>
          <input type="text" name="nombre" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Calificación</label>
          <div id="starRating" class="fs-4">
            {% for i in range(1,6) %}
              <i class="bi bi-star-fill text-secondary me-1 star-icon" data-value="{{ i }}"></i>
            {% endfor %}
          </div>
          <input type="hidden" name="estrellas" id="estrellas" value="0" required>
        </div>
        <div class="col-12">
          <label class="form-label">Comentario</label>
          <textarea name="comentario" class="form-control" rows="3" required></textarea>
        </div>
        <div class="col-12 d-grid d-md-inline">
          <button class="btn btn-brand">Enviar reseña</button>
        </div>
      </form>
    </div>

    {% if reseñas and reseñas|length>0 %}
    <div class="row g-3">
      {% for r in reseñas %}
      <div class="col-12 col-md-6">
        <div class="card-soft h-100 p-3">
          <div class="d-flex justify-content-between align-items-center">
            <h6 class="m-0">{{ r.nombre }}</h6>
            <div>
              {% for i in range(1,6) %}
                {% if i <= r.estrellas %}
                  <i class="bi bi-star-fill star"></i>
                {% else %}
                  <i class="bi bi-star text-secondary"></i>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <p class="mt-2 mb-1">{{ r.comentario }}</p>
          <small class="text-success">{{ r.fecha.strftime('%d/%m/%Y') }}</small>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <p class="text-warning">Aún no hay reseñas.</p>
    {% endif %}
  </section>

  <!-- CTA STICKY -->
  <div class="cta-stick py-2">
    <div class="container d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <strong class="text-white"><i class="bi bi-bag-heart me-1"></i> ¿Se te antojó algo?</strong>
      <div class="d-flex gap-2">
        <a href="#menu" class="btn btn-light btn-sm"><i class="bi bi-egg-fried me-1"></i> Ver menú</a>
        {% if page.get('whatsapp') %}
        <a class="btn btn-dark btn-sm" href="#reservas"><i class="bi bi-calendar-check me-1"></i> Reservar</a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="mt-5 py-4" style="background: linear-gradient(90deg, var(--brand), var(--brand-2)); color:#fff">
    <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
      <div class="mb-2 mb-md-0">© {{ now().year if now else 2025 }} <strong>{{ page.get('business_name','Restaurante') }}</strong></div>
      <div class="d-flex gap-3">
        {% if page.get('facebook') %}<a class="text-white" href="{{ page.facebook }}" target="_blank" aria-label="Facebook"><i class="bi bi-facebook"></i></a>{% endif %}
        {% if page.get('instagram') %}<a class="text-white" href="{{ page.instagram }}" target="_blank" aria-label="Instagram"><i class="bi bi-instagram"></i></a>{% endif %}
        {% if page.get('tiktok') %}<a class="text-white" href="{{ page.tiktok }}" target="_blank" aria-label="TikTok"><i class="bi bi-tiktok"></i></a>{% endif %}
      </div>
    </div>
  </footer>

  <!-- WhatsApp flotante -->
  {% if page.get('whatsapp') %}
  <a class="floating-wa" href="#menu" aria-label="WhatsApp pedido rápido">
    <i class="bi bi-whatsapp fs-4"></i>
  </a>
  {% endif %}

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

  <script>
  // Estrellas reseñas
  (() => {
    const stars = document.querySelectorAll('.star-icon');
    const input = document.getElementById('estrellas');
    if(!stars.length) return;
    stars.forEach(s=>{
      s.addEventListener('click', ()=>{
        const v = parseInt(s.dataset.value);
        input.value = v;
        stars.forEach(i=>{
          const n = parseInt(i.dataset.value);
          i.classList.remove('text-warning','text-secondary');
          i.classList.add(n<=v ? 'text-warning' : 'text-secondary');
        });
      });
    });
  })();

  // Reserva por WhatsApp
  (() => {
    const form = document.getElementById('reservaForm');
    if(!form) return;
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const d = document.getElementById('res_date').value;
      const t = document.getElementById('res_time').value;
      const p = document.getElementById('res_people').value || '2';
      const notes = document.getElementById('res_notes').value || '';
      const to = "{{ (page.get('whatsapp') or '') | replace(' ','') }}";
      if(!to){ alert('No hay WhatsApp configurado.'); return; }
      let msg = `Hola, quiero reservar mesa:%0A- Fecha: ${d}%0A- Hora: ${t}%0A- Personas: ${p}`;
      if(notes) msg += `%0A- Notas: ${encodeURIComponent(notes)}`;
      const url = `https://wa.me/${to}?text=${msg}`;
      window.open(url, '_blank');
    });
  })();

  // Pedido por WhatsApp (usa productos_fisicos)
  (() => {
    const formPedido = document.getElementById('pedidoForm');
    if(!formPedido) return;

    const modalEl = document.getElementById('pedidoModal');
    const nombreInput = document.getElementById('pedidoNombreInput');
    const errorNombre = document.getElementById('pedidoErrorNombre');
    const resumenDiv = document.getElementById('pedidoResumen');
    const enviarBtn = document.getElementById('pedidoEnviarBtn');
    let lineas = [];

    formPedido.addEventListener('submit', (e)=>{
      e.preventDefault();
      lineas = [];

      formPedido.querySelectorAll('input[type=number]').forEach(inp=>{
        const n = parseInt(inp.value||"0");
        if(n>0){
          const nombre = inp.getAttribute('data-item-nombre') || inp.name.replace('item_','').replaceAll('_',' ');
          lineas.push(`- ${nombre}: ${n}`);
        }
      });

      if(!lineas.length){
        alert("Ingresa cantidad para al menos un platillo.");
        return;
      }

      if(resumenDiv){
        resumenDiv.innerHTML = lineas.map(l=>`<div>${l}</div>`).join('');
      }
      if(errorNombre){ errorNombre.classList.add('d-none'); }
      if(nombreInput){ nombreInput.classList.remove('is-invalid'); }

      new bootstrap.Modal(modalEl).show();
      setTimeout(()=>{ if(nombreInput){ nombreInput.focus(); }},200);
    });

    if(enviarBtn){
      enviarBtn.addEventListener('click', ()=>{
        const nombre = (nombreInput && nombreInput.value || '').trim();
        if(!nombre){
          errorNombre && errorNombre.classList.remove('d-none');
          nombreInput && nombreInput.classList.add('is-invalid');
          nombreInput && nombreInput.focus();
          return;
        }
        const wa = "{{ (page.get('whatsapp') or '') | replace(' ','') }}";
        if(!wa){ alert('No hay WhatsApp configurado.'); return; }

        let msj = `Hola, soy ${encodeURIComponent(nombre)} y quiero pedir:%0A`;
        lineas.forEach(l=>{
          msj += encodeURIComponent(l) + "%0A";
        });

        const url = `https://wa.me/${wa}?text=${msj}`;
        window.open(url,'_blank');
      });
    }
  })();

  // Mapa Leaflet
  (() => {
    const lat = {{ page.get('lat') if page.get('lat') is not none else 'null' }};
    const lng = {{ page.get('lng') if page.get('lng') is not none else 'null' }};
    if(lat!==null && lng!==null){
      const map = L.map('map', {scrollWheelZoom:false}).setView([lat,lng], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      L.marker([lat,lng]).addTo(map).bindPopup({{ page.get('business_name','"Restaurante"')|tojson }});
      setTimeout(()=>map.invalidateSize(), 300);
    }
  })();

  // Tabs categoría + búsqueda (para productos_fisicos)
  (() => {
    const cols = [...document.querySelectorAll('.menu-col')];
    if(!cols.length) return;

    const tabsWrap = document.getElementById('menuTabs');
    const search = document.getElementById('menuSearch');

    const cats = [...new Set(cols.map(c => c.dataset.category))].sort((a,b)=>a.localeCompare(b,'es'));

    const mkBtn = (label, val, active=false) => {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'btn' + (active ? ' active' : '');
      b.textContent = label;
      b.dataset.cat = val || '';
      b.addEventListener('click', () => {
        [...tabsWrap.querySelectorAll('.btn')].forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        filter();
      });
      return b;
    };

    tabsWrap.appendChild(mkBtn('Todo','',true));
    cats.forEach(c => tabsWrap.appendChild(mkBtn(c,c,false)));

    function filter(){
      const q = (search.value || '').toLowerCase().trim();
      const active = tabsWrap.querySelector('.btn.active')?.dataset.cat || '';

      cols.forEach(col => {
        const catOk = !active || col.dataset.category === active;
        const items = col.querySelectorAll('.menu-card');
        let visibleCount = 0;

        items.forEach(it=>{
          const name = (it.dataset.name||'').toLowerCase();
          const tags = (it.dataset.tags||'').toLowerCase();
          const match = !q || name.includes(q) || tags.includes(q);
          it.style.display = (catOk && match) ? '' : 'none';
          if(catOk && match) visibleCount++;
        });

        col.style.display = visibleCount ? '' : 'none';
      });
    }

    search?.addEventListener('input', filter);
  })();
  </script>
</body>
</html>
