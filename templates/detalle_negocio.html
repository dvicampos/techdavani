<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Meta tags seguros -->
    <meta name="description" content="{{ page.get('description', '')[:160] }}">
    <meta name="keywords" content="{{ page.get('category', '') }}">
    <meta name="author" content="{{ page.get('business_name', '') }}">

    <!-- Meta Open Graph -->
    <meta property="og:title" content="{{ page.get('business_name', '') }}">
    <meta property="og:description" content="{{ page.get('slogan') or page.get('description', '')[:200] }}">
    <meta property="og:image" content="{{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True) }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">

    <!-- Meta Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ page.get('business_name', '') }}">
    <meta name="twitter:description" content="{{ page.get('slogan') or page.get('description', '')[:200] }}">
    <meta name="twitter:image" content="{{ url_for('static', filename=page.get('image') or 'images/default.png', _external=True) }}">

    <title>{{ page['business_name'] }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="icon" href="{{ url_for('static', filename='images/logo.jpg') }}" type="image/png">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8911862194691129" crossorigin="anonymous"></script>
    <meta name="google-adsense-account" content="ca-pub-8911862194691129">
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background-color: {
                    {
                    page['color'] or '#343a40'
                }
            }

            ;
            color: white;
            padding: 50px 20px;
            text-align: center;
            border-bottom: 4px solid #ddd;
        }

        .header h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header p.lead {
            font-size: 1.3em;
            font-weight: 300;
            margin-bottom: 0;
        }

        .image {
            width: 100%;
            max-height: 450px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .info {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 40px;
        }

        .label {
            font-weight: 600;
            color: #444;
        }

        .info p {
            margin-bottom: 14px;
            font-size: 1.05em;
        }

        .info i {
            margin-right: 8px;

            color: {
                    {
                    page['color'] or '#007bff'
                }
            }

            ;
        }

        .posts-title {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .card-title {
            font-weight: bold;
            font-size: 1.2em;
            color: #212529;
        }

        .btn-outline-primary {
            border-color: {
                    {
                    page['color'] or '#007bff'
                }
            }

            ;

            color: {
                    {
                    page['color'] or '#007bff'
                }
            }

            ;
        }

        .btn-outline-primary:hover {
            background-color: {
                    {
                    page['color'] or '#007bff'
                }
            }

            ;
            color: white;
        }

        .btn-ver-mas-cafe {
            background-color: {
                    {
                    page['color'] or '#9e7d3e'
                }
            }

            ;
            color: white;
            padding: 0.6em 1.2em;
            border: none;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
        }

        .btn-ver-mas-cafe:hover {
            background-color: #333;
            color: white;
        }

        .aviso-banner {
            display: inline-block;
            margin: 0 auto;
            padding: 0.6rem 1.2rem;
            background: #fff3cd;
            color: #856404;
            border-radius: 50px;
            border: 1px solid #ffeeba;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .noticias-section {
            background: {
                    {
                    page['color'] or '#9e7d3e'
                }
            }

            ;
            padding: 0.75rem 0;
        }

        footer {
            margin-bottom: 5%;
        }

        @media (max-width: 768px) {
            footer {
                margin-bottom: 10%;
            }
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            border-radius: 50%;
            padding: 10px;
        }

        .carousel-control-prev,
        .carousel-control-next {
            width: 5%;
        }

        .info-card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
        }

        .info-card-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .card-body p {
            font-size: 1.05rem;
            margin-bottom: 0.8rem;
        }

        .card-body i {
            min-width: 20px;
        }

        .contact-card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
        }

        .contact-card-hover:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .card-body p {
            font-size: 1.05rem;
            margin-bottom: 0.8rem;
        }

        .card-body i {
            min-width: 20px;
        }

        .card-body a {
            text-decoration: underline;
            color: inherit;
        }

        .card-body a:hover {
            color: #ffffff;
            background-color: #030137;
        }
        :root{
    --brand: {{ "'" ~ (page['color'] if page['color'] else '#343a40') ~ "'" }};
  }
  body{font-family:"Segoe UI",sans-serif;background:#f5f5f5;}
  .header{background: linear-gradient(to right, var(--brand), #000); color:#fff; padding:50px 20px; border-bottom:4px solid #ddd;}
  .btn-outline-primary{border-color:var(--brand); color:var(--brand);}
  .btn-outline-primary:hover{background:var(--brand); color:#fff;}
  .noticias-section{background: var(--brand);}
  .aviso-banner{background:#030137;color:#fff;border:1px solid #fff;}
  /* Mapa */
  #map{height:320px;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);}
    </style>
</head>

<body data-bs-spy="scroll" data-bs-target="#mainNavbar" data-bs-offset="80" tabindex="0">
    <nav id="mainNavbar" class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm"
        style="background: linear-gradient(to right, {{ page['color'] or '#343a40' }}, #000);">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">{{ page['business_name'] }}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="#info">Información</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#contacto">Contacto</a>
                    </li>
                    {% if posts %}
                    <li class="nav-item">
                        <a class="nav-link" href="#publicaciones">Publicaciones</a>
                    </li>
                    {% endif %}
                    {% if productos %}
                    <li class="nav-item">
                        <a class="nav-link" href="#productos">Productos</a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="#reseñas">Reseñas</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <style>
        .aviso-banner {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin: 0 auto;
            padding: 0.5rem 1rem;
            background: #030137;
            color: #ffffff;
            border-radius: 50px;
            border: 1px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
            white-space: normal;
            max-width: 100%;
            text-align: center;
            word-break: break-word;
        }

        .noticias-section {
            background: #9e3e3e;
            padding: 0.75rem 0;
        }

        @media (max-width: 768px) {
            .aviso-banner {
                font-size: 0.85rem;
                padding: 0.4rem 0.75rem;
            }

            footer {
                margin-bottom: 12%;
            }
        }

        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            border-radius: 50%;
            padding: 10px;
        }

        .carousel-control-prev,
        .carousel-control-next {
            width: 5%;
        }

        .modal-70 .modal-dialog {
            max-width: 70vw;
        }
    </style>

    <div class="noticias-section fixed-bottom w-100 shadow-sm"
        style="background: linear-gradient(to right, {{ page['color'] or '#343a40' }}, #000); z-index: 1030;">
        <div class="container-fluid">
            <div id="noticiasCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner text-center">
                    {% if avisos %}
                    {% for aviso in avisos %}
                    <div class="carousel-item {% if loop.first %}active{% endif %}">
                        <div class="aviso-banner mx-auto">
                            <strong><i class="bi bi-megaphone-fill me-2"></i>{{ aviso.title }}:</strong>&nbsp;
                            {{ aviso.content }} | {{ aviso.date.strftime("%d de %B de %Y") }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="carousel-item active">
                        <div class="aviso-banner mx-auto">
                            <strong><i class="bi bi-megaphone-fill me-2"></i>Bienvenidos:</strong>&nbsp;
                            ¡Gracias por visitarnos!
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Controles del carrusel -->
                <button class="carousel-control-prev" type="button" data-bs-target="#noticiasCarousel"
                    data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#noticiasCarousel"
                    data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Siguiente</span>
                </button>
            </div>
        </div>
    </div>



    <div class="header text-white text-center position-relative"
        style="background: linear-gradient(to right, {{ page['color'] or '#343a40' }}, #000); padding: 60px 20px;">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    {% if page['image'] %}
                        <img src="{{ url_for('uploaded_file', filename=page['image']) }}" class="img-fluid rounded-circle shadow border border-3 border-white" style="max-width: 250px; height: 250px; object-fit: cover;">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default_image.png') }}"
                            class="img-fluid rounded-circle shadow border border-3 border-white"
                            style="max-width: 250px; height: 250px; object-fit: cover;">
                    {% endif %}
                </div>
                <div class="col-md-8 text-md-start text-center">
                    <h1 class="display-5 fw-bold">{{ page['business_name'] }}</h1>
                    {% if page['slogan'] %}
                    <p class="lead fst-italic mt-2">{{ page['slogan'] }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sección: Información -->
    <section class="container my-5" id="info">
        <h2 class="mb-4 border-bottom pb-2">📝 Información General</h2>
        <div class="row g-4">

            <!-- Tarjeta izquierda -->
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100 info-card-hover">
                    <div class="card-body">
                        <p><i class="fas fa-align-left me-2 text-primary"></i><strong>¿Quiénes somos?</strong> {{
                            page.description }}</p>
                        <p><i class="fas fa-tag me-2 text-primary"></i><strong>Categoría:</strong> {{ page.category }}
                        </p>
                        <p><i class="fas fa-calendar-alt me-2 text-primary"></i><strong>Fundación:</strong> {{
                            page.founding_date }}</p>
                        <p><i class="fas fa-concierge-bell me-2 text-primary"></i><strong>Servicios:</strong> {{
                            page.services }}</p>
                        <p><i class="fas fa-credit-card me-2 text-primary"></i><strong>Métodos de pago:</strong> {{
                            page.payment_methods }}</p>
                        {% if page.delivery_available %}
                        <p><i class="fas fa-truck me-2 text-primary"></i><strong>Envío a domicilio:</strong> Sí</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Tarjeta derecha -->
            <div class="col-md-6">
                <div class="card shadow-sm border-0 h-100 info-card-hover">
                    <div class="card-body">
                        <p><i class="fas fa-map-marker-alt me-2 text-primary"></i><strong>Dirección:</strong> {{
                            page.address }}</p>
                        <p><i class="fas fa-mail-bulk me-2 text-primary"></i><strong>Código Postal:</strong> {{
                            page.postal_code }}</p>
                        <p><i class="fas fa-city me-2 text-primary"></i><strong>Ciudad:</strong> {{ page.city }}</p>
                        <p><i class="fas fa-flag me-2 text-primary"></i><strong>Estado:</strong> {{ page.state }}</p>
                        <p><i class="far fa-clock me-2 text-primary"></i><strong>Horario:</strong> {{
                            page.operating_hours }}</p>
                        {% set has_coords = page.get('lat') is not none and page.get('lng') is not none %}
                        <div class="mt-3">
                        <p class="mb-2"><i class="fas fa-location-dot me-2 text-primary"></i>
                            <strong>Ubicación en mapa:</strong>
                        </p>

                        {% if has_coords %}
                            <div id="map" class="mb-3"></div>
                            <div class="d-flex gap-2 flex-wrap">
                            <a class="btn btn-outline-primary btn-sm"
                                target="_blank"
                                href="https://www.google.com/maps/dir/?api=1&destination={{ page.lat }},{{ page.lng }}">
                                Cómo llegar (Google)
                            </a>
                            </div>
                        {% else %}
                            <div class="alert alert-warning mb-2">
                            Aún no hay coordenadas guardadas para este negocio.
                            </div>
                            <div class="d-flex gap-2 flex-wrap">
                            {% if page.address %}
                                <a class="btn btn-outline-primary btn-sm"
                                target="_blank"
                                href="https://www.google.com/maps/search/?api=1&query={{ page.address | urlencode }}">
                                Buscar dirección en Google Maps
                                </a>
                                <a class="btn btn-outline-primary btn-sm"
                                target="_blank"
                                href="https://www.openstreetmap.org/search?query={{ page.address | urlencode }}">
                                Buscar en OpenStreetMap
                                </a>
                            {% endif %}
                            </div>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <!-- Sección: Contacto -->
    <section class="container my-5" id="contacto">
        <h2 class="mb-4 border-bottom pb-2">📞 Contacto</h2>
        <div class="row row-cols-1 row-cols-md-2 g-4">

            <div class="col">
                <div class="card shadow-sm border-0 contact-card-hover">
                    <div class="card-body">
                        <p><i class="fas fa-phone me-2 text-success"></i><strong>Teléfono:</strong> {{ page.phone }}</p>
                        <p><i class="fas fa-envelope me-2 text-danger"></i><strong>Email:</strong> {{ page.email }}</p>
                        <p><i class="fas fa-globe me-2 text-primary"></i><strong>Web:</strong>
                            <a href="{{ page.website }}" target="_blank">{{ page.website }}</a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card shadow-sm border-0 contact-card-hover">
                    <div class="card-body">
                        {% if page.facebook %}
                        <p><i class="fab fa-facebook me-2 text-primary"></i><strong>Facebook:</strong>
                            <a href="{{ page.facebook }}" target="_blank">Ir a Facebook</a>
                        </p>
                        {% endif %}
                        {% if page.instagram %}
                        <p><i class="fab fa-instagram me-2 text-danger"></i><strong>Instagram:</strong>
                            <a href="{{ page.instagram }}" target="_blank">Ir a Instagram</a>
                        </p>
                        {% endif %}
                        {% if page.tiktok %}
                        <p><i class="fab fa-tiktok me-2 text-dark"></i><strong>TikTok:</strong>
                            <a href="{{ page.tiktok }}" target="_blank">Ir a TikTok</a>
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div>
    </section>


    <!-- Sección: Publicaciones -->
    <section class="container my-5" id="publicaciones">
        <h2 class="mb-4 border-bottom pb-2">📰 Publicaciones Recientes</h2>

        {% if posts and posts|length > 0 %}
        <div class="row">
            {% for post in posts %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    {% if post.cabecera %}
                        <img src="{{ url_for('uploaded_file', filename=post.cabecera) }}" class="card-img-top" alt="Imagen del post">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ post.title }}</h5>
                        <p class="card-text">{{ post.content[:100] }}...</p>
                        <a href="{{ url_for('ver_post', post_id=post._id) }}"
                            class="btn btn-outline-primary mt-auto">Leer más</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if posts|length > 2 %}
        <div class="text-center mt-4">
            <a href="{{ url_for('lista_blogs_negocio', nombre=page['business_name'], page=1) }}"
                class="btn btn-primary">Ver más publicaciones</a>
        </div>
        {% endif %}

        {% else %}
        <div class="alert alert-warning p-3 rounded shadow-sm mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4 text-warning"></i>
            <div>
                <h6 class="mb-1 fw-bold small">No hay publicaciones disponibles</h6>
                <p class="mb-0 small">
                    Este negocio aún no ha realizado publicaciones. ¡Vuelve pronto para conocer sus novedades!
                </p>
            </div>
        </div>
        {% endif %}
    </section>


    <section class="container my-5" data-aos="fade-up" id="productos">

    <h2 class="mb-4 border-bottom pb-2">🛒 Productos y Servicios</h2>

    {% if (productos_fisicos and productos_fisicos|length > 0) or (servicios and servicios|length > 0) %}

    <!-- Aviso de ayuda -->
    <div class="alert alert-info d-flex align-items-center p-3 rounded shadow-sm mb-4" role="alert">
        <i class="bi bi-info-circle-fill me-3 fs-4 text-primary"></i>
        <div>
            <h6 class="mb-1 fw-bold">Cotiza fácilmente</h6>
            <p class="mb-0 small">
                Ingresa la cantidad que te interesa de cada elemento (producto físico o servicio),
                luego toca <strong>"Cotizar"</strong>.
                Te pediremos tu nombre y te abriremos WhatsApp con todo listo 😌.
            </p>
        </div>
    </div>

    <!-- FORM que agrupa TODO -->
    <form id="form-cotizar" class="row g-4">

        <!-- ================== SERVICIOS ================== -->
        {% if servicios and servicios|length > 0 %}
        <div class="col-12">
            <h3 class="h5 fw-bold text-uppercase text-muted d-flex align-items-center">
                <i class="bi bi-wrench-adjustable-circle me-2 text-primary"></i> Servicios
            </h3>
        </div>

        {% for item in servicios %}
        <div class="col-12 col-sm-6 col-md-4">
            <div class="card h-100 shadow-sm">
                {% if item.image %}
                    <img src="{{ url_for('uploaded_file', filename=item.image) }}"
                         alt="{{ item.title }}"
                         class="card-img-top img-zoom-trigger"
                         style="object-fit: cover; width: 100%; height: 250px; cursor: pointer;"
                         data-bs-toggle="modal"
                         data-bs-target="#zoomModal"
                         data-img-src="{{ url_for('uploaded_file', filename=item.image) }}">
                {% else %}
                    <img src="{{ url_for('static', filename='img/default-product.png') }}"
                         alt="Imagen no disponible"
                         class="card-img-top img-zoom-trigger"
                         style="object-fit: cover; width: 100%; height: 250px; cursor: pointer;"
                         data-bs-toggle="modal"
                         data-bs-target="#zoomModal"
                         data-img-src="{{ url_for('static', filename='img/default-product.png') }}">
                {% endif %}

                <div class="card-body d-flex flex-column py-2 px-3">
                    <span class="badge bg-dark align-self-start mb-2" style="font-size: .7rem;">
                        Servicio
                    </span>

                    <h6 class="card-title mb-1 small fw-semibold">{{ item.title }}</h6>

                    {% if item.description %}
                    <p class="card-text text-muted small mb-2">{{ item.description }}</p>
                    {% endif %}

                    {% if item.show_price %}
                    <div class="mb-2">
                        <span class="badge bg-success text-white fw-semibold" style="font-size: 0.9rem;">
                            Precio: ${{ "%.2f"|format(item.price) }}
                        </span>
                    </div>
                    {% endif %}

                    <div class="mt-auto">
                        <label for="prod_{{ loop.index0 }}_serv" class="form-label small mb-1">Cantidad / Nº de citas:</label>
                        <input type="number"
                               class="form-control form-control-sm"
                               id="prod_{{ loop.index0 }}_serv"
                               name="prod_{{ item.title | replace(' ', '_') }}"
                               min="0"
                               value="0"
                               placeholder="0"
                               aria-label="Cantidad para {{ item.title }}"
                               data-item-nombre="{{ item.title }}">
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- ================== PRODUCTOS FÍSICOS ================== -->
        {% if productos_fisicos and productos_fisicos|length > 0 %}
        <div class="col-12 mt-4">
            <h3 class="h5 fw-bold text-uppercase text-muted d-flex align-items-center">
                <i class="bi bi-box-seam me-2 text-success"></i> Productos
            </h3>
        </div>

        {% for item in productos_fisicos %}
        <div class="col-12 col-sm-6 col-md-4">
            <div class="card h-100 shadow-sm">
                {% if item.image %}
                    <img src="{{ url_for('uploaded_file', filename=item.image) }}"
                         alt="{{ item.title }}"
                         class="card-img-top img-zoom-trigger"
                         style="object-fit: cover; width: 100%; height: 250px; cursor: pointer;"
                         data-bs-toggle="modal"
                         data-bs-target="#zoomModal"
                         data-img-src="{{ url_for('uploaded_file', filename=item.image) }}">
                {% else %}
                    <img src="{{ url_for('static', filename='img/default-product.png') }}"
                         alt="Imagen no disponible"
                         class="card-img-top img-zoom-trigger"
                         style="object-fit: cover; width: 100%; height: 250px; cursor: pointer;"
                         data-bs-toggle="modal"
                         data-bs-target="#zoomModal"
                         data-img-src="{{ url_for('static', filename='img/default-product.png') }}">
                {% endif %}

                <div class="card-body d-flex flex-column py-2 px-3">
                    <span class="badge bg-secondary align-self-start mb-2" style="font-size: .7rem;">
                        Producto
                    </span>

                    <h6 class="card-title mb-1 small fw-semibold">{{ item.title }}</h6>

                    {% if item.description %}
                    <p class="card-text text-muted small mb-2">{{ item.description }}</p>
                    {% endif %}

                    {% if item.show_price %}
                    <div class="mb-2">
                        <span class="badge bg-success text-white fw-semibold" style="font-size: 0.9rem;">
                            Precio: ${{ "%.2f"|format(item.price) }}
                        </span>
                    </div>
                    {% endif %}

                    <div class="mt-auto">
                        <label for="prod_{{ loop.index0 }}_prod" class="form-label small mb-1">Cantidad:</label>
                        <input type="number"
                               class="form-control form-control-sm"
                               id="prod_{{ loop.index0 }}_prod"
                               name="prod_{{ item.title | replace(' ', '_') }}"
                               min="0"
                               value="0"
                               placeholder="0"
                               aria-label="Cantidad para {{ item.title }}"
                               data-item-nombre="{{ item.title }}">
                    </div>
                </div>

            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- BOTÓN COTIZAR -->
        <div class="col-12 text-center mt-4">
            <button type="submit"
                    class="btn btn-success btn-lg px-4 py-2"
                    id="btnAbrirModalCotizar">
                <i class="bi bi-whatsapp fs-5 me-2"></i>
                Cotizar
            </button>
        </div>

    </form>

    {% else %}
        <div class="alert alert-warning p-3 rounded shadow-sm mt-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-3 fs-4 text-warning"></i>
            <div>
                <h6 class="mb-1 fw-bold small">No hay productos ni servicios disponibles</h6>
                <p class="mb-0 small">
                    Por ahora no tenemos elementos para cotizar. Contáctanos directamente desde la sección de contacto. 🙌
                </p>
            </div>
        </div>
    {% endif %}

    <!-- Modal Zoom Imagen (igual que antes) -->
    <div class="modal fade" id="zoomModal" tabindex="-1" aria-labelledby="zoomModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-70">
            <div class="modal-content bg-transparent border-0">
                <div class="modal-body p-0">
                    <img src="" alt="Imagen ampliada" id="zoomedImage" class="img-fluid rounded shadow"
                        style="width: 100%;">
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal de cotización: pedir nombre -->
    <div class="modal fade" id="cotizarModal" tabindex="-1" aria-labelledby="cotizarModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow">
                <div class="modal-header" style="background: linear-gradient(to right, {{ page['color'] or '#343a40' }}, #000); color: #fff;">
                    <h5 class="modal-title" id="cotizarModalLabel">Antes de cotizar ✍️</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">
                        Déjanos tu nombre para que sepamos cómo dirigirnos a ti cuando te respondamos por WhatsApp.
                    </p>

                    <div class="mb-3">
                        <label for="nombreClienteInput" class="form-label">Tu nombre</label>
                        <input type="text" class="form-control" id="nombreClienteInput" placeholder="Ej. Carlos / Ana Martínez">
                    </div>

                    <div id="resumenSeleccion" class="bg-light border rounded p-2 small" style="max-height: 200px; overflow-y: auto;">
                        <!-- aquí metemos un preview de lo que seleccionó -->
                    </div>

                    <div class="text-danger small mt-2 d-none" id="errorModalNombre">
                        Por favor escribe tu nombre 🙏
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="enviarCotizacionBtn">
                        <i class="bi bi-whatsapp me-1"></i> Enviar por WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

</section>


    <!-- Etiqueta flotante de WhatsApp -->
    <div style="position: fixed; bottom: 12%; left: 20px; z-index: 1050;">
        <a href="https://wa.me/{{ page.whatsapp | replace(' ', '') }}" target="_blank"
            class="d-flex align-items-center bg-success text-white px-3 py-2 rounded-pill shadow text-decoration-none"
            style="font-weight: 500;">
            <i class="bi bi-whatsapp fs-5"></i>
        </a>
    </div>

    <div class="container card shadow-sm border-0 mb-5" id="reseñas">
        <div class="card-body">
            <h3 class="mt-2">⭐ Deja tu reseña</h3>
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="alert alert-info mt-2">
                {% for message in messages %}
                <p>{{ message }}</p>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            <form method="POST" class="mb-4">
                <div class="mb-3">
                    <label for="nombre" class="form-label">Tu nombre</label>
                    <input type="text" name="nombre" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="comentario" class="form-label">Comentario</label>
                    <textarea name="comentario" class="form-control" rows="3" required></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Calificación</label>
                    <div id="starRating" class="mb-2">
                        {% for i in range(1, 6) %}
                        <i class="bi bi-star-fill star-icon fs-3 me-1 text-secondary" data-value="{{ i }}"></i>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="estrellas" id="estrellas" value="0" required>
                </div>

                <button type="submit" class="btn btn-primary">Enviar reseña</button>
            </form>
        </div>
    </div>

    <div class="container">
        <h4 class="mt-5 mb-4 text-center">⭐ Reseñas de nuestros clientes</h4>

        {% if reseñas %}
        <div class="row row-cols-1 row-cols-md-2 g-4">
            {% for r in reseñas %}
            <div class="col">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title text-center mb-2">{{ r.nombre }}</h5>
                        <div class="text-center mb-3">
                            {% for i in range(1, 6) %}
                            {% if i <= r.estrellas %} <i class="bi bi-star-fill text-warning fs-5"></i>
                                {% else %}
                                <i class="bi bi-star text-secondary fs-5"></i>
                                {% endif %}
                                {% endfor %}
                        </div>
                        <p class="card-text">{{ r.comentario }}</p>
                    </div>
                    <div class="card-footer text-end bg-transparent border-0">
                        <small class="text-muted">{{ r.fecha.strftime('%d/%m/%Y') }}</small>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center">No hay reseñas aún. Sé el primero en dejar una ⭐</p>
        {% endif %}

    </div>

    <footer class="bg-dark text-white mt-5 pt-4 pb-3"
        style="background: linear-gradient(to right, {{ page['color'] or '#343a40' }}, #000);">
        <div class="container d-flex flex-column flex-md-row justify-content-between align-items-center">
            <div class="mb-3 mb-md-0 text-center text-md-start">
                <p class="mb-0">&copy; 2025 <strong>DavaniTechnology</strong>. Todos los derechos reservados.</p>
                <small class="text-white">Sitio creado con el software <a href="https://davanitechnology.com/"
                        target="_blank"
                        class="text-info fw-semibold text-decoration-underline">DavaniTechnology</a></small>
            </div>
            <div class="text-center text-md-end">
                <a href="{{ page.facebook }}" target="_blank" class="text-white me-3 fs-4" aria-label="Facebook">
                    <i class="bi bi-facebook"></i>
                </a>
                <a href="{{ page.tiktok }}" target="_blank" class="text-white fs-4" aria-label="TikTok">
                    <i class="bi bi-tiktok"></i>
                </a>
            </div>
        </div>
    </footer>

    <script>
    // ---- Zoom de imagen (igual que ya tenías) ----
    document.querySelectorAll('.img-zoom-trigger').forEach(img => {
        img.addEventListener('click', event => {
            const src = event.currentTarget.getAttribute('data-img-src');
            const zoomedImage = document.getElementById('zoomedImage');
            zoomedImage.src = src;
        });
    });

    // === Cotización con modal ===
    const formCotizar = document.getElementById('form-cotizar');
    const resumenSeleccionDiv = document.getElementById('resumenSeleccion');
    const nombreClienteInput = document.getElementById('nombreClienteInput');
    const errorModalNombre = document.getElementById('errorModalNombre');

    // guardaremos temporalmente la selección del usuario aquí
    let cotizacionLineas = [];

    if (formCotizar) {
        formCotizar.addEventListener('submit', function (e) {
            e.preventDefault();

            cotizacionLineas = [];
            let inputs = formCotizar.querySelectorAll('input[type=number]');
            inputs.forEach(input => {
                const cantidad = parseInt(input.value);
                if (cantidad > 0) {
                    const nombreItem = input.getAttribute('data-item-nombre') ||
                                       input.name.replace('prod_', '').replace(/_/g, ' ');
                    cotizacionLineas.push(`- ${nombreItem}: ${cantidad}`);
                }
            });

            if (cotizacionLineas.length === 0) {
                alert("Por favor ingresa cantidad para al menos un servicio o producto 🙏");
                return;
            }

            // Previsualizar lo que seleccionó el usuario en el modal:
            resumenSeleccionDiv.innerHTML = cotizacionLineas
                .map(l => `<div>${l}</div>`)
                .join('');

            // limpiar errores previos
            errorModalNombre.classList.add('d-none');
            nombreClienteInput.classList.remove('is-invalid');

            // Abrir modal Bootstrap
            const cotizarModal = new bootstrap.Modal(document.getElementById('cotizarModal'));
            cotizarModal.show();
        });
    }

    // Cuando el usuario confirma enviar al WhatsApp
    const enviarCotizacionBtn = document.getElementById('enviarCotizacionBtn');
    if (enviarCotizacionBtn) {
        enviarCotizacionBtn.addEventListener('click', () => {
            const nombreCliente = (nombreClienteInput.value || '').trim();

            if (!nombreCliente) {
                errorModalNombre.classList.remove('d-none');
                nombreClienteInput.classList.add('is-invalid');
                nombreClienteInput.focus();
                return;
            }

            const whatsappNumber = "{{ page.whatsapp | replace(' ', '') }}";

            // Armamos el mensaje final
            // %0A = salto de línea URL-encoded
            let mensaje = `Hola, soy ${nombreCliente} y quiero cotizar:%0A`;
            cotizacionLineas.forEach(linea => {
                mensaje += encodeURIComponent(linea) + "%0A";
            });

            const urlWhatsapp = `https://wa.me/${whatsappNumber}?text=${mensaje}`;
            window.open(urlWhatsapp, '_blank');
        });
    }

    // === Estrellas reseña (igual que ya tenías) ===
    const stars = document.querySelectorAll('.star-icon');
    const inputEstrellas = document.getElementById('estrellas');

    stars.forEach(star => {
        star.addEventListener('click', () => {
            const valor = parseInt(star.getAttribute('data-value'));
            inputEstrellas.value = valor;

            stars.forEach(s => {
                const sVal = parseInt(s.getAttribute('data-value'));
                s.classList.remove('text-warning', 'text-secondary');
                s.classList.add(sVal <= valor ? 'text-warning' : 'text-secondary');
            });
        });
    });
    const cotizarModal = new bootstrap.Modal(document.getElementById('cotizarModal'));
cotizarModal.show();
setTimeout(() => { nombreClienteInput.focus(); }, 300);

</script>

    <!-- Leaflet (gratis, sin API key) -->
    <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
    />
    <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    ></script>

    <script>
    (function(){
        const lat = {{ page.get('lat') if page.get('lat') is not none else 'null' }};
        const lng = {{ page.get('lng') if page.get('lng') is not none else 'null' }};
        if (lat !== null && lng !== null) {
        const map = L.map('map', { scrollWheelZoom: false }).setView([lat, lng], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>'
        }).addTo(map);

        const marker = L.marker([lat, lng]).addTo(map);
        marker.bindPopup(`<strong>{{ page['business_name']|e }}</strong><br>{{ (page['address'] or '')|e }}`).openPopup();

        // Ajuste si el contenedor cambia de tamaño (por ejemplo al abrir pestañas, etc.)
        setTimeout(() => { map.invalidateSize(); }, 300);
        }
    })();
    </script>



    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>